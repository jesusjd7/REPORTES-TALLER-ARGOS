<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REPORTE por Taller con Supabase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('FONDO.png');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            background-color: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }
        @media (min-width: 640px) { body { padding: 1.5rem; } }
        @media (min-width: 768px) { body { padding: 2rem; } }
        .container {
            max-width: 900px;
            background-color: rgba(255, 255, 255, 0.9);
            width: 100%;
        }
        .container.transparent-bg {
            background-color: transparent;
            box-shadow: none;
            border: none;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        body.align-top-content { align-items: flex-start; }
        body.align-top-content .container { margin-top: 2rem; margin-bottom: auto; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #65A30D;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            display: none; /* Oculto por defecto */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        customGreen: '#65A30D',
                        customBlue: '#1E3A8A',
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="loader" class="loader"></div>

    <div id="loginView" class="flex flex-col items-center justify-center p-8 w-full">
        <div class="border border-black rounded-lg p-6 shadow-xl bg-white max-w-sm w-full mx-auto">
            <img id="loginTruckImage" src="CAMION.png" alt="Camión Argos" class="w-48 h-auto mx-auto mb-6 rounded-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Iniciar Sesión</h2>
            <div class="w-full">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label>
                    <input type="email" id="email" name="email" required value="jospinob@argos.com.co"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                    <input type="password" id="password" name="password" required value="argos2015"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <button id="loginBtn"
                        class="w-full px-6 py-3 bg-customGreen text-customBlue font-semibold rounded-md shadow-md hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-customGreen focus:ring-offset-2 transition ease-in-out duration-150">
                    INGRESAR
                </button>
                <p id="loginError" class="text-red-600 text-center mt-4" style="display: none;"></p>
            </div>
        </div>
    </div>

    <div id="appContainer" class="container mx-auto bg-white p-6 rounded-lg shadow-lg" style="display: none;">
        <div class="relative flex items-center justify-center mb-8">
            <div id="leftHeaderElements" class="absolute left-0 flex items-center space-x-2" style="display: none;">
                <button id="backToMenuBtn" class="px-4 py-2 bg-customGreen text-customBlue font-semibold rounded-md shadow-md hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-customGreen focus:ring-offset-2 transition ease-in-out duration-150">
                    ATRAS
                </button>
            </div>
            <h1 id="mainPageTitle" class="text-3xl font-bold text-gray-800 text-center bg-white bg-opacity-70 rounded-md px-4 py-2"></h1>
            <div id="rightHeaderElements" class="absolute right-0 flex items-center space-x-2" style="display: none;">
                <button id="logoutBtn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-md shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition ease-in-out duration-150">
                    Cerrar Sesión
                </button>
            </div>
        </div>
        <h2 id="reportSubtitle" class="text-xl font-semibold text-center text-gray-600 mb-8" style="display: none;">REPORTE</h2>

        <div id="workshopSelectionView" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-8" style="display: none;">
            </div>

        <div id="formView" style="display: none;">
             <form id="dataForm" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <input type="hidden" id="editingRecordId" />
                <div>
                    <label for="equipo" class="block text-sm font-medium text-gray-700 mb-1">EQUIPO *</label>
                    <select id="equipo" name="equipo" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="">Seleccione un Equipo</option>
                    </select>
                </div>
                <div>
                    <label for="fecha" class="block text-sm font-medium text-gray-700 mb-1">FECHA *</label>
                    <input type="date" id="fecha" name="fecha" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="otOrigen" class="block text-sm font-medium text-gray-700 mb-1">OT ORIGEN *</label>
                    <input type="number" id="otOrigen" name="otOrigen" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="0">
                </div>
                <div>
                    <label for="conjunto" class="block text-sm font-medium text-gray-700 mb-1">CONJUNTO *</label>
                    <select id="conjunto" name="conjunto" required disabled class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="">Seleccione un Conjunto</option>
                    </select>
                </div>
                <div>
                    <label for="parte" class="block text-sm font-medium text-gray-700 mb-1">PARTE *</label>
                    <select id="parte" name="parte" required disabled class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="">Seleccione una Parte</option>
                    </select>
                </div>
                <div>
                    <label for="prioridad" class="block text-sm font-medium text-gray-700 mb-1">PRIORIDAD *</label>
                    <select id="prioridad" name="prioridad" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="">Seleccione una Prioridad</option>
                        <option value="Alta">Alta</option>
                        <option value="Media">Media</option>
                        <option value="Baja">Baja</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label for="textoEstandar" class="block text-sm font-medium text-gray-700 mb-1">TEXTO ESTANDAR *</label>
                    <select id="textoEstandar" name="textoEstandar" required disabled class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="">Seleccione un Texto Estandar</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label for="descripcionDetallada" class="block text-sm font-medium text-gray-700 mb-1">DESCRIPCION DETALLADA *</label>
                    <textarea id="descripcionDetallada" name="descripcionDetallada" rows="3" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                </div>
                <div>
                    <label for="tecnico" class="block text-sm font-medium text-gray-700 mb-1">TECNICO *</label>
                    <input type="text" id="tecnico" name="tecnico" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="telefono" class="block text-sm font-medium text-gray-700 mb-1">TELEFONO *</label>
                    <input type="text" id="telefono" name="telefono" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="foto" class="block text-sm font-medium text-gray-700 mb-1">FOTO</label>
                    <input type="file" id="foto" name="foto" class="hidden" accept="image/*">
                    <label for="foto" class="inline-flex items-center px-6 py-3 bg-customGreen text-customBlue font-semibold rounded-md shadow-md hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-customGreen focus:ring-offset-2 transition ease-in-out duration-150 cursor-pointer">
                        Añadir Foto
                    </label>
                    <span id="foto-name" class="ml-3 text-sm text-gray-600"></span>
                </div>
                <div class="md:col-span-2 flex justify-center space-x-4">
                    <button type="submit" id="saveRecordBtn" class="px-6 py-3 bg-customGreen text-customBlue font-semibold rounded-md shadow-md hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-customGreen focus:ring-offset-2 transition ease-in-out duration-150">
                        Guardar Registro
                    </button>
                    <button type="button" id="cancelEditBtn" style="display:none;" class="px-6 py-3 bg-gray-300 text-gray-800 font-semibold rounded-md shadow-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition ease-in-out duration-150">
                        Cancelar Edición
                    </button>
                </div>
            </form>

            <hr class="my-8 border-gray-300">

            <h3 class="text-2xl font-bold text-center text-gray-800 mb-6">Datos de REPORTE</h3>
            <div class="flex justify-center mb-6">
                <button id="downloadExcel" class="px-6 py-3 bg-customGreen text-customBlue font-semibold rounded-md shadow-md hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-customGreen focus:ring-offset-2 transition ease-in-out duration-150">
                    Descargar Excel
                </button>
            </div>
            <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200 w-full">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Equipo</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">OT Origen</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conjunto</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parte</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Texto Estandar</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prioridad</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Técnico</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teléfono</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Foto</th>
                            <th scope="col" class="relative px-6 py-3"><span class="sr-only">Acciones</span></th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="12" class="px-6 py-4 text-center text-sm text-gray-500">Cargando datos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import * as XLSX from "https://cdn.sheetjs.com/xlsx-0.20.2/package/xlsx.mjs";
        window.XLSX = XLSX;

        // --- SUPABASE CLIENT SETUP ---
        const SUPABASE_URL = 'https://txpezttlhtxjkwtfehme.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4cGV6dHRsaHR4amt3dGZlaG1lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwNzA1MDcsImV4cCI6MjA2OTY0NjUwN30.74iEuQQfSvlu36lbfd78e8aM6vFcZUkA7ab0oWT9yGI';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let currentWorkshop = '';

        // --- DOM Elements ---
        const loader = document.getElementById('loader');
        const appContainer = document.getElementById('appContainer');
        const mainPageTitle = document.getElementById('mainPageTitle');
        const reportSubtitle = document.getElementById('reportSubtitle');
        const loginView = document.getElementById('loginView');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logoutBtn');
        const leftHeaderElements = document.getElementById('leftHeaderElements');
        const rightHeaderElements = document.getElementById('rightHeaderElements');
        const dataForm = document.getElementById('dataForm');
        const equipoSelect = document.getElementById('equipo');
        const conjuntoSelect = document.getElementById('conjunto');
        const parteSelect = document.getElementById('parte');
        const textoEstandarSelect = document.getElementById('textoEstandar');
        const dataTableBody = document.getElementById('dataTableBody');
        const downloadExcelBtn = document.getElementById('downloadExcel');
        const workshopSelectionView = document.getElementById('workshopSelectionView');
        const formView = document.getElementById('formView');
        const backToMenuBtn = document.getElementById('backToMenuBtn');
        const saveRecordBtn = document.getElementById('saveRecordBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const editingRecordIdInput = document.getElementById('editingRecordId');
        const fotoNameSpan = document.getElementById('foto-name');
        const fotoInput = document.getElementById('foto');

        // --- Data for Workshops and Dependent Dropdowns (Same as original) ---
        const allWorkshops = ["KAEL", "ABFREN", "SOMEC", "ARGOS", "DRACSO", "JS OUT", "MG", "SIMIYP", "SERVII"];
        const workshopDisplayNames = {
            "KAEL": "KAEL", "ABFREN": "ABFREN", "SOMEC": "SOMEC", "ARGOS": "ARGOS",
            "DRACSO": "DRACSO", "JS OUT": "JS OUT", "MG": "MG SOL", "SIMIYP": "SIMIYP", "SERVII": "SERVII"
        };
        const workshopImagePaths = {
            "KAEL": "LOGOKAEL.jpg", "ABFREN": "LOGOABFREN.png", "SOMEC": "LOGOSOMEC.png", "ARGOS": "LOGOARGOS.jpg",
            "DRACSO": "LOGODRACSO.png", "JS OUT": "LOGOJS.png", "MG": "LOGOMG.png", "SIMIYP": "LOGOSIMIYP.png", "SERVII": "LOGOSERVICIO.png"
        };
        const userToWorkshopMap = {
            "jospinob@argos.com.co": "ARGOS",
            "kael@taller.com": "KAEL",
            "abfren@taller.com": "ABFREN",
            "somec@taller.com": "SOMEC"
        };
        // The extensive data maps (parteToTextoEstandarMap, conjuntoToParteMap, allWorkshopsData) remain the same.
        // For brevity, I'm omitting them here, but they should be included in your script block.
        // --- Paste the large data maps from your original file here ---
        const parteToTextoEstandarMap = { /* ... Tu mapa de datos ... */ };
        const conjuntoToParteMap = { /* ... Tu mapa de datos ... */ };
        const allWorkshopsData = { /* ... Tu mapa de datos ... */ };
        const equiposKael = [ /* ... Tu lista de equipos ... */ ];
        equiposKael.forEach(equipo => { /* ... Tu lógica de población de datos ... */ });
        const kaelData = JSON.parse(JSON.stringify(allWorkshopsData["KAEL"]));
        for (const workshopName of allWorkshops) {
            if (workshopName !== "KAEL") {
                allWorkshopsData[workshopName] = JSON.parse(JSON.stringify(kaelData));
            }
        }
        // --- End of data maps ---


        // --- Helper Functions ---
        const showLoader = (show) => { loader.style.display = show ? 'block' : 'none'; };

        function showCustomAlert(message, isError = false) {
            alert(message); // Simple alert for now, can be replaced with a styled modal
            if (isError) console.error(message);
            else console.log(message);
        }

        // --- View Management ---
        function showLoginView() {
            loginView.style.display = 'flex';
            appContainer.style.display = 'none';
            document.body.classList.remove('align-top-content');
            appContainer.classList.remove('transparent-bg');
            document.body.style.backgroundImage = `url('FONDO.png')`;
        }

        function showWorkshopSelectionView() {
            loginView.style.display = 'none';
            appContainer.style.display = 'block';
            workshopSelectionView.style.display = 'grid';
            formView.style.display = 'none';
            mainPageTitle.textContent = 'SELECCIONAR TALLER';
            reportSubtitle.style.display = 'none';
            leftHeaderElements.style.display = 'none';
            rightHeaderElements.style.display = 'flex';
            logoutBtn.style.display = 'block';
            populateWorkshopCards();
            document.body.classList.add('align-top-content');
            appContainer.classList.add('transparent-bg');
        }

        function showFormView() {
            loginView.style.display = 'none';
            appContainer.style.display = 'block';
            workshopSelectionView.style.display = 'none';
            formView.style.display = 'block';
            mainPageTitle.textContent = workshopDisplayNames[currentWorkshop];
            reportSubtitle.style.display = 'block';
            leftHeaderElements.style.display = 'flex';
            rightHeaderElements.style.display = 'flex';
            backToMenuBtn.style.display = 'block';
            // Hide logout button for specific user logic
            const userWorkshop = userToWorkshopMap[currentUser?.email];
            logoutBtn.style.display = userWorkshop === 'ARGOS' ? 'block' : 'none';
            appContainer.classList.remove('transparent-bg');
        }

        // --- Authentication ---
        loginBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            loginError.style.display = 'none';
            showLoader(true);

            const { data, error } = await supabase.auth.signInWithPassword({ email, password });

            showLoader(false);
            if (error) {
                loginError.textContent = 'Credenciales incorrectas. Inténtalo de nuevo.';
                loginError.style.display = 'block';
                console.error('Login failed:', error.message);
                return;
            }

            if (data.user) {
                currentUser = data.user;
                const userWorkshop = userToWorkshopMap[currentUser.email];
                if (userWorkshop === "ARGOS") {
                    showWorkshopSelectionView();
                } else if (userWorkshop) {
                    initApp(userWorkshop);
                } else {
                    showCustomAlert('Usuario no asociado a un taller.', true);
                    await supabase.auth.signOut();
                }
            }
        });

        logoutBtn.addEventListener('click', async () => {
            showLoader(true);
            const { error } = await supabase.auth.signOut();
            showLoader(false);
            if (error) {
                showCustomAlert('Error al cerrar sesión.', true);
            } else {
                currentUser = null;
                currentWorkshop = '';
                showLoginView();
            }
        });

        // --- App Initialization ---
        async function initApp(workshopName) {
            currentWorkshop = workshopName;
            mainPageTitle.textContent = workshopDisplayNames[workshopName];
            reportSubtitle.style.display = 'block';
            populateEquipoDropdown();
            await loadData();
            showFormView();
        }

        // --- UI Population ---
        function populateWorkshopCards() {
            workshopSelectionView.innerHTML = '';
            allWorkshops.forEach(workshop => {
                if (workshop === "ARGOS") return; // Don't show Argos as a selectable card
                const card = document.createElement('div');
                card.className = `bg-gray-50 rounded-lg shadow-md p-2 flex flex-col items-center justify-center cursor-pointer hover:bg-blue-50 hover:shadow-lg transition ease-in-out duration-150 border border-gray-200 w-full sm:w-auto`;
                card.dataset.workshop = workshop;
                card.addEventListener('click', () => initApp(workshop));
                const img = document.createElement('img');
                img.alt = workshopDisplayNames[workshop];
                img.className = 'w-24 h-24 object-contain mb-3 rounded-md';
                img.src = workshopImagePaths[workshop];
                const name = document.createElement('p');
                name.textContent = workshopDisplayNames[workshop];
                name.className = 'text-lg font-semibold text-gray-800 text-center';
                card.appendChild(img);
                card.appendChild(name);
                workshopSelectionView.appendChild(card);
            });
        }
        
        // --- Populate Dropdowns (Same as original, so omitted for brevity) ---
        function populateEquipoDropdown() { /* ... */ }
        function populateConjuntoDropdown(selectedEquipo) { /* ... */ }
        function populateParteDropdown(selectedEquipo, selectedConjunto) { /* ... */ }
        function populateTextoEstandarDropdown(selectedEquipo, selectedConjunto, selectedParte) { /* ... */ }
        // Add event listeners for dropdowns (same as original)
        equipoSelect.addEventListener('change', () => populateConjuntoDropdown(equipoSelect.value));
        conjuntoSelect.addEventListener('change', () => populateParteDropdown(equipoSelect.value, conjuntoSelect.value));
        parteSelect.addEventListener('change', () => populateTextoEstandarDropdown(equipoSelect.value, conjuntoSelect.value, parteSelect.value));


        // --- CRUD Operations with Supabase ---
        async function loadData() {
            showLoader(true);
            dataTableBody.innerHTML = '<tr><td colspan="12" class="px-6 py-4 text-center">Cargando...</td></tr>';

            const userWorkshop = userToWorkshopMap[currentUser?.email];
            let query = supabase.from('reportes').select('*').order('created_at', { ascending: false });

            // Filter data by workshop if the user is not Argos
            if (userWorkshop !== 'ARGOS') {
                query = query.eq('taller', currentWorkshop);
            }

            const { data: records, error } = await query;
            showLoader(false);

            if (error) {
                console.error('Error fetching data:', error);
                dataTableBody.innerHTML = '<tr><td colspan="12" class="px-6 py-4 text-center text-red-500">Error al cargar datos.</td></tr>';
                return;
            }

            if (records.length === 0) {
                dataTableBody.innerHTML = `<tr><td colspan="12" class="px-6 py-4 text-center">No hay datos registrados para ${workshopDisplayNames[currentWorkshop]}.</td></tr>`;
                return;
            }

            dataTableBody.innerHTML = '';
            records.forEach(data => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${data.equipo || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.fecha || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.otOrigen || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.conjunto || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.parte || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.textoEstandar || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.descripcionDetallada || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.prioridad || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.tecnico || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.telefono || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${data.fotoUrl ? `<a href="${data.fotoUrl}" target="_blank" class="text-blue-600 hover:underline">Ver Foto</a>` : 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex space-x-2">
                        <button data-id="${data.id}" class="edit-btn px-4 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-md hover:bg-blue-700">Editar</button>
                        <button data-id="${data.id}" class="delete-btn px-4 py-2 bg-red-600 text-white font-semibold rounded-md shadow-md hover:bg-red-700">Eliminar</button>
                    </td>
                `;
                dataTableBody.appendChild(row);
            });

            // Add event listeners for new buttons
            document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => editRecord(e.target.dataset.id, records)));
            document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => deleteRecord(e.target.dataset.id)));
        }

        function editRecord(id, records) {
            const recordToEdit = records.find(r => r.id == id);
            if (!recordToEdit) return;

            editingRecordIdInput.value = recordToEdit.id;
            document.getElementById('fecha').value = recordToEdit.fecha;
            document.getElementById('otOrigen').value = recordToEdit.otOrigen;
            document.getElementById('descripcionDetallada').value = recordToEdit.descripcionDetallada;
            document.getElementById('prioridad').value = recordToEdit.prioridad;
            document.getElementById('tecnico').value = recordToEdit.tecnico;
            document.getElementById('telefono').value = recordToEdit.telefono;
            
            equipoSelect.value = recordToEdit.equipo;
            populateConjuntoDropdown(recordToEdit.equipo);
            conjuntoSelect.value = recordToEdit.conjunto;
            populateParteDropdown(recordToEdit.equipo, recordToEdit.conjunto);
            parteSelect.value = recordToEdit.parte;
            populateTextoEstandarDropdown(recordToEdit.equipo, recordToEdit.conjunto, recordToEdit.parte);
            textoEstandarSelect.value = recordToEdit.textoEstandar;
            
            fotoNameSpan.textContent = recordToEdit.fotoUrl ? 'Foto existente. Seleccione una nueva para reemplazarla.' : '';

            saveRecordBtn.textContent = 'Actualizar Registro';
            cancelEditBtn.style.display = 'inline-block';
            window.scrollTo(0, 0); // Scroll to top
        }
        
        cancelEditBtn.addEventListener('click', () => {
            dataForm.reset();
            populateEquipoDropdown();
            editingRecordIdInput.value = '';
            saveRecordBtn.textContent = 'Guardar Registro';
            cancelEditBtn.style.display = 'none';
            fotoNameSpan.textContent = '';
        });

        async function deleteRecord(id) {
            if (!confirm('¿Estás seguro de que quieres eliminar este registro?')) return;
            showLoader(true);
            const { error } = await supabase.from('reportes').delete().eq('id', id);
            showLoader(false);
            if (error) {
                showCustomAlert('Error al eliminar el registro.', true);
            } else {
                showCustomAlert('Registro eliminado con éxito.');
                loadData();
            }
        }

        dataForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoader(true);

            const formData = new FormData(dataForm);
            const recordData = Object.fromEntries(formData.entries());
            recordData.taller = currentWorkshop;
            recordData.user_id = currentUser.id;
            
            let fotoUrl = null;
            const file = fotoInput.files[0];

            if (file) {
                const filePath = `${currentWorkshop}/${Date.now()}-${file.name}`;
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('reportefotos')
                    .upload(filePath, file);

                if (uploadError) {
                    showLoader(false);
                    showCustomAlert(`Error al subir la foto: ${uploadError.message}`, true);
                    return;
                }

                const { data: urlData } = supabase.storage.from('reportefotos').getPublicUrl(filePath);
                fotoUrl = urlData.publicUrl;
            }

            if (fotoUrl) {
                recordData.fotoUrl = fotoUrl;
            }
            delete recordData.foto; // Remove file input from data to be saved

            const recordId = editingRecordIdInput.value;
            let result;
            if (recordId) {
                // Update
                result = await supabase.from('reportes').update(recordData).eq('id', recordId);
            } else {
                // Insert
                result = await supabase.from('reportes').insert([recordData]);
            }

            showLoader(false);
            if (result.error) {
                showCustomAlert(`Error al guardar: ${result.error.message}`, true);
            } else {
                showCustomAlert(recordId ? 'Registro actualizado con éxito.' : 'Registro guardado con éxito.');
                cancelEditBtn.click(); // Reset form
                loadData();
            }
        });

        fotoInput.addEventListener('change', () => {
            fotoNameSpan.textContent = fotoInput.files.length > 0 ? fotoInput.files[0].name : '';
        });

        // --- Excel Download ---
        downloadExcelBtn.addEventListener('click', async () => {
            showLoader(true);
            const userWorkshop = userToWorkshopMap[currentUser?.email];
            let query = supabase.from('reportes').select('*');
            if (userWorkshop !== 'ARGOS') {
                query = query.eq('taller', currentWorkshop);
            }
            const { data, error } = await query;
            showLoader(false);

            if (error || !data || data.length === 0) {
                showCustomAlert('No hay datos para exportar.');
                return;
            }
            
            const ws = XLSX.utils.json_to_sheet(data);
            const
