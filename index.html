<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REPORTE por Taller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Updated background image path to relative path */
            background-image: url('FONDO.png');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            background-color: #f3f4f6; /* Fallback color */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }
        @media (min-width: 640px) {
            body { padding: 1.5rem; }
        }
        @media (min-width: 768px) {
            body { padding: 2rem; }
        }

        /* Styles for the workshop cards */
        .workshop-card {
            background-size: cover;
            background-position: center;
            min-height: 150px; /* Adjust as needed */
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 1rem;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .workshop-card:hover {
            transform: translateY(-5px);
        }
        .text-input, .select-input, .textarea-input, .file-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            font-size: 0.875rem;
            line-height: 1.25rem;
        }
        .text-input:focus, .select-input:focus, .textarea-input:focus, .file-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.5);
        }
        .custom-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            z-index: 1000;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div id="loginView" class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Iniciar Sesión</h2>
        <div id="loginError" class="text-red-500 text-center mb-4 hidden">Usuario o contraseña incorrectos.</div>
        <form id="loginForm">
            <div class="mb-4">
                <label for="username" class="block text-gray-700 text-sm font-bold mb-2">Usuario:</label>
                <input type="text" id="username" name="username" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
            </div>
            <div class="mb-6">
                <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Contraseña:</label>
                <input type="password" id="password" name="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required>
            </div>
            <button type="submit" id="signinBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full transition duration-150 ease-in-out">
                Iniciar Sesión
            </button>
        </form>
    </div>

    <div id="appContainer" class="hidden bg-white p-8 rounded-lg shadow-md w-full max-w-4xl">
        <div id="workshopSelectionView" class="hidden">
            <h2 class="text-3xl font-bold text-center mb-8 text-gray-800">Selecciona un Taller</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="workshopCardsContainer">
                </div>
        </div>

        <div id="dataEntryView" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">Registro de Mantenimiento <span id="currentWorkshopName"></span></h2>
                <div class="flex items-center space-x-4">
                    <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 ease-in-out">
                        Cerrar Sesión
                    </button>
                    <button id="downloadExcel" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 ease-in-out">
                        Descargar Excel
                    </button>
                    <button id="backToMenuBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 ease-in-out">
                        Volver al Menú
                    </button>
                </div>
            </div>

            <form id="dataForm" class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50 p-6 rounded-lg shadow-inner">
                <div class="col-span-1">
                    <label for="equipo" class="block text-gray-700 text-sm font-semibold mb-2">Equipo:</label>
                    <select id="equipo" name="equipo" class="select-input" required>
                        <option value="">Selecciona un equipo</option>
                        <option value="CAMION_VOLQUETE">CAMIÓN VOLQUETE</option>
                        <option value="CARGADOR_FRONTAL">CARGADOR FRONTAL</option>
                        <option value="EXCAVADORA_HIDRAULICA">EXCAVADORA HIDRÁULICA</option>
                        <option value="RETROEXCAVADORA">RETROEXCAVADORA</option>
                        <option value="MOTONIVELADORA">MOTONIVELADORA</option>
                        <option value="RODILLO_COMPACTADOR">RODILLO COMPACTADOR</option>
                    </select>
                </div>

                <div class="col-span-1">
                    <label for="fecha" class="block text-gray-700 text-sm font-semibold mb-2">Fecha:</label>
                    <input type="date" id="fecha" name="fecha" class="text-input" required>
                </div>

                <div class="col-span-1">
                    <label for="otOrigen" class="block text-gray-700 text-sm font-semibold mb-2">OT Origen:</label>
                    <input type="text" id="otOrigen" name="otOrigen" class="text-input" placeholder="Ej. OT-001" required>
                </div>

                <div class="col-span-1">
                    <label for="conjunto" class="block text-gray-700 text-sm font-semibold mb-2">Conjunto:</label>
                    <select id="conjunto" name="conjunto" class="select-input" disabled required>
                        <option value="">Selecciona un conjunto</option>
                    </select>
                </div>

                <div class="col-span-1">
                    <label for="parte" class="block text-gray-700 text-sm font-semibold mb-2">Parte:</label>
                    <select id="parte" name="parte" class="select-input" disabled required>
                        <option value="">Selecciona una parte</option>
                    </select>
                </div>

                <div class="col-span-1">
                    <label for="prioridad" class="block text-gray-700 text-sm font-semibold mb-2">Prioridad:</label>
                    <select id="prioridad" name="prioridad" class="select-input" required>
                        <option value="">Selecciona prioridad</option>
                        <option value="ALTA">ALTA</option>
                        <option value="MEDIA">MEDIA</option>
                        <option value="BAJA">BAJA</option>
                    </select>
                </div>

                <div class="col-span-2">
                    <label for="textoEstandar" class="block text-gray-700 text-sm font-semibold mb-2">Texto Estándar:</label>
                    <select id="textoEstandar" name="textoEstandar" class="select-input" disabled required>
                        <option value="">Selecciona un texto estándar</option>
                    </select>
                </div>

                <div class="col-span-2">
                    <label for="descripcionDetallada" class="block text-gray-700 text-sm font-semibold mb-2">Descripción Detallada:</label>
                    <textarea id="descripcionDetallada" name="descripcionDetallada" rows="4" class="textarea-input" placeholder="Detalle el mantenimiento realizado..." required></textarea>
                </div>

                <div class="col-span-1">
                    <label for="tecnico" class="block text-gray-700 text-sm font-semibold mb-2">Técnico:</label>
                    <input type="text" id="tecnico" name="tecnico" class="text-input" placeholder="Nombre del técnico" required>
                </div>

                <div class="col-span-1">
                    <label for="telefono" class="block text-gray-700 text-sm font-semibold mb-2">Teléfono:</label>
                    <input type="tel" id="telefono" name="telefono" class="text-input" placeholder="Ej. 123-456-7890" required>
                </div>

                <div class="col-span-2">
                    <label for="foto" class="block text-gray-700 text-sm font-semibold mb-2">Foto (Opcional):</label>
                    <input type="file" id="foto" name="foto" class="file-input">
                </div>

                <div class="col-span-2 flex justify-end space-x-4 mt-4">
                    <button type="button" id="cancelEditBtn" class="hidden bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-150 ease-in-out">
                        Cancelar Edición
                    </button>
                    <button type="submit" id="saveRecordBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-150 ease-in-out">
                        Guardar Registro
                    </button>
                </div>
            </form>

            <div class="mt-8">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Registros Existentes</h3>
                <div class="overflow-x-auto bg-white rounded-lg shadow-md">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Equipo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">OT Origen</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conjunto</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parte</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Texto Estándar</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prioridad</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Técnico</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teléfono</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Foto</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="12" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">Cargando datos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="customAlertContainer" class="hidden">
        <div class="overlay"></div>
        <div class="custom-alert">
            <p id="customAlertMessage" class="text-lg font-semibold mb-4"></p>
            <button id="customAlertCloseBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out">
                Aceptar
            </button>
        </div>
    </div>

    <script>
        // --- Supabase Configuration (Mantener para gestión de datos) ---
        const SUPABASE_URL = 'https://fyyyjfdqmeqqrldyjwhm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ5eXlqZmRxbWVxcXJsZHlqd2htIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2OTk4NTksImV4cCI6MjA2OTI3NTg1OX0.a2KTnNyzXTODxd65LvcV0PbHGnHUCkWWSMqwXRI4Mss'; // Asegúrate que esta es la ANON KEY correcta
        const supabase = window.Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- DOM Elements ---
        const loginView = document.getElementById('loginView');
        const loginForm = document.getElementById('loginForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('loginError');
        const appContainer = document.getElementById('appContainer');
        const workshopSelectionView = document.getElementById('workshopSelectionView');
        const dataEntryView = document.getElementById('dataEntryView');
        const workshopCardsContainer = document.getElementById('workshopCardsContainer');
        const currentWorkshopName = document.getElementById('currentWorkshopName');
        const dataForm = document.getElementById('dataForm');
        const saveRecordBtn = document.getElementById('saveRecordBtn');
        const downloadExcelBtn = document.getElementById('downloadExcel'); // Renombrado para claridad
        const backToMenuBtn = document.getElementById('backToMenuBtn');
        const dataTableBody = document.getElementById('dataTableBody');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const photoInput = document.getElementById('foto'); // Para la carga de fotos

        // Custom Alert elements
        const customAlertContainer = document.getElementById('customAlertContainer');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertCloseBtn = document.getElementById('customAlertCloseBtn');

        // Form fields
        const equipoSelect = document.getElementById('equipo');
        const conjuntoSelect = document.getElementById('conjunto');
        const parteSelect = document.getElementById('parte');
        const textoEstandarSelect = document.getElementById('textoEstandar');

        // --- Global Variables ---
        let currentWorkshop = null;
        let editingRecordId = null; // To store the ID of the record being edited
        let allRecords = []; // Store all records for the current workshop
        let currentFotoFile = null; // Store the selected photo file

        // --- Local Login Credentials (del archivo original) ---
        const LOCAL_USERNAME = 'user';
        const LOCAL_PASSWORD = 'password';

        // --- Workshop Data (Local y se mantiene así) ---
        const allWorkshops = {
            'Taller_Mecanico': 'Taller Mecánico',
            'Taller_Electrico': 'Taller Eléctrico',
            'Taller_Chapa_Pintura': 'Taller Chapa y Pintura',
            'Taller_Neumaticos': 'Taller de Neumáticos'
        };

        const workshopDisplayNames = {
            'Taller_Mecanico': 'Mecánico',
            'Taller_Electrico': 'Eléctrico',
            'Taller_Chapa_Pintura': 'Chapa y Pintura',
            'Taller_Neumaticos': 'Neumáticos'
        };

        const workshopImagePaths = {
            'Taller_Mecanico': 'MECANICO.png',
            'Taller_Electrico': 'ELECTRICO.png',
            'Taller_Chapa_Pintura': 'CHAPA.png',
            'Taller_Neumaticos': 'NEUMATICOS.png'
        };

        // Static data for cascading dropdowns (local y se mantiene así)
        const equipoToConjuntoMap = {
            'CAMION_VOLQUETE': ['Chasis', 'Motor', 'Transmisión', 'Sistema Hidráulico', 'Frenos', 'Dirección', 'Tren de Rodaje'],
            'CARGADOR_FRONTAL': ['Chasis', 'Motor', 'Transmisión', 'Sistema Hidráulico', 'Frenos', 'Dirección', 'Sistema de Carga'],
            'EXCAVADORA_HIDRAULICA': ['Tren de Rodaje', 'Motor', 'Sistema Hidráulico', 'Cabina', 'Pluma y Balde'],
            'RETROEXCAVADORA': ['Chasis', 'Motor', 'Transmisión', 'Sistema Hidráulico', 'Frenos', 'Cargador Frontal', 'Retroexcavadora'],
            'MOTONIVELADORA': ['Chasis', 'Motor', 'Transmisión', 'Sistema Hidráulico', 'Cuchilla', 'Ruedas'],
            'RODILLO_COMPACTADOR': ['Chasis', 'Motor', 'Sistema Hidráulico', 'Tambor de Compactación', 'Tren de Rodaje']
        };

        const conjuntoToParteMap = {
            'Chasis': ['Bastidor', 'Ejes', 'Suspensión', 'Diferencial', 'Barra estabilizadora'],
            'Motor': ['Bloque de motor', 'Culata', 'Cigüeñal', 'Árbol de levas', 'Pistones', 'Válvulas', 'Sistema de lubricación', 'Sistema de enfriamiento', 'Sistema de combustible', 'Sistema de escape'],
            'Transmisión': ['Caja de cambios', 'Embrague', 'Convertidor de par', 'Ejes de transmisión', 'Juntas universales'],
            'Sistema Hidráulico': ['Bomba hidráulica', 'Cilindros hidráulicos', 'Válvulas de control', 'Mangueras y tuberías', 'Depósito hidráulico', 'Filtros hidráulicos'],
            'Frenos': ['Discos de freno', 'Pastillas de freno', 'Pinzas de freno', 'Bombas de freno', 'Líquido de frenos', 'Freno de estacionamiento'],
            'Dirección': ['Volante', 'Columna de dirección', 'Bomba de dirección asistida', 'Caja de dirección', 'Barras de dirección'],
            'Tren de Rodaje': ['Cadenas', 'Rodillos', 'Ruedas dentadas', 'Ruedas guía', 'Zapatas'],
            'Sistema de Carga': ['Brazo de carga', 'Balde', 'Cilindros de balde', 'Acoplamiento rápido'],
            'Cabina': ['Asiento del operador', 'Controles', 'Aire acondicionado', 'Sistema de audio', 'Iluminación interior'],
            'Pluma y Balde': ['Pluma principal', 'Brazo', 'Balde', 'Cilindros de la pluma', 'Cilindros del balde'],
            'Cargador Frontal': ['Brazo de cargador', 'Cucharón', 'Cilindros de elevación'],
            'Retroexcavadora': ['Pluma retro', 'Brazo retro', 'Cucharón retro', 'Estabilizadores'],
            'Cuchilla': ['Hoja de la motoniveladora', 'Cilindros de ajuste'],
            'Ruedas': ['Neumáticos', 'Llantas', 'Bujes', 'Rodamientos'],
            'Tambor de Compactación': ['Tambor vibratorio', 'Sistema de vibración', 'Rodamientos del tambor']
        };

        const parteToTextoEstandarMap = {
            'Bastidor': ['Revisión estructural del bastidor', 'Inspección de soldaduras', 'Verificación de puntos de anclaje'],
            'Ejes': ['Revisión de rodamientos de eje', 'Engrase de puntos de pivote', 'Inspección de fugas en sellos'],
            'Suspensión': ['Verificación de amortiguadores', 'Revisión de ballestas/muelles', 'Engrase de bujes'],
            'Diferencial': ['Cambio de aceite de diferencial', 'Inspección de fugas', 'Verificación de engranajes'],
            'Barra estabilizadora': ['Revisión de bujes de barra', 'Inspección de soportes'],
            'Bloque de motor': ['Inspección visual de fugas', 'Limpieza y verificación de superficies'],
            'Culata': ['Verificación de apriete de pernos de culata', 'Inspección de fugas', 'Revisión de válvulas (si es posible)'],
            'Cigüeñal': ['Inspección de holgura axial', 'Verificación de muñequillas'],
            'Árbol de levas': ['Inspección de lóbulos', 'Verificación de rodamientos'],
            'Pistones': ['Inspección de anillos de pistón', 'Verificación de faldones'],
            'Válvulas': ['Ajuste de taqués', 'Inspección de asientos de válvula', 'Limpieza de vástagos'],
            'Sistema de lubricación': ['Cambio de aceite y filtro de motor', 'Revisión de presión de aceite', 'Inspección de mangueras y tuberías'],
            'Sistema de enfriamiento': ['Revisión de nivel y calidad de refrigerante', 'Inspección de radiador y mangueras', 'Verificación de termostato y bomba de agua'],
            'Sistema de combustible': ['Cambio de filtro de combustible', 'Purga de aire', 'Inspección de inyectores y líneas'],
            'Sistema de escape': ['Inspección de fugas en el escape', 'Revisión de soportes', 'Limpieza del catalizador/filtro de partículas'],
            'Caja de cambios': ['Cambio de aceite de transmisión', 'Inspección de fugas', 'Verificación de marchas'],
            'Embrague': ['Ajuste de embrague', 'Inspección de desgaste del disco', 'Revisión de cilindro maestro y esclavo'],
            'Convertidor de par': ['Inspección de fugas', 'Verificación de funcionamiento'],
            'Ejes de transmisión': ['Engrase de crucetas', 'Inspección de rodamientos', 'Verificación de alineación'],
            'Juntas universales': ['Engrase de juntas', 'Inspección de holgura'],
            'Bomba hidráulica': ['Inspección de fugas', 'Verificación de presión', 'Cambio de filtro de bomba'],
            'Cilindros hidráulicos': ['Inspección de fugas en sellos', 'Revisión de vástagos', 'Verificación de soportes'],
            'Válvulas de control': ['Limpieza y ajuste de válvulas', 'Inspección de fugas'],
            'Mangueras y tuberías': ['Inspección de desgaste y fugas', 'Apriete de conexiones'],
            'Depósito hidráulico': ['Cambio de aceite hidráulico', 'Limpieza de depósito', 'Revisión de nivel'],
            'Filtros hidráulicos': ['Cambio de filtro de retorno', 'Cambio de filtro de succión'],
            'Discos de freno': ['Inspección de desgaste y deformación', 'Limpieza'],
            'Pastillas de freno': ['Inspección de desgaste', 'Reemplazo si es necesario'],
            'Pinzas de freno': ['Inspección de fugas', 'Limpieza', 'Engrase de pernos guía'],
            'Bombas de freno': ['Inspección de fugas', 'Verificación de funcionamiento'],
            'Líquido de frenos': ['Revisión de nivel y calidad', 'Purga del sistema'],
            'Freno de estacionamiento': ['Ajuste de freno', 'Inspección de cable/mecanismo'],
            'Volante': ['Verificación de holgura'],
            'Columna de dirección': ['Inspección de juntas', 'Engrase'],
            'Bomba de dirección asistida': ['Inspección de fugas', 'Revisión de nivel de fluido'],
            'Caja de dirección': ['Inspección de fugas', 'Verificación de holgura'],
            'Barras de dirección': ['Inspección de rótulas', 'Engrase'],
            'Cadenas': ['Inspección de tensión y desgaste', 'Engrase de pasadores'],
            'Rodillos': ['Inspección de rodamientos y desgaste'],
            'Ruedas dentadas': ['Inspección de desgaste'],
            'Ruedas guía': ['Inspección de rodamientos y desgaste'],
            'Zapatas': ['Inspección de desgaste y daños'],
            'Brazo de carga': ['Inspección de pines y bujes', 'Engrase de puntos de pivote'],
            'Balde': ['Inspección de dientes y filo', 'Revisión de soldaduras'],
            'Cilindros de balde': ['Inspección de fugas en sellos', 'Revisión de vástagos'],
            'Acoplamiento rápido': ['Inspección de desgaste y funcionamiento'],
            'Asiento del operador': ['Ajuste y limpieza'],
            'Controles': ['Verificación de funcionamiento', 'Limpieza'],
            'Aire acondicionado': ['Revisión de carga de gas', 'Limpieza de filtros'],
            'Sistema de audio': ['Verificación de funcionamiento'],
            'Iluminación interior': ['Revisión de luces'],
            'Pluma principal': ['Inspección estructural', 'Engrase de pines'],
            'Brazo': ['Inspección estructural', 'Engrase de pines'],
            'Cucharón': ['Inspección de dientes y filo', 'Revisión de soldaduras'],
            'Cilindros de la pluma': ['Inspección de fugas en sellos', 'Revisión de vástagos'],
            'Cilindros del balde': ['Inspección de fugas en sellos', 'Revisión de vástagos'],
            'Brazo de cargador': ['Inspección de pines y bujes', 'Engrase'],
            'Cucharón': ['Inspección de desgaste'],
            'Cilindros de elevación': ['Inspección de fugas'],
            'Pluma retro': ['Inspección estructural', 'Engrase'],
            'Brazo retro': ['Inspección estructural', 'Engrase'],
            'Cucharón retro': ['Inspección de desgaste'],
            'Estabilizadores': ['Inspección de funcionamiento', 'Engrase'],
            'Hoja de la motoniveladora': ['Inspección de desgaste del filo', 'Ajuste'],
            'Cilindros de ajuste': ['Inspección de fugas'],
            'Neumáticos': ['Revisión de presión y desgaste', 'Inspección de daños'],
            'Llantas': ['Inspección de deformaciones', 'Limpieza'],
            'Bujes': ['Inspección de desgaste', 'Engrase'],
            'Rodamientos': ['Inspección de holgura y ruido'],
            'Tambor vibratorio': ['Inspección de daños', 'Limpieza'],
            'Sistema de vibración': ['Verificación de funcionamiento', 'Engrase'],
            'Rodamientos del tambor': ['Inspección de holgura y ruido']
        };

        // --- Functions ---

        // Custom Alert Function
        function showCustomAlert(message) {
            customAlertMessage.textContent = message;
            customAlertContainer.classList.remove('hidden');
        }

        function hideCustomAlert() {
            customAlertContainer.classList.add('hidden');
        }

        // --- View Management ---
        function showLoginView() {
            loginView.classList.remove('hidden');
            appContainer.classList.add('hidden');
            workshopSelectionView.classList.add('hidden');
            dataEntryView.classList.add('hidden');
        }

        function showWorkshopSelectionView() {
            loginView.classList.add('hidden');
            appContainer.classList.remove('hidden');
            workshopSelectionView.classList.remove('hidden');
            dataEntryView.classList.add('hidden');
            renderWorkshopCards();
        }

        function showDataEntryView(workshopKey) {
            currentWorkshop = workshopKey;
            currentWorkshopName.textContent = `(${workshopDisplayNames[currentWorkshop]})`;
            loginView.classList.add('hidden');
            appContainer.classList.remove('hidden');
            workshopSelectionView.classList.add('hidden');
            dataEntryView.classList.remove('hidden');
            loadRecords(); // Load existing records for the selected workshop
            resetForm();
        }

        function renderWorkshopCards() {
            workshopCardsContainer.innerHTML = ''; // Clear previous cards
            for (const key in allWorkshops) {
                const card = document.createElement('div');
                card.className = `workshop-card relative rounded-lg shadow-lg overflow-hidden transition duration-300 ease-in-out transform hover:scale-105 group border-2 border-transparent hover:border-blue-500`;
                card.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.7)), url('${workshopImagePaths[key]}')`;
                card.innerHTML = `
                    <h3 class="text-xl font-bold mb-1 text-center">${allWorkshops[key]}</h3>
                `;
                card.addEventListener('click', () => showDataEntryView(key));
                workshopCardsContainer.appendChild(card);
            }
        }

        // --- Form Logic ---
        function populateDropdown(selectElement, options) {
            selectElement.innerHTML = '<option value="">Selecciona una opción</option>';
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
            selectElement.disabled = false;
        }

        function resetForm() {
            dataForm.reset();
            conjuntoSelect.innerHTML = '<option value="">Selecciona un conjunto</option>';
            conjuntoSelect.disabled = true;
            parteSelect.innerHTML = '<option value="">Selecciona una parte</option>';
            parteSelect.disabled = true;
            textoEstandarSelect.innerHTML = '<option value="">Selecciona un texto estándar</option>';
            textoEstandarSelect.disabled = true;
            saveRecordBtn.textContent = 'Guardar Registro';
            cancelEditBtn.classList.add('hidden');
            editingRecordId = null;
            currentFotoFile = null; // Clear selected photo file
            photoInput.value = ''; // Clear file input display
        }

        // --- Supabase Data Operations (Mantenidas) ---

        async function loadRecords() {
            try {
                dataTableBody.innerHTML = '<tr><td colspan="12" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">Cargando datos...</td></tr>';
                const { data, error } = await supabase
                    .from('registros') // Tu tabla en Supabase
                    .select('*')
                    .eq('taller', currentWorkshop) // Filtrar por el taller actual
                    .order('fecha', { ascending: false });

                if (error) throw error;

                allRecords = data; // Store fetched data
                renderRecords(allRecords);
            } catch (error) {
                showCustomAlert('Error al cargar registros: ' + error.message);
                console.error('Error al cargar registros:', error);
                dataTableBody.innerHTML = '<tr><td colspan="12" class="px-6 py-4 whitespace-nowrap text-center text-sm text-red-500">Error al cargar datos.</td></tr>';
            }
        }

        async function saveRecord(recordData) {
            try {
                let fotoUrl = null;
                if (currentFotoFile) {
                    // Upload image to Supabase Storage
                    const filePath = `public/${currentWorkshop}/${Date.now()}-${currentFotoFile.name}`;
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('fotos_registros') // Tu bucket de almacenamiento en Supabase
                        .upload(filePath, currentFotoFile, {
                            cacheControl: '3600',
                            upsert: false
                        });

                    if (uploadError) throw uploadError;

                    // Get public URL of the uploaded image
                    const { data: publicUrlData } = supabase.storage
                        .from('fotos_registros')
                        .getPublicUrl(filePath);

                    fotoUrl = publicUrlData.publicUrl;
                }

                recordData.fotoUrl = fotoUrl; // Add the photo URL to the record data

                let response;
                if (editingRecordId) {
                    // Update existing record
                    response = await supabase
                        .from('registros')
                        .update(recordData)
                        .eq('id', editingRecordId);
                } else {
                    // Insert new record
                    response = await supabase
                        .from('registros')
                        .insert([recordData]);
                }

                if (response.error) throw response.error;

                showCustomAlert('Registro guardado con éxito!');
                resetForm();
                loadRecords(); // Reload records to update the table
            } catch (error) {
                showCustomAlert('Error al guardar registro: ' + error.message);
                console.error('Error al guardar registro:', error);
            }
        }

        async function deleteRecord(id) {
            if (!confirm('¿Estás seguro de que quieres eliminar este registro?')) return;

            try {
                // Optionally, delete the associated photo from storage first
                // Fetch the record to get the photo URL
                const { data: recordToDelete, error: fetchError } = await supabase
                    .from('registros')
                    .select('fotoUrl')
                    .eq('id', id)
                    .single();

                if (fetchError && fetchError.code !== 'PGRST116') throw fetchError; // PGRST116 means no rows found (already deleted or never existed)

                if (recordToDelete && recordToDelete.fotoUrl) {
                    const filePath = recordToDelete.fotoUrl.split('/public/')[1]; // Extract path after /public/
                    const { error: deletePhotoError } = await supabase.storage
                        .from('fotos_registros')
                        .remove([filePath]);

                    if (deletePhotoError && deletePhotoError.statusCode !== '404') { // 404 means file not found, which is fine
                        console.warn('Error al eliminar foto de Storage:', deletePhotoError.message);
                        // Don't throw, continue with record deletion in DB
                    }
                }

                // Delete the record from the database
                const { error } = await supabase
                    .from('registros')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                showCustomAlert('Registro eliminado con éxito!');
                loadRecords(); // Reload records to update the table
                resetForm(); // Reset form in case it was in edit mode
            } catch (error) {
                showCustomAlert('Error al eliminar registro: ' + error.message);
                console.error('Error al eliminar registro:', error);
            }
        }

        function editRecord(record) {
            editingRecordId = record.id;
            // Populate form fields
            document.getElementById('equipo').value = record.equipo;
            document.getElementById('fecha').value = record.fecha;
            document.getElementById('otOrigen').value = record.otOrigen;
            document.getElementById('prioridad').value = record.prioridad;
            document.getElementById('descripcionDetallada').value = record.descripcionDetallada;
            document.getElementById('tecnico').value = record.tecnico;
            document.getElementById('telefono').value = record.telefono;

            // Handle cascading dropdowns
            populateDropdown(conjuntoSelect, equipoToConjuntoMap[record.equipo] || []);
            document.getElementById('conjunto').value = record.conjunto;

            populateDropdown(parteSelect, conjuntoToParteMap[record.conjunto] || []);
            document.getElementById('parte').value = record.parte;

            populateDropdown(textoEstandarSelect, parteToTextoEstandarMap[record.parte] || []);
            document.getElementById('textoEstandar').value = record.textoEstandar;

            // Foto no se precarga en el input type="file" por seguridad.
            // La variable `currentFotoFile` se reseteará, se cargará si se selecciona una nueva.
            currentFotoFile = null;
            photoInput.value = '';

            saveRecordBtn.textContent = 'Actualizar Registro';
            cancelEditBtn.classList.remove('hidden');
        }

        function renderRecords(records) {
            dataTableBody.innerHTML = ''; // Clear current table
            if (records.length === 0) {
                dataTableBody.innerHTML = '<tr><td colspan="12" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">No hay registros para este taller.</td></tr>';
                return;
            }

            records.forEach(record => {
                const row = document.createElement('tr');
                row.className = 'bg-white hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.equipo}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.fecha}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.otOrigen}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.conjunto}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.parte}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.textoEstandar}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 overflow-hidden text-ellipsis max-w-xs">${record.descripcionDetallada}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.prioridad}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.tecnico}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.telefono}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 hover:underline">
                        ${record.fotoUrl ? `<a href="${record.fotoUrl}" target="_blank">Ver Foto</a>` : 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-indigo-600 hover:text-indigo-900 mr-2" onclick="editRecord(${JSON.stringify(record).replace(/"/g, '&quot;')})">Editar</button>
                        <button class="text-red-600 hover:text-red-900" onclick="deleteRecord('${record.id}')">Eliminar</button>
                    </td>
                `;
                dataTableBody.appendChild(row);
            });
        }


        // --- Event Listeners ---

        customAlertCloseBtn.addEventListener('click', hideCustomAlert);

        // Local Login Listener
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = usernameInput.value;
            const password = passwordInput.value;

            if (username === LOCAL_USERNAME && password === LOCAL_PASSWORD) {
                loginError.classList.add('hidden');
                showWorkshopSelectionView();
            } else {
                loginError.classList.remove('hidden');
            }
        });

        // Logout Button Listener (Ajustado para login local, solo oculta app y muestra login)
        logoutBtn.addEventListener('click', () => {
            showLoginView();
            resetForm(); // Limpiar formulario al cerrar sesión
        });

        // Form Submission
        dataForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const recordData = {
                taller: currentWorkshop,
                equipo: equipoSelect.value,
                fecha: document.getElementById('fecha').value,
                otOrigen: document.getElementById('otOrigen').value,
                conjunto: conjuntoSelect.value,
                parte: parteSelect.value,
                prioridad: document.getElementById('prioridad').value,
                textoEstandar: textoEstandarSelect.value,
                descripcionDetallada: document.getElementById('descripcionDetallada').value,
                tecnico: document.getElementById('tecnico').value,
                telefono: document.getElementById('telefono').value,
                // fotoUrl will be added inside saveRecord after upload
            };

            await saveRecord(recordData);
        });

        // Cancel Edit Button
        cancelEditBtn.addEventListener('click', resetForm);

        // Handle photo selection
        photoInput.addEventListener('change', (e) => {
            currentFotoFile = e.target.files[0];
        });

        // Cascading dropdowns logic
        equipoSelect.addEventListener('change', () => {
            const selectedEquipo = equipoSelect.value;
            const conjuntos = equipoToConjuntoMap[selectedEquipo] || [];
            populateDropdown(conjuntoSelect, conjuntos);
            // Reset dependent dropdowns
            parteSelect.innerHTML = '<option value="">Selecciona una parte</option>';
            parteSelect.disabled = true;
            textoEstandarSelect.innerHTML = '<option value="">Selecciona un texto estándar</option>';
            textoEstandarSelect.disabled = true;
        });

        conjuntoSelect.addEventListener('change', () => {
            const selectedConjunto = conjuntoSelect.value;
            const partes = conjuntoToParteMap[selectedConjunto] || [];
            populateDropdown(parteSelect, partes);
            // Reset dependent dropdown
            textoEstandarSelect.innerHTML = '<option value="">Selecciona un texto estándar</option>';
            textoEstandarSelect.disabled = true;
        });

        parteSelect.addEventListener('change', () => {
            const selectedParte = parteSelect.value;
            const textos = parteToTextoEstandarMap[selectedParte] || [];
            populateDropdown(textoEstandarSelect, textos);
        });

        downloadExcelBtn.addEventListener('click', async () => {
            try {
                // Ensure all records are loaded before exporting
                await loadRecords(); // This makes sure allRecords variable is up-to-date

                if (allRecords.length === 0) {
                    showCustomAlert('No hay datos para exportar a Excel.');
                    return;
                }

                const dataToExport = [];
                const headers = [
                    "Equipo", "Fecha", "OT Origen", "Conjunto", "Parte", "Texto Estándar",
                    "Descripción Detallada", "Prioridad", "Técnico", "Teléfono", "Foto (URL)"
                ];
                dataToExport.push(headers);

                allRecords.forEach(item => {
                    const rowData = [
                        item.equipo || '',
                        item.fecha || '',
                        item.otOrigen || '',
                        item.conjunto || '',
                        item.parte || '',
                        item.textoEstandar || '',
                        item.descripcionDetallada || '',
                        item.prioridad || '',
                        item.tecnico || '',
                        item.telefono || '',
                        item.fotoUrl || 'N/A'
                    ];
                    dataToExport.push(rowData);
                });

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(dataToExport);

                XLSX.utils.book_append_sheet(wb, ws, `Records ${workshopDisplayNames[currentWorkshop]}`);

                XLSX.writeFile(wb, `Records_${workshopDisplayNames[currentWorkshop]}.xlsx`);
                console.log('Excel descargado con éxito.');
            } catch (error) {
                showCustomAlert('Error al descargar Excel: ' + error.message);
                console.error('Error al descargar Excel:', error);
            }
        });

        // --- Back to Menu Button Handler ---
        backToMenuBtn.addEventListener('click', () => {
            showWorkshopSelectionView();
        });

        // Initial setup when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            showLoginView(); // Muestra la vista de login al cargar la página
        });
    </script>
</body>
</html>
