<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REPORTE por Taller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Updated background image path to relative path */
            background-image: url('FONDO.png');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            background-color: #f3f4f6; /* Fallback color */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }
        @media (min-width: 640px) {
            body { padding: 1.5rem; }
        }
        @media (min-width: 768px) {
            body { padding: 2rem; }
        }

        /* Adjusted container for more transparency in form view */
        .container {
            max-width: 900px;
            background-color: rgba(255, 255, 255, 0.9); /* Más transparencia */
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
    </style>
</head>
<body>
    <div class="container mx-auto">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">REPORTE TALLER</h1>
        <form id="workshop-form" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="equipo" class="block text-sm font-medium text-gray-700">Equipo</label>
                    <input type="text" name="equipo" id="equipo" required
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="fecha" class="block text-sm font-medium text-gray-700">Fecha</label>
                    <input type="date" name="fecha" id="fecha" required
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="ot_origen" class="block text-sm font-medium text-gray-700">OT Origen</label>
                    <input type="number" name="ot_origen" id="ot_origen" required
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="conjunto" class="block text-sm font-medium text-gray-700">Conjunto</label>
                    <input type="text" name="conjunto" id="conjunto" required
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="parte" class="block text-sm font-medium text-gray-700">Parte</label>
                    <input type="text" name="parte" id="parte" required
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="prioridad" class="block text-sm font-medium text-gray-700">Prioridad</label>
                    <select name="prioridad" id="prioridad" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="">Seleccione...</option>
                        <option value="baja">Baja</option>
                        <option value="media">Media</option>
                        <option value="alta">Alta</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="texto_estandar" class="block text-sm font-medium text-gray-700">Texto Estándar</label>
                    <input type="text" name="texto_estandar" id="texto_estandar" required
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="taller" class="block text-sm font-medium text-gray-700">Taller</label>
                    <select name="taller" id="taller" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="">Seleccione...</option>
                        <option value="electrico">Eléctrico</option>
                        <option value="hidraulico">Hidráulico</option>
                        <option value="mecanico">Mecánico</option>
                    </select>
                </div>
            </div>
            <div>
                <label for="descripcion" class="block text-sm font-medium text-gray-700">Descripción Detallada</label>
                <textarea name="descripcion" id="descripcion" rows="4" required
                          class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="tecnico" class="block text-sm font-medium text-gray-700">Técnico</label>
                    <input type="text" name="tecnico" id="tecnico" required
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="telefono" class="block text-sm font-medium text-gray-700">Teléfono</label>
                    <input type="tel" name="telefono" id="telefono" required
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
            </div>
            <div>
                <label for="foto" class="block text-sm font-medium text-gray-700">Adjuntar Foto</label>
                <input type="file" name="foto" id="foto" accept="image/*"
                       class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>
            <div class="flex justify-between items-center">
                <button type="button" id="clear-form"
                        class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Limpiar
                </button>
                <button type="submit"
                        class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Guardar Reporte
                </button>
            </div>
        </form>
    </div>

    <script>
        // Inicialización del cliente de Supabase
        const supabaseUrl = 'https://txpezttlhtxjkwtfehme.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4cGV6dHRsaHR4amt3dGZlaG1lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwNzA1MDcsImV4cCI6MjA2OTY0NjUwN30.74iEuQQfSvlu36lbfd78e8aM6vFcZUkA7ab0oWT9yGI';
        const supabase = createClient(supabaseUrl, supabaseKey);

        const form = document.getElementById('workshop-form');
        const clearFormBtn = document.getElementById('clear-form');
        const fileInput = document.getElementById('foto');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            let fotoUrl = null;
            const file = fileInput.files[0];

            if (file) {
                const filePath = `${Date.now()}-${file.name}`;
                const { error: uploadError } = await supabase.storage
                    .from('reportefotos')
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (uploadError) {
                    alert('Error al subir la foto: ' + uploadError.message);
                    return;
                }

                const { data: publicUrlData } = supabase
                    .storage
                    .from('reportefotos')
                    .getPublicUrl(filePath);

                fotoUrl = publicUrlData.publicUrl;
            }

            const data = {
                equipo: document.querySelector('[name="equipo"]').value,
                fecha: document.querySelector('[name="fecha"]').value,
                otOrigen: parseInt(document.querySelector('[name="ot_origen"]').value),
                conjunto: document.querySelector('[name="conjunto"]').value,
                parte: document.querySelector('[name="parte"]').value,
                prioridad: document.querySelector('[name="prioridad"]').value,
                textoEstandar: document.querySelector('[name="texto_estandar"]').value,
                descripcionDetallada: document.querySelector('[name="descripcion"]').value,
                tecnico: document.querySelector('[name="tecnico"]').value,
                telefono: document.querySelector('[name="telefono"]').value,
                taller: document.querySelector('[name="taller"]').value,
                fotoUrl: fotoUrl
            };

            const { error } = await supabase.from('reportes').insert([data]);
            if (error) {
                alert('Error al guardar: ' + error.message);
            } else {
                alert('Registro guardado exitosamente');
                form.reset();
            }
        });

        clearFormBtn.addEventListener('click', () => {
            form.reset();
        });
    </script>
</body>
</html>
