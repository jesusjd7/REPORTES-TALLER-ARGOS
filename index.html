// --- INICIALIZACIÓN DE SUPABASE (YA CON TUS CLAVES) ---
        // Esta es la URL de tu proyecto Supabase
        const SUPABASE_URL = 'https://cyvxxmjmkiktwizgpzqj.supabase.co';

        // Esta es la clave anon public de tu proyecto Supabase
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5dnh4bWpta2lrdHdpZ3BwcnFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0MDg4ODcsImV4cCI6MjA2ODk4NDg4N30.5k9rwN4-FVJEHFE6xWvn5J3j3iUvwcF9kZjAQXEjACQ';

        // Conecta tu aplicación con Supabase
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        // --- FIN DE LA INICIALIZACIÓN DE SUPABASE ---


        // --- Elementos del DOM ---
        const loginView = document.getElementById('loginView');
        const usernameInput = document.getElementById('usernameInput');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const loginMessage = document.getElementById('loginMessage');
        const logoutBtn = document.getElementById('logoutBtn');

        const workshopSelectionView = document.getElementById('workshopSelectionView');
        const workshopCards = document.querySelectorAll('.workshop-card');

        const formView = document.getElementById('formView');
        const currentWorkshopName = document.getElementById('currentWorkshopName');
        const reportForm = document.getElementById('reportForm');
        const equipoInput = document.getElementById('equipo');
        const fechaInput = document.getElementById('fecha');
        const otOrigenInput = document.getElementById('otOrigen');
        const conjuntoSelect = document.getElementById('conjunto');
        const parteSelect = document.getElementById('parte');
        const textoEstandarSelect = document.getElementById('textoEstandar');
        const descripcionDetalladaInput = document.getElementById('descripcionDetallada');
        const prioridadSelect = document.getElementById('prioridad');
        const tecnicoInput = document.getElementById('tecnico');
        const telefonoInput = document.getElementById('telefono');
        const fotoInput = document.getElementById('foto');
        const viewReportsBtn = document.getElementById('viewReportsBtn');
        const backToWorkshopsBtnFromForm = document.getElementById('backToWorkshopsBtnFromForm');

        const reportsView = document.getElementById('reportsView');
        const reportsWorkshopName = document.getElementById('reportsWorkshopName');
        const reportsTableBody = document.getElementById('reportsTableBody');
        const downloadExcelBtn = document.getElementById('downloadExcelBtn');
        const backToMenuBtn = document.getElementById('backToMenuBtn');

        // --- Variables Globales ---
        let currentWorkshop = ''; // Stores the currently selected workshop's key (e.g., 'kael')
        const workshopDisplayNames = { // Map for displaying full names
            'kael': 'KAEL',
            'abfren': 'ABFREN',
            'somec': 'SOMEC',
            'dracso': 'DRACSO',
            'mecanicos': 'Mecánicos',
            'latoneria': 'Latonería'
        };

        // Data for dynamic dropdowns
        const conjuntoToParteMap = {
            "SISTEMA HIDRAULICO": ["BOMBA HIDRAULICA", "CILINDRO HIDRAULICO", "VALVULA HIDRAULICA", "MANGUERA HIDRAULICA", "FILTRO HIDRAULICO"],
            "MOTOR": ["CULATA", "BLOQUE", "CIGUEÑAL", "BIELA", "PISTON", "VALVULA DE ADMISION", "VALVULA DE ESCAPE", "ARBOL DE LEVAS", "CARTER", "BOMBA DE ACEITE", "INYECTOR", "TURBOCARGADOR", "RADIADOR"],
            "SISTEMA FRENOS": ["DISCO DE FRENO", "PASTILLA DE FRENO", "CALIPER", "TAMBOR DE FRENO", "BOMBA DE FRENO", "BOOSTER DE FRENO", "LIQUIDO DE FRENOS", "MANGUERA DE FRENO"],
            "ESTRUCTURA CHASIS": ["CHASIS", "CARROCERIA", "EJE", "SUSPENSION", "AMORTIGUADOR", "RESORTE", "BARRA ESTABILIZADORA"],
            "TRANSMISION": ["CAJA DE CAMBIOS", "EMBRAGUE", "CONVERTIDOR DE PAR", "ARBOL DE TRANSMISION", "DIFERENCIAL", "PALIER"],
            "DIRECCION": ["VOLANTE", "CAJA DE DIRECCION", "BARRA DE DIRECCION", "ROTULA", "BOMBA DE DIRECCION ASISTIDA"],
            "SISTEMA ELECTRICO": ["BATERIA", "ALTERNADOR", "MOTOR DE ARRANQUE", "CABLEADO", "FUSIBLE", "RELE", "SENSOR", "UNIDAD DE CONTROL ELECTRONICO (ECU)"],
            "AIRE ACONDICIONADO": ["COMPRESOR DE A/A", "CONDENSADOR DE A/A", "EVAPORADOR DE A/A", "FILTRO SECADOR", "VENTILADOR DE A/A"],
            "COMPONENTE DE DESGASTE": ["LLANTA", "RODAMIENTO", "RETEN", "CORREA", "FILTRO DE AIRE", "FILTRO DE COMBUSTIBLE", "BUJIA"],
            "OTROS": ["ESPEJO RETROVISOR", "CRISTAL", "ASIENTO", "CINTURON DE SEGURIDAD", "FARO", "PILOTO"]
        };

        const parteToTextoEstandarMap = {
            "BOMBA HIDRAULICA": ["REPARACION BOMBA HIDRAULICA", "SUSTITUCION BOMBA HIDRAULICA"],
            "CILINDRO HIDRAULICO": ["REPARACION CILINDRO HIDRAULICO", "SUSTITUCION CILINDRO HIDRAULICO", "FUGA CILINDRO HIDRAULICO"],
            "VALVULA HIDRAULICA": ["REVISION VALVULA HIDRAULICA", "SUSTITUCION VALVULA HIDRAULICA"],
            "MANGUERA HIDRAULICA": ["REEMPLAZO MANGUERA HIDRAULICA", "REPARACION FUGA MANGUERA HIDRAULICA"],
            "FILTRO HIDRAULICO": ["CAMBIO FILTRO HIDRAULICO"],
            "CULATA": ["REPARACION CULATA", "RECTIFICACION CULATA", "SUSTITUCION CULATA"],
            "BLOQUE": ["REPARACION BLOQUE", "SUSTITUCION BLOQUE"],
            "CIGUEÑAL": ["REVISION CIGUEÑAL", "REPARACION CIGUEÑAL", "SUSTITUCION CIGUEÑAL"],
            "BIELA": ["INSPECCION BIELA", "REPARACION BIELA", "SUSTITUCION BIELA"],
            "PISTON": ["CAMBIO PISTON", "REVISION PISTON"],
            "VALVULA DE ADMISION": ["REGLAJE VALVULA ADMISION", "SUSTITUCION VALVULA ADMISION"],
            "VALVULA DE ESCAPE": ["REGLAJE VALVULA ESCAPE", "SUSTITUCION VALVULA ESCAPE"],
            "ARBOL DE LEVAS": ["REEMPLAZO ARBOL DE LEVAS"],
            "CARTER": ["REPARACION FUGA CARTER", "SUSTITUCION CARTER"],
            "BOMBA DE ACEITE": ["CAMBIO BOMBA ACEITE", "REVISION BOMBA ACEITE"],
            "INYECTOR": ["LIMPIEZA INYECTOR", "SUSTITUCION INYECTOR", "AJUSTE INYECTOR"],
            "TURBOCARGADOR": ["REPARACION TURBOCARGADOR", "SUSTITUCION TURBOCARGADOR"],
            "RADIADOR": ["REPARACION FUGA RADIADOR", "SUSTITUCION RADIADOR", "LIMPIEZA RADIADOR"],
            "DISCO DE FRENO": ["CAMBIO DISCO FRENO", "RECTIFICACION DISCO FRENO"],
            "PASTILLA DE FRENO": ["CAMBIO PASTILLAS FRENO"],
            "CALIPER": ["REPARACION CALIPER", "SUSTITUCION CALIPER"],
            "TAMBOR DE FRENO": ["REVISION TAMBOR FRENO", "SUSTITUCION TAMBOR FRENO"],
            "BOMBA DE FRENO": ["CAMBIO BOMBA FRENO", "REPARACION BOMBA FRENO"],
            "BOOSTER DE FRENO": ["REVISION BOOSTER FRENO", "SUSTITUCION BOOSTER FRENO"],
            "LIQUIDO DE FRENOS": ["CAMBIO LIQUIDO FRENOS"],
            "MANGUERA DE FRENO": ["REEMPLAZO MANGUERA FRENO"],
            "CHASIS": ["INSPECCION CHASIS", "REPARACION CHASIS"],
            "CARROCERIA": ["REPARACION GOLPE CARROCERIA", "PINTURA CARROCERIA"],
            "EJE": ["ALINEACION EJE", "SUSTITUCION EJE"],
            "SUSPENSION": ["REPARACION SUSPENSION", "REVISION SUSPENSION"],
            "AMORTIGUADOR": ["CAMBIO AMORTIGUADOR"],
            "RESORTE": ["CAMBIO RESORTE"],
            "BARRA ESTABILIZADORA": ["REVISION BARRA ESTABILIZADORA", "SUSTITUCION BARRA ESTABILIZADORA"],
            "CAJA DE CAMBIOS": ["REPARACION CAJA CAMBIOS", "REVISION CAJA CAMBIOS", "CAMBIO ACEITE CAJA CAMBIOS"],
            "EMBRAGUE": ["CAMBIO EMBRAGUE", "AJUSTE EMBRAGUE"],
            "CONVERTIDOR DE PAR": ["REVISION CONVERTIDOR PAR", "SUSTITUCION CONVERTIDOR PAR"],
            "ARBOL DE TRANSMISION": ["REPARACION ARBOL TRANSMISION", "SUSTITUCION ARBOL TRANSMISION"],
            "DIFERENCIAL": ["REPARACION DIFERENCIAL", "CAMBIO ACEITE DIFERENCIAL"],
            "PALIER": ["CAMBIO PALIER", "REPARACION PALIER"],
            "VOLANTE": ["REVISION VOLANTE", "REPARACION VOLANTE"],
            "CAJA DE DIRECCION": ["REPARACION CAJA DIRECCION", "SUSTITUCION CAJA DIRECCION"],
            "BARRA DE DIRECCION": ["REEMPLAZO BARRA DIRECCION"],
            "ROTULA": ["CAMBIO ROTULA"],
            "BOMBA DE DIRECCION ASISTIDA": ["REPARACION BOMBA DIRECCION ASISTIDA", "SUSTITUCION BOMBA DIRECCION ASISTIDA"],
            "BATERIA": ["COMPROBACION BATERIA", "CAMBIO BATERIA"],
            "ALTERNADOR": ["REPARACION ALTERNADOR", "SUSTITUCION ALTERNADOR"],
            "MOTOR DE ARRANQUE": ["REPARACION MOTOR ARRANQUE", "SUSTITUCION MOTOR ARRANQUE"],
            "CABLEADO": ["REPARACION CABLEADO", "REEMPLAZO CABLEADO"],
            "FUSIBLE": ["CAMBIO FUSIBLE"],
            "RELE": ["CAMBIO RELE"],
            "SENSOR": ["COMPROBACION SENSOR", "CAMBIO SENSOR"],
            "UNIDAD DE CONTROL ELECTRONICO (ECU)": ["DIAGNOSTICO ECU", "REPROGRAMACION ECU", "SUSTITUCION ECU"],
            "COMPRESOR DE A/A": ["REPARACION COMPRESOR A/A", "SUSTITUCION COMPRESOR A/A"],
            "CONDENSADOR DE A/A": ["LIMPIEZA CONDENSADOR A/A", "SUSTITUCION CONDENSADOR A/A"],
            "EVAPORADOR DE A/A": ["LIMPIEZA EVAPORADOR A/A", "SUSTITUCION EVAPORADOR A/A"],
            "FILTRO SECADOR": ["CAMBIO FILTRO SECADOR A/A"],
            "VENTILADOR DE A/A": ["REPARACION VENTILADOR A/A", "SUSTITUCION VENTILADOR A/A"],
            "LLANTA": ["CAMBIO LLANTA", "REPARACION PINCHAZO LLANTA", "ROTACION LLANTAS"],
            "RODAMIENTO": ["CAMBIO RODAMIENTO"],
            "RETEN": ["CAMBIO RETEN"],
            "CORREA": ["CAMBIO CORREA", "AJUSTE CORREA"],
            "FILTRO DE AIRE": ["CAMBIO FILTRO AIRE"],
            "FILTRO DE COMBUSTIBLE": ["CAMBIO FILTRO COMBUSTIBLE"],
            "BUJIA": ["CAMBIO BUJIA"],
            "ESPEJO RETROVISOR": ["SUSTITUCION ESPEJO RETROVISOR"],
            "CRISTAL": ["REEMPLAZO CRISTAL"],
            "ASIENTO": ["REPARACION ASIENTO", "SUSTITUCION ASIENTO"],
            "CINTURON DE SEGURIDAD": ["REVISION CINTURON SEGURIDAD", "SUSTITUCION CINTURON SEGURIDAD"],
            "FARO": ["REEMPLAZO FARO", "AJUSTE FARO"],
            "PILOTO": ["REEMPLAZO PILOTO"]
        };


        // --- Funciones para mostrar/ocultar vistas ---
        function showView(viewId) {
            const views = [loginView, workshopSelectionView, formView, reportsView];
            views.forEach(view => {
                if (view.id === viewId) {
                    view.classList.remove('hidden');
                } else {
                    view.classList.add('hidden');
                }
            });
        }

        // --- Manejo del Login con Supabase Auth ---
        // Funciòn para manejar el estado de la sesión
        async function checkUserSession() {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                // Si hay un usuario logueado, ir a la selección de taller
                showWorkshopSelectionView();
            } else {
                // Si no hay usuario, mostrar el login
                showLoginView();
            }
        }

        loginBtn.addEventListener('click', async () => {
            const email = usernameInput.value; // Supabase Auth usa email
            const password = passwordInput.value;

            // Intenta iniciar sesión con email y contraseña
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password,
            });

            if (error) {
                loginMessage.textContent = `Error al iniciar sesión: ${error.message}`;
                console.error('Error de login:', error.message);
            } else if (data.user) {
                loginMessage.textContent = 'Inicio de sesión exitoso.';
                console.log('Usuario logueado:', data.user);
                showWorkshopSelectionView();
            } else {
                loginMessage.textContent = 'Usuario o contraseña incorrectos.'; // Fallback si no hay error pero tampoco user
            }
        });

        // --- Manejo del Registro de Usuarios (Opcional, pero útil para crear usuarios) ---
        // Si quieres permitir que los usuarios se registren, puedes añadir un botón y esta función
        // async function signUpUser(email, password) {
        //     const { data, error } = await supabase.auth.signUp({
        //         email: email,
        //         password: password,
        //     });
        //     if (error) {
        //         console.error('Error al registrar:', error.message);
        //         alert(`Error al registrar: ${error.message}`);
        //     } else {
        //         alert('¡Registro exitoso! Por favor, revisa tu correo para verificar tu cuenta.');
        //         console.log('Usuario registrado:', data.user);
        //     }
        // }


        // --- Manejo del Logout con Supabase Auth ---
        logoutBtn.addEventListener('click', async () => {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Error al cerrar sesión:', error.message);
            } else {
                showLoginView();
                alert('Sesión cerrada correctamente.');
            }
        });

        // --- Manejo de la selección de Taller ---
        workshopCards.forEach(card => {
            card.addEventListener('click', () => {
                workshopCards.forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                const workshopKey = card.dataset.workshop;
                showFormView(workshopKey);
            });
        });

        // --- Lógica de los Dropdowns Dependientes ---
        conjuntoSelect.addEventListener('change', () => {
            const selectedConjunto = conjuntoSelect.value;
            parteSelect.innerHTML = '<option value="">Seleccione Parte</option>';
            textoEstandarSelect.innerHTML = '<option value="">Seleccione Texto Estandar</option>';
            textoEstandarSelect.disabled = true;

            if (selectedConjunto && conjuntoToParteMap[selectedConjunto]) {
                conjuntoToParteMap[selectedConjunto].forEach(parte => {
                    const option = document.createElement('option');
                    option.value = parte;
                    option.textContent = parte;
                    parteSelect.appendChild(option);
                });
                parteSelect.disabled = false;
            } else {
                parteSelect.disabled = true;
            }
        });

        parteSelect.addEventListener('change', () => {
            const selectedParte = parteSelect.value;
            textoEstandarSelect.innerHTML = '<option value="">Seleccione Texto Estandar</option>';

            if (selectedParte && parteToTextoEstandarMap[selectedParte]) {
                parteToTextoEstandarMap[selectedParte].forEach(texto => {
                    const option = document.createElement('option');
                    option.value = texto;
                    option.textContent = texto;
                    textoEstandarSelect.appendChild(option);
                });
                textoEstandarSelect.disabled = false;
            } else {
                textoEstandarSelect.disabled = true;
            }
        });


        // --- Manejo del Formulario (Guardar en Supabase Database y Storage) ---
        reportForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validación básica
            if (!equipoInput.value || !fechaInput.value || !otOrigenInput.value || !descripcionDetalladaInput.value) {
                alert('Por favor, complete al menos los campos obligatorios: Equipo, Fecha, OT Origen y Descripción Detallada.');
                return;
            }

            let fotoName = null;
            let fotoURL = null;

            if (fotoInput.files.length > 0) {
                const fotoFile = fotoInput.files[0];
                const fileExtension = fotoFile.name.split('.').pop();
                // Generar un nombre único para la foto
                fotoName = `${Date.now()}_${Math.random().toString(36).substring(2, 15)}.${fileExtension}`;
                const filePath = `${currentWorkshop}/${fotoName}`; // Guardar en una carpeta por taller

                // Subir la foto a Supabase Storage
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('fotos_reportes') // Asegúrate de que este bucket exista en Supabase Storage
                    .upload(filePath, fotoFile);

                if (uploadError) {
                    console.error('Error al subir la foto:', uploadError.message);
                    alert(`Error al subir la foto: ${uploadError.message}. El reporte se guardará sin foto.`);
                } else {
                    console.log('Foto subida con éxito:', uploadData.path);
                    // Obtener la URL pública de la foto
                    const { data: publicURLData } = supabase.storage
                        .from('fotos_reportes')
                        .getPublicUrl(filePath);
                    fotoURL = publicURLData.publicUrl;
                }
            }

            const newReport = {
                taller: currentWorkshop, // Añadimos el taller al que pertenece el reporte
                equipo: equipoInput.value,
                fecha: fechaInput.value,
                ot_origen: otOrigenInput.value, // Usar snake_case para la base de datos
                conjunto: conjuntoSelect.value,
                parte: parteSelect.value,
                texto_estandar: textoEstandarSelect.value, // Usar snake_case
                descripcion_detallada: descripcionDetalladaInput.value, // Usar snake_case
                prioridad: prioridadSelect.value,
                tecnico: tecnicoInput.value,
                telefono: telefonoInput.value,
                foto_nombre: fotoName, // Usar snake_case
                foto_url: fotoURL // Usar snake_case
            };

            // Insertar el reporte en la tabla 'reportes' de Supabase
            const { error: dbError } = await supabase
                .from('reportes') // Reemplaza 'reportes' con el nombre de tu tabla
                .insert([newReport]);

            if (dbError) {
                console.error('Error al guardar el reporte en la base de datos:', dbError.message);
                alert(`Error al guardar el reporte: ${dbError.message}`);
            } else {
                alert('Reporte guardado con éxito en Supabase.');
                reportForm.reset();
                fechaInput.valueAsDate = new Date(); // Resetear la fecha al día actual después de guardar
                parteSelect.innerHTML = '<option value="">Seleccione Parte</option>';
                parteSelect.disabled = true;
                textoEstandarSelect.innerHTML = '<option value="">Seleccione Texto Estandar</option>';
                textoEstandarSelect.disabled = true;
            }
        });

        // --- Ver Reportes (Cargar desde Supabase Database) ---
        viewReportsBtn.addEventListener('click', () => {
            showReportsView(currentWorkshop);
        });

        async function displayReports() {
            reportsTableBody.innerHTML = '<tr><td colspan="11" class="px-6 py-4 text-center text-gray-500">Cargando reportes...</td></tr>';

            // Consultar los reportes de Supabase para el taller actual
            const { data: reports, error } = await supabase
                .from('reportes')
                .select('*') // Selecciona todas las columnas
                .eq('taller', currentWorkshop) // Filtra por el taller actual
                .order('fecha', { ascending: false }); // Ordena por fecha descendente

            if (error) {
                console.error('Error al cargar reportes:', error.message);
                reportsTableBody.innerHTML = `<tr><td colspan="11" class="px-6 py-4 text-center text-red-500">Error al cargar reportes: ${error.message}</td></tr>`;
                return;
            }

            reportsTableBody.innerHTML = ''; // Clear existing rows
            if (reports.length === 0) {
                reportsTableBody.innerHTML = '<tr><td colspan="11" class="px-6 py-4 text-center text-gray-500">No hay reportes para este taller.</td></tr>';
                return;
            }

            reports.forEach(report => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-100');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${report.equipo || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${report.fecha || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${report.ot_origen || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${report.conjunto || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${report.parte || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${report.texto_estandar || ''}</td>
                    <td class="px-6 py-4 text-sm text-gray-500 max-w-xs overflow-hidden text-ellipsis">${report.descripcion_detallada || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${report.prioridad || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${report.tecnico || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${report.telefono || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">
                        ${report.foto_url ? `<a href="${report.foto_url}" target="_blank" class="hover:underline">Ver Foto</a>` : 'N/A'}
                    </td>
                `;
                reportsTableBody.appendChild(row);
            });
        }

        // --- Descargar Excel (Ahora leerá de Supabase Database) ---
        downloadExcelBtn.addEventListener('click', async () => {
            const { data: allData, error } = await supabase
                .from('reportes')
                .select('*')
                .eq('taller', currentWorkshop) // Filtra por el taller actual
                .order('fecha', { ascending: false });

            if (error) {
                console.error('Error al obtener datos para Excel:', error.message);
                alert(`Error al obtener datos para Excel: ${error.message}`);
                return;
            }

            if (allData.length === 0) {
                alert('No hay datos para exportar.');
                return;
            }

            const dataToExport = [];
            const headers = [
                "Taller", "Equipo", "Fecha", "OT Origen", "Conjunto", "Parte", "Texto Estandar",
                "Descripción Detallada", "Prioridad",
                "Técnico", "Teléfono", "Foto (URL)" // Cambiado a Foto (URL)
            ];
            dataToExport.push(headers);

            allData.forEach(item => {
                const rowData = [
                    workshopDisplayNames[item.taller] || '', // Usar el nombre legible del taller
                    item.equipo || '',
                    item.fecha || '',
                    item.ot_origen || '',
                    item.conjunto || '',
                    item.parte || '',
                    item.texto_estandar || '',
                    item.descripcion_detallada || '',
                    item.prioridad || '',
                    item.tecnico || '',
                    item.telefono || '',
                    item.foto_url || 'N/A' // Exportar la URL de la foto
                ];
                dataToExport.push(rowData);
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(dataToExport);

            XLSX.utils.book_append_sheet(wb, ws, `Records ${workshopDisplayNames[currentWorkshop]}`);

            XLSX.writeFile(wb, `Records_${workshopDisplayNames[currentWorkshop]}.xlsx`);
            console.log('Excel descargado con éxito.');
        });

        // --- Botón Volver al Menú desde la Tabla de Reportes ---
        backToMenuBtn.addEventListener('click', () => {
            showWorkshopSelectionView();
        });

        // --- Botón Volver a Talleres desde el Formulario ---
        backToWorkshopsBtnFromForm.addEventListener('click', () => {
            showWorkshopSelectionView();
        });

        // --- Configuración Inicial al cargar la página ---
        document.addEventListener('DOMContentLoaded', () => {
            checkUserSession(); // Verificar si hay una sesión activa al cargar la página
        });
