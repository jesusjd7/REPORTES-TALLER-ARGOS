<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REPORTE por Taller</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos generales del cuerpo */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Fondo gris claro */
        }
        /* Contenedor principal para centrar el contenido */
        .container {
            max-width: 900px;
        }
        /* Estilos personalizados para la barra de desplazamiento de la tabla */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
    <script>
        // Configuración de Tailwind CSS para colores personalizados basados en las imágenes del camión
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        customGreen: '#65A30D', /* Verde aproximado del camión */
                        customBlue: '#1E3A8A',  /* Azul oscuro aproximado del camión */
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 sm:p-6 md:p-8 flex items-center justify-center min-h-screen">
    <div class="container mx-auto bg-white p-6 rounded-lg shadow-lg">
        <!-- Contenedor principal del encabezado para títulos e iconos -->
        <div class="relative flex items-center justify-center mb-8">
            <!-- Contenedor para elementos izquierdos (botón ATRAS e Icono de Camión) -->
            <div id="leftHeaderElements" class="absolute left-0 flex items-center space-x-2" style="display: none;">
                <button id="backToMenuBtn" class="px-4 py-2 bg-customGreen text-customBlue font-semibold rounded-md shadow-md hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-customGreen focus:ring-offset-2 transition ease-in-out duration-150">
                    ATRAS
                </button>
                <img id="truckIcon" src="image_6f2c09.png" alt="Camión Icono" class="h-8 w-auto">
            </div>

            <!-- Título principal de la página, dinámico (centrado) -->
            <h1 id="mainPageTitle" class="text-3xl font-bold text-gray-800 text-center"></h1>
            
            <!-- Contenedor para elementos derechos (Logo Argos y Botón Cerrar Sesión) -->
            <div id="rightHeaderElements" class="absolute right-0 flex items-center space-x-2" style="display: none;">
                <img id="argosLogo" src="image_6f2b89.png" alt="Logo Argos" class="h-8 w-auto">
                <button id="logoutBtn" class="px-4 py-2 bg-customGreen text-customBlue font-semibold rounded-md shadow-md hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-customGreen focus:ring-offset-2 transition ease-in-out duration-150">
                    Cerrar Sesión
                </button>
            </div>
        </div>
        <!-- Subtítulo "REPORTE" que aparecerá debajo del título principal -->
        <h2 id="reportSubtitle" class="text-xl font-semibold text-center text-gray-600 mb-8" style="display: none;">REPORTE</h2>

        <!-- Vista de Inicio de Sesión (Inicialmente visible) -->
        <div id="loginView" class="flex flex-col items-center justify-center p-8">
            <img src="image_6ffdfc.png" alt="Camión Argos" class="w-64 h-auto mb-8 rounded-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Iniciar Sesión</h2>
            <div class="w-full max-w-sm">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
                    <input type="text" id="username" name="username" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                    <input type="password" id="password" name="password" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <button id="loginBtn"
                        class="w-full px-6 py-3 bg-customGreen text-customBlue font-semibold rounded-md shadow-md hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-customGreen focus:ring-offset-2 transition ease-in-out duration-150">
                    INGRESAR
                </button>
                <p id="loginError" class="text-red-600 text-center mt-4" style="display: none;"></p>
            </div>
        </div>

        <!-- Vista de Selección de Taller (Menú de Tarjetas - Inicialmente oculta) -->
        <div id="workshopSelectionView" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-8" style="display: none;">
            <!-- Las tarjetas de taller se generarán dinámicamente aquí -->
        </div>

        <!-- Vista del Formulario de Registro (Inicialmente oculta) -->
        <div id="formView" style="display: none;">
            <!-- Formulario de Registro -->
            <form id="dataForm" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Campo EQUIPO -->
                <div>
                    <label for="equipo" class="block text-sm font-medium text-gray-700 mb-1">EQUIPO *</label>
                    <select id="equipo" name="equipo" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="">Seleccione un Equipo</option>
                    </select>
                </div>

                <!-- Campo FECHA -->
                <div>
                    <label for="fecha" class="block text-sm font-medium text-gray-700 mb-1">FECHA *</label>
                    <input type="date" id="fecha" name="fecha" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>

                <!-- Campo OT ORIGEN -->
                <div>
                    <label for="otOrigen" class="block text-sm font-medium text-gray-700 mb-1">OT ORIGEN *</label>
                    <input type="number" id="otOrigen" name="otOrigen" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                           value="0">
                </div>

                <!-- Campo CONJUNTO -->
                <div>
                    <label for="conjunto" class="block text-sm font-medium text-gray-700 mb-1">CONJUNTO *</label>
                    <select id="conjunto" name="conjunto" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                            disabled>
                        <option value="">Seleccione un Conjunto</option>
                    </select>
                </div>

                <!-- Nuevo Campo: PARTE -->
                <div>
                    <label for="parte" class="block text-sm font-medium text-gray-700 mb-1">PARTE *</label>
                    <select id="parte" name="parte" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                            disabled>
                        <option value="">Seleccione una Parte</option>
                    </select>
                </div>

                <!-- Nuevo Campo: TEXTO ESTANDAR (Cambiado a select) -->
                <div>
                    <label for="textoEstandar" class="block text-sm font-medium text-gray-700 mb-1">TEXTO ESTANDAR *</label>
                    <select id="textoEstandar" name="textoEstandar" required disabled
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="">Seleccione un Texto Estandar</option>
                    </select>
                </div>

                <!-- Nuevo Campo: DESCRIPCION DETALLADA -->
                <div class="md:col-span-2">
                    <label for="descripcionDetallada" class="block text-sm font-medium text-gray-700 mb-1">DESCRIPCION DETALLADA *</label>
                    <textarea id="descripcionDetallada" name="descripcionDetallada" rows="3" required
                              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                </div>

                <!-- Campo PRIORIDAD -->
                <div>
                    <label for="prioridad" class="block text-sm font-medium text-gray-700 mb-1">PRIORIDAD *</label>
                    <select id="prioridad" name="prioridad" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="">Seleccione una Prioridad</option>
                        <option value="Alta">Alta</option>
                        <option value="Media">Media</option>
                        <option value="Baja">Baja</option>
                    </select>
                </div>

                <!-- Campo TECNICO -->
                <div>
                    <label for="tecnico" class="block text-sm font-medium text-gray-700 mb-1">TECNICO *</label>
                    <input type="text" id="tecnico" name="tecnico" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>

                <!-- Campo TELEFONO -->
                <div>
                    <label for="telefono" class="block text-sm font-medium text-gray-700 mb-1">TELEFONO *</label>
                    <input type="text" id="telefono" name="telefono" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>

                <!-- Campo FOTO (Marcador de posición) -->
                <div>
                    <label for="foto" class="block text-sm font-medium text-gray-700 mb-1">FOTO</label>
                    <input type="file" id="foto" name="foto"
                           class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <p class="mt-1 text-xs text-gray-500">Nota: La carga de archivos grandes requiere Firebase Storage.</p>
                </div>

                <!-- Botón Guardar -->
                <div class="md:col-span-2 flex justify-center">
                    <button type="submit"
                            class="px-6 py-3 bg-customGreen text-customBlue font-semibold rounded-md shadow-md hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-customGreen focus:ring-offset-2 transition ease-in-out duration-150">
                        Guardar Registro
                    </button>
                </div>
            </form>

            <hr class="my-8 border-gray-300">

            <!-- Sección de Datos Registrados -->
            <h3 class="text-2xl font-bold text-center text-gray-800 mb-6">Datos de REPORTE</h3>

            <!-- Botón Descargar Excel -->
            <div class="flex justify-center mb-6">
                <button id="downloadExcel"
                        class="px-6 py-3 bg-customGreen text-customBlue font-semibold rounded-md shadow-md hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-customGreen focus:ring-offset-2 transition ease-in-out duration-150">
                    Descargar Excel
                </button>
            </div>

            <!-- Tabla de Datos -->
            <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Equipo</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">OT Origen</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conjunto</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parte</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Texto Estandar</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción Detallada</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prioridad</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Técnico</th>
                            <th scope="col" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Teléfono</td>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Foto (URL/Nombre)</th>
                            <th scope="col" class="relative px-6 py-3">
                                <span class="sr-only">Acciones</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Los datos se cargarán aquí mediante JavaScript -->
                        <tr>
                            <td colspan="12" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">Cargando datos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p id="userIdDisplay" class="text-sm text-gray-600 text-center mt-4">ID de Usuario: Cargando...</p>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js"; // Import getAnalytics
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";


        // SheetJS (xlsx) CDN para exportación a Excel
        import * as XLSX from "https://cdn.sheetjs.com/xlsx-0.20.2/package/xlsx.mjs";
        window.XLSX = XLSX; // Hace que XLSX esté disponible globalmente para el script

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDIrPjgIL5O6iCKZNCIdfcxOsggv_NYaVM",
            authDomain: "reportetallerargos.firebaseapp.com",
            projectId: "reportetallerargos",
            storageBucket: "reportetallerargos.firebasestorage.app",
            messagingSenderId: "151460933015",
            appId: "1:151460933015:web:5b9ff541c98f7af0d268d2",
            measurementId: "G-GQLWRLYKT8"
        };
        // Usa el projectId de tu firebaseConfig como el appId para las colecciones de Firestore
        const appId = firebaseConfig.projectId;

        // Inicializa Firebase
        let app;
        let db;
        let auth;
        let storage; // Variable para Firebase Storage
        let analytics; // Variable para Firebase Analytics

        window.onload = async function() {
            if (!firebaseConfig || !firebaseConfig.apiKey || !firebaseConfig.projectId) {
                console.error('Error: La configuración de Firebase es inválida o incompleta.');
                document.getElementById('loginError').textContent = 'Error: La configuración de Firebase es inválida o incompleta. Por favor, verifica tu archivo de configuración.';
                document.getElementById('loginError').style.display = 'block';
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app); // Inicializa Firebase Storage
                analytics = getAnalytics(app); // Inicializa Firebase Analytics

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userIdDisplay').textContent = `ID de Usuario: ${userId}`;
                        console.log('Firebase inicializado y usuario autenticado:', userId);
                        // Si ya hay un usuario logueado en la app (por el formulario), ir a la selección de taller
                        if (loggedInUser) {
                            showWorkshopSelectionView();
                        } else {
                            // Si no, mostrar la vista de login de la app
                            showLoginView();
                        }
                    } else {
                        try {
                            // Asegúrate de que __initial_auth_token no se use aquí, ya que es para el entorno Canvas.
                            // Para GitHub Pages, solo usaremos signInAnonymously o un método de autenticación real.
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Error al iniciar sesión en Firebase:", error);
                            document.getElementById('userIdDisplay').textContent = 'Error de autenticación.';
                            showLoginView();
                        }
                    }
                });

            } catch (error) {
                console.error('Error initializing app:', error);
                document.getElementById('loginError').textContent = 'Error al inicializar la aplicación. Por favor, inténtalo de nuevo.';
                document.getElementById('loginError').style.display = 'block';
            }
        };


        let userId = null; // Almacenará el ID de usuario autenticado
        let dataCollectionRef; // Referencia a la colección de Firestore
        let unsubscribeSnapshot = null; // Para almacenar la función de cancelación de la escucha en tiempo real
        let loggedInUser = null; // Para almacenar el nombre de usuario del usuario logueado

        // --- Elementos del DOM ---
        const mainPageTitle = document.getElementById('mainPageTitle'); 
        const reportSubtitle = document.getElementById('reportSubtitle'); 
        const loginView = document.getElementById('loginView');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logoutBtn'); 
        const truckIcon = document.getElementById('truckIcon'); 
        const argosLogo = document.getElementById('argosLogo'); 
        const leftHeaderElements = document.getElementById('leftHeaderElements'); 
        const rightHeaderElements = document.getElementById('rightHeaderElements'); 
        const dataForm = document.getElementById('dataForm');
        const equipoSelect = document.getElementById('equipo');
        const conjuntoSelect = document.getElementById('conjunto');
        const parteSelect = document.getElementById('parte'); 
        const textoEstandarSelect = document.getElementById('textoEstandar'); 
        const dataTableBody = document.getElementById('dataTableBody');
        const downloadExcelBtn = document.getElementById('downloadExcel');
        const workshopSelectionView = document.getElementById('workshopSelectionView');
        const formView = document.getElementById('formView');
        const backToMenuBtn = document.getElementById('backToMenuBtn');

        // Popula los datos de talleres para KAEL con la estructura completa
        const equiposKael = [
            "COLMX0361", "COLMX0362", "COLMX0383", "COLMX0390", "COLMX0399", "COLMX0402", "COLMX0406", "COLMX0419",
            "COLMX0420", "COLMX0424", "COLMX0426", "COLMX0432", "COLMX0437", "COLMX0445", "COLMX0448", "COLMX0451",
            "COLMX0453", "COLMX0464", "COLMX0467", "COLMX0469", "COLMX0470", "COLMX0471", "COLMX0473", "COLMX0476",
            "COLMX0477", "COLMX0484", "COLMX0485", "COLMX0486", "COLMX0488", "COLMX0490", "COLMX0491", "COLMX0500",
            "COLMX0502", "COLMX0504", "COLMX0506", "COLMX0507", "COLMX0508", "COLMX0509", "COLMX0510", "COLMX0512",
            "COLMX0513", "COLMX0514", "COLMX0515", "COLMX0516", "COLMX0522", "COLMX0523", "COLMX0524", "COLMX0526",
            "COLMX0527", "COLMX0528", "COLMX0553", "COLMX0554", "COLMX0560", "COLMX0561", "COLMX0571", "COLMX0572",
            "COLMX0573", "COLMX0581", "COLMX0592", "COLMX0603", "COLMX0604", "COLMX0605", "COLMX0608", "COLMX0614",
            "COLMX0618", "COLMX0623", "COLMX0628", "COLMX0630", "COLMX0633", "COLMX0637", "COLMX0650", "COLMX0653",
            "COLMX0663", "COLMX0664", "COLMX0668", "COLMX0676", "COLMX0679", "COLMX0684", "COLMX0685", "COLMX0687",
            "COLMX0688", "COLMX0897", "COLMX0904", "COLMX0914", "COLMX0962", "COLMX0963", "COLMX0964", "COLMX0965",
            "COLMX0966", "COLMX0967", "COLMX0968", "COLMX0969", "COLMX0970", "COLMX0971", "COLMX0972", "COLMX0973",
            "COLMX0974", "COLMX0975", "COLMX0976", "COLMX0977", "COLMX0978", "COLMX0979", "COLMX0980", "COLMX0981",
            "COLMX0982", "COLMX0983", "COLMX0984", "COLMX0985", "COLMX0986", "COLMX0987", "COLMX0988", "COLMX0989",
            "COLMX0990", "COLMX0991", "COLMX1015", "COLMX1016", "COLMX1017", "COLMX1018", "COLMX1019", "COLMX1020",
            "COLMX1021", "COLMX1022", "COLMX1023", "COLMX1024", "COLMX1025", "COLMX1026", "COLMX1027", "COLMX1028",
            "COLMX1029", "COLMX1066", "COLMX1067", "COLMX1068", "COLMX1069", "COLMX1070", "COLMX1071", "COLMX1072",
            "COLMX1073", "COLMX1074", "COLMX1075", "COLMX1076", "COLMX1077", "COLMX1078", "COLMX1079", "COLMX1080",
            "COLAB0034", "COLAB0038", "COLAB0039", "COLAB0042", "COLAB0043", "COLAB0044", "COLAB0054", "COLAB0055",
            "COLAB0059", "COLAB0060", "COLAB0068"
        ];

        // Datos para EQUIPO, CONJUNTO, PARTE y TEXTO ESTANDAR de cada taller.
        // Esta estructura se llenará con los datos proporcionados.
        const allWorkshopsData = {
            "KAEL": {
                // Equipos para KAEL (poblados dinámicamente)
            },
            "ABFREN": {
                "Maquinaria A": {
                    "Motor A1": {
                        "Cilindro A1": ["Revisar presión", "Cambiar sello"],
                        "Biela A2": ["Ajustar", "Lubricar"]
                    }
                }
            },
            "SOMEC": {}, 
            "DRACSO": {}, 
            "JS OUT": {}, 
            "MG": {},     
            "SIMIYP": {}, 
            "SERVII": {}  
        };

        equiposKael.forEach(equipo => {
            allWorkshopsData["KAEL"][equipo] = {};
            // Popula los Conjuntos para cada Equipo
            for (const conjuntoName in conjuntoToParteMap) {
                if (conjuntoToParteMap.hasOwnProperty(conjuntoName)) {
                    allWorkshopsData["KAEL"][equipo][conjuntoName] = {};
                    // Popula las Partes para cada Conjunto
                    conjuntoToParteMap[conjuntoName].forEach(parteName => {
                        // Asigna Texto Estandar del nuevo mapa, o un valor por defecto si no se encuentra
                        allWorkshopsData["KAEL"][equipo][conjuntoName][parteName] = parteToTextoEstandarMap[parteName] || ["Default Texto Estandar"];
                    });
                }
            }
        });


        // --- Funciones de Gestión de Vistas ---
        function showLoginView() {
            loginView.style.display = 'flex'; // Usa flex para centrar
            workshopSelectionView.style.display = 'none';
            formView.style.display = 'none';
            mainPageTitle.textContent = ''; // Título vacío para la vista de inicio de sesión
            reportSubtitle.style.display = 'none'; // Oculta el subtítulo
            leftHeaderElements.style.display = 'none'; // Oculta elementos izquierdos
            rightHeaderElements.style.display = 'none'; // Oculta elementos derechos
            loggedInUser = null; // Borra el usuario logueado al cerrar sesión
        }

        function showWorkshopSelectionView() {
            loginView.style.display = 'none';
            workshopSelectionView.style.display = 'grid'; // Usa grid para las tarjetas
            formView.style.display = 'none';
            mainPageTitle.textContent = 'TALLER'; // Título para la selección de taller
            reportSubtitle.style.display = 'none'; // Oculta el subtítulo
            leftHeaderElements.style.display = 'none'; // Oculta elementos izquierdos
            rightHeaderElements.style.display = 'flex'; // Muestra elementos derechos
            logoutBtn.style.display = 'block'; // Asegura que el botón de cerrar sesión sea visible
            argosLogo.style.display = 'none'; // Oculta el logo de Argos en esta vista
            populateWorkshopCards(); // Asegura que las tarjetas se llenen según el usuario logueado
        }

        function showFormView() {
            loginView.style.display = 'none';
            workshopSelectionView.style.display = 'none';
            formView.style.display = 'block';
            mainPageTitle.textContent = workshopDisplayNames[currentWorkshop]; // Título para la vista del formulario
            reportSubtitle.style.display = 'block'; // Muestra el subtítulo "REPORTE"
            leftHeaderElements.style.display = 'flex'; // Muestra elementos izquierdos
            rightHeaderElements.style.display = 'flex'; // Muestra elementos derechos
            backToMenuBtn.style.display = 'block'; // Asegura que el botón de retroceso sea visible
            truckIcon.style.display = 'block'; // Asegura que el icono del camión sea visible
            argosLogo.style.display = 'block'; // Asegura que el logo de Argos sea visible
            logoutBtn.style.display = 'none'; // Oculta el botón de cerrar sesión en la vista del formulario
        }

        // --- Lógica de Inicio de Sesión ---
        // Objeto con credenciales válidas
        const validCredentials = {
            "KAEL": "KAEL",
            "ABFREN": "ABFREN",
            "SOMEC": "SOMEC",
            "DRACSO": "DRACSO",
            "JS OUT": "JS OUT",
            "MG": "MG",
            "SIMIYP": "SIMIYP",
            "SERVII": "SERVII",
            "ARGOS": "ARGOS" // Nuevo usuario ARGOS
        };

        loginBtn.addEventListener('click', () => {
            const username = usernameInput.value;
            const password = passwordInput.value;

            if (validCredentials[username] === password) {
                loginError.style.display = 'none';
                loggedInUser = username; // Almacena el nombre de usuario logueado
                showWorkshopSelectionView(); // Va a la selección de taller después del inicio de sesión exitoso
            } else {
                loginError.textContent = 'Usuario o contraseña incorrectos.';
                loginError.style.display = 'block';
            }
        });

        // --- Lógica de Cierre de Sesión ---
        logoutBtn.addEventListener('click', async () => {
            if (auth) {
                try {
                    await auth.signOut();
                    console.log('User signed out');
                } catch (error) {
                    console.error('Error signing out:', error);
                }
            }
            showLoginView(); // Vuelve a la vista de inicio de sesión
        });

        // --- Datos para Talleres y Dropdowns Dependientes ---
        const allWorkshops = ["KAEL", "ABFREN", "SOMEC", "DRACSO", "JS OUT", "MG", "SIMIYP", "SERVII"];
        let currentWorkshop = ''; // Ningún taller seleccionado inicialmente
        
        // Nombres de visualización de talleres (para tarjetas)
        const workshopDisplayNames = {
            "KAEL": "KAEL",
            "ABFREN": "ABFREN",
            "SOMEC": "SOMEC",
            "DRACSO": "DRACSO",
            "JS OUT": "JS OUT",
            "MG": "MG SOL", // Mostrar como MG SOL
            "SIMIYP": "SIMIYP",
            "SERVII": "SERVII"
        };

        // URLs de imágenes de talleres (marcadores de posición, reemplazar con tus imágenes reales)
        const workshopImages = {
            "KAEL": { src: "https://placehold.co/150x150/e0f2f7/0288d1?text=KAEL", alt: "Logo KAEL" }, 
            "ABFREN": { src: "https://placehold.co/150x150/ffe0b2/e65100?text=ABFREN", alt: "Logo ABFREN" }, 
            "SOMEC": { src: "https://placehold.co/150x150/c8e6c9/2e7d32?text=SOMEC", alt: "Logo SOMEC" },
            "DRACSO": { src: "https://placehold.co/150x150/ffcdd2/c62828?text=DRACSO", alt: "Logo DRACSO" },
            "JS OUT": { src: "https://placehold.co/150x150/e1bee7/6a1b9a?text=JS+OUT", alt: "Logo JS OUT" },
            "MG": { src: "https://placehold.co/150x150/bbdefb/1565c0?text=MG+SOL", alt: "Logo MG SOL" }, 
            "SIMIYP": { src: "https://placehold.co/150x150/d1c4e9/4527a0?text=SIMIYP", alt: "Logo SIMIYP" },
            "SERVII": { src: "https://placehold.co/150x150/b2dfdb/00695c?text=SERVII", alt: "Logo SERVII" } 
        };

        // --- Inicializa la Aplicación basada en el Taller ---
        function initApp(workshopName) {
            currentWorkshop = workshopName;
            mainPageTitle.textContent = workshopDisplayNames[workshopName]; // Establece el H1 principal al nombre del taller
            reportSubtitle.style.display = 'block'; // Muestra el subtítulo "REPORTE"
            
            // Actualiza la referencia de la colección de Firestore
            if (db && userId) {
                dataCollectionRef = collection(db, `/artifacts/${appId}/public/data/${currentWorkshop.toLowerCase()}_registros`);
                populateEquipoDropdown(); // Vuelve a poblar los dropdowns para el nuevo taller
                loadData(); // Carga los datos específicos del nuevo taller
            } else {
                console.warn("Firebase DB o userId no están listos. No se puede inicializar la colección.");
            }

            showFormView(); // Muestra la vista del formulario
        }

        // --- Popula las Tarjetas de Taller (Menú) ---
        function populateWorkshopCards() {
            workshopSelectionView.innerHTML = ''; // Limpia las tarjetas existentes
            let workshopsToDisplay = [];

            if (loggedInUser === "ARGOS") {
                workshopsToDisplay = allWorkshops; // ARGOS ve todos los talleres
            } else {
                // Otros usuarios solo ven su taller específico
                if (allWorkshops.includes(loggedInUser)) {
                    workshopsToDisplay = [loggedInUser];
                }
            }

            workshopsToDisplay.forEach(workshop => {
                const card = document.createElement('div');
                card.className = `
                    bg-gray-50 rounded-lg shadow-md p-4 flex flex-col items-center justify-center
                    cursor-pointer hover:bg-blue-50 hover:shadow-lg transition ease-in-out duration-150
                    border border-gray-200
                `;
                card.dataset.workshop = workshop;
                card.addEventListener('click', () => initApp(workshop));

                const img = document.createElement('img');
                // IMPORTANTE: Usa las rutas de tus imágenes reales. Si están en la misma carpeta que index.html, usa solo el nombre del archivo.
                // Por ejemplo: img.src = "image_6f2c09.png";
                if (workshop === "KAEL") img.src = "image_7a6b82.png"; // Reemplaza con tu imagen real de KAEL
                else if (workshop === "ABFREN") img.src = "image_7a7668.png"; // Reemplaza con tu imagen real de ABFREN
                else if (workshop === "SOMEC") img.src = "image_7a76a4.png"; // Reemplaza con tu imagen real de SOMEC
                else if (workshop === "DRACSO") img.src = "image_6f2c46.png"; // Reemplaza con tu imagen real de DRACSO
                else if (workshop === "JS OUT") img.src = "image_6f8a19.png"; // Reemplaza con tu imagen real de JS OUT
                else if (workshop === "MG") img.src = "image_6f9980.png"; // Reemplaza con tu imagen real de MG SOL
                else if (workshop === "SIMIYP") img.src = "image_6fa080.png"; // Reemplaza con tu imagen real de SIMIYP
                else if (workshop === "SERVII") img.src = "image_6eb83d.png"; // Reemplaza con tu imagen real de SERVII
                else img.src = workshopImages[workshop].src; // Fallback a marcador de posición si es necesario

                img.alt = workshopImages[workshop].alt;
                img.className = 'w-24 h-24 object-contain mb-3 rounded-md'; 

                const name = document.createElement('p');
                name.textContent = workshopDisplayNames[workshop]; // Usa el nombre de visualización
                name.className = 'text-lg font-semibold text-gray-800 text-center';

                card.appendChild(img);
                card.appendChild(name);
                workshopSelectionView.appendChild(card);
            });
        }

        // --- Popula el Dropdown de Equipo ---
        function populateEquipoDropdown() {
            equipoSelect.innerHTML = '<option value="">Seleccione un Equipo</option>'; // Limpia opciones anteriores
            const currentEquiposData = allWorkshopsData[currentWorkshop];
            if (currentEquiposData) {
                for (const equipoName in currentEquiposData) {
                    const option = document.createElement('option');
                    option.value = equipoName;
                    option.textContent = equipoName;
                    equipoSelect.appendChild(option);
                }
            }
            // Reinicia los dropdowns dependientes
            conjuntoSelect.innerHTML = '<option value="">Seleccione un Conjunto</option>';
            conjuntoSelect.disabled = true;
            parteSelect.innerHTML = '<option value="">Seleccione una Parte</option>';
            parteSelect.disabled = true;
            textoEstandarSelect.innerHTML = '<option value="">Seleccione un Texto Estandar</option>'; 
            textoEstandarSelect.disabled = true; 
        }

        // --- Maneja el Dropdown de Conjunto Dependiente (basado en Equipo) ---
        equipoSelect.addEventListener('change', () => {
            const selectedEquipo = equipoSelect.value;
            conjuntoSelect.innerHTML = '<option value="">Seleccione un Conjunto</option>'; 
            conjuntoSelect.disabled = true; 
            parteSelect.innerHTML = '<option value="">Seleccione una Parte</option>'; 
            parteSelect.disabled = true; 
            textoEstandarSelect.innerHTML = '<option value="">Seleccione un Texto Estandar</option>'; 
            textoEstandarSelect.disabled = true; 

            const currentEquiposData = allWorkshopsData[currentWorkshop];
            if (selectedEquipo && currentEquiposData && currentEquiposData[selectedEquipo]) {
                for (const conjuntoName in currentEquiposData[selectedEquipo]) {
                    const option = document.createElement('option');
                    option.value = conjuntoName;
                    option.textContent = conjuntoName;
                    conjuntoSelect.appendChild(option);
                }
                conjuntoSelect.disabled = false; 
            }
        });

        // --- Maneja el Dropdown de Parte Dependiente (basado en Conjunto) ---
        conjuntoSelect.addEventListener('change', () => {
            const selectedEquipo = equipoSelect.value;
            const selectedConjunto = conjuntoSelect.value;
            parteSelect.innerHTML = '<option value="">Seleccione una Parte</option>'; 
            parteSelect.disabled = true; 
            textoEstandarSelect.innerHTML = '<option value="">Seleccione un Texto Estandar</option>'; 
            textoEstandarSelect.disabled = true; 

            const currentEquiposData = allWorkshopsData[currentWorkshop];
            if (selectedEquipo && selectedConjunto && currentEquiposData && 
                currentEquiposData[selectedEquipo] && currentEquiposData[selectedEquipo][selectedConjunto]) {
                // Itera sobre las claves (nombres de las partes) del objeto
                for (const parteName in currentEquiposData[selectedEquipo][selectedConjunto]) {
                    const option = document.createElement('option');
                    option.value = parteName;
                    option.textContent = parteName;
                    parteSelect.appendChild(option);
                }
                parteSelect.disabled = false; 
            }
        });

        // --- Maneja el Dropdown de Texto Estandar (basado en Parte) ---
        parteSelect.addEventListener('change', () => {
            const selectedEquipo = equipoSelect.value;
            const selectedConjunto = conjuntoSelect.value;
            const selectedParte = parteSelect.value;
            textoEstandarSelect.innerHTML = '<option value="">Seleccione un Texto Estandar</option>'; 
            textoEstandarSelect.disabled = true; 

            const currentEquiposData = allWorkshopsData[currentWorkshop];
            if (selectedEquipo && selectedConjunto && selectedParte && currentEquiposData && 
                currentEquiposData[selectedEquipo] && currentEquiposData[selectedEquipo][selectedConjunto] &&
                currentEquiposData[selectedEquipo][selectedConjunto][selectedParte]) {
                
                const textoEstandarOptions = currentEquiposData[selectedEquipo][selectedConjunto][selectedParte];
                textoEstandarOptions.forEach(text => {
                    const option = document.createElement('option');
                    option.value = text;
                    option.textContent = text;
                    textoEstandarSelect.appendChild(option);
                });
                textoEstandarSelect.disabled = false; 
            }
        });


        // --- Carga de Datos desde Firestore (en tiempo real) ---
        function loadData() {
            if (unsubscribeSnapshot) {
                unsubscribeSnapshot(); // Cancela la escucha anterior si existe
            }
            if (!dataCollectionRef) {
                console.warn("dataCollectionRef no está definido. Esperando autenticación y selección de taller.");
                dataTableBody.innerHTML = `
                    <tr>
                        <td colspan="12" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">Esperando conexión a la base de datos y selección de taller...</td>
                    </tr>
                `;
                return;
            }
            unsubscribeSnapshot = onSnapshot(dataCollectionRef, (snapshot) => {
                dataTableBody.innerHTML = '';
                if (snapshot.empty) {
                    dataTableBody.innerHTML = `
                        <tr>
                            <td colspan="12" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">No hay datos registrados para ${workshopDisplayNames[currentWorkshop]}.</td>
                        </tr>
                    `;
                    return;
                }
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${data.equipo || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.fecha || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.otOrigen || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.conjunto || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.parte || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.textoEstandar || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.descripcionDetallada || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.prioridad || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.tecnico || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.telefono || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${data.fotoUrl ? `<a href="${data.fotoUrl}" target="_blank" class="text-blue-600 hover:underline">Ver Foto</a>` : (data.fotoName || 'N/A')}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-id="${doc.id}" class="delete-btn px-4 py-2 bg-customGreen text-customBlue font-semibold rounded-md shadow-md hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-customGreen focus:ring-offset-2 transition ease-in-out duration-150">Eliminar</button>
                        </td>
                    `;
                    dataTableBody.appendChild(row);
                });
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const docId = e.target.dataset.id;
                        // Usar console.log en lugar de confirm()
                        console.log('Intento de eliminar registro con ID:', docId);
                        // En una aplicación real, aquí deberías implementar un modal de confirmación personalizado
                        // antes de llamar a deleteDoc.
                        try {
                            await deleteDoc(doc(db, `/artifacts/${appId}/public/data/${currentWorkshop.toLowerCase()}_registros`, docId));
                            console.log('Documento eliminado con éxito:', docId);
                        } catch (error) {
                            console.error('Error al eliminar documento:', error);
                        }
                    });
                });
            }, (error) => {
                console.error("Error al cargar datos de Firestore:", error);
                dataTableBody.innerHTML = `
                    <tr>
                        <td colspan="12" class="px-6 py-4 whitespace-nowrap text-center text-sm text-red-500">Error al cargar datos.</td>
                    </tr>
                `;
            });
        }

        // --- Manejador de Envío de Formulario ---
        dataForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(dataForm);
            const data = {};
            for (const [key, value] of formData.entries()) {
                data[key] = value;
            }

            const fotoInput = document.getElementById('foto');
            if (fotoInput.files.length > 0) {
                const file = fotoInput.files[0];
                const storageRef = ref(storage, `fotos/${currentWorkshop}/${file.name}_${new Date().getTime()}`);
                try {
                    const snapshot = await uploadBytes(storageRef, file);
                    data.fotoUrl = await getDownloadURL(snapshot.ref);
                    data.fotoName = file.name;
                    console.log('Foto subida con éxito:', data.fotoUrl);
                } catch (error) {
                    console.error('Error al subir la foto:', error);
                    alert('Error al subir la foto. Inténtalo de nuevo.'); // Mantener alerta para errores de subida
                    return; // No guardar el registro si la foto no se subió
                }
            } else {
                data.fotoName = '';
                data.fotoUrl = '';
            }

            data.timestamp = new Date().toISOString();

            if (dataCollectionRef) {
                try {
                    await addDoc(dataCollectionRef, data);
                    console.log('Registro guardado con éxito:', data);
                    dataForm.reset();
                    populateEquipoDropdown(); // Reinicia los dropdowns del formulario
                    // No hay alerta de éxito, ya que la tabla se actualizará automáticamente
                } catch (error) {
                    console.error('Error al guardar registro:', error);
                    alert('Error al guardar el registro. Por favor, inténtalo de nuevo.'); // Mantener alerta para errores de guardado
                }
            } else {
                console.error("dataCollectionRef no está definido. No se puede guardar el registro.");
                alert('No se pudo guardar el registro. La base de datos no está lista.'); // Mantener alerta para errores de base de datos
            }
        });

        // --- Manejador de Descarga de Excel ---
        downloadExcelBtn.addEventListener('click', async () => {
            if (!dataCollectionRef) {
                console.warn("dataCollectionRef no está definido. No se puede descargar Excel.");
                alert('La base de datos no está lista para descargar el Excel.');
                return;
            }
            try {
                const querySnapshot = await getDocs(dataCollectionRef);
                const dataToExport = [];
                querySnapshot.forEach((doc) => {
                    dataToExport.push(doc.data());
                });

                if (dataToExport.length === 0) {
                    alert('No hay datos para exportar a Excel.');
                    return;
                }

                const ws = XLSX.utils.json_to_sheet(dataToExport);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Reporte");
                XLSX.writeFile(wb, `${currentWorkshop}_Reporte.xlsx`);
                console.log('Datos exportados a Excel con éxito.');
            } catch (error) {
                console.error('Error al descargar Excel:', error);
                alert('Error al descargar el archivo Excel. Por favor, inténtalo de nuevo.');
            }
        });

        // --- Manejador del Botón Volver al Menú ---
        backToMenuBtn.addEventListener('click', () => {
            showWorkshopSelectionView(); // Vuelve a la selección de taller
        });

        // Configuración inicial cuando la página se carga
        // showLoginView(); // Ya se llama en window.onload, manejado por onAuthStateChanged
    </script>
</body>
</html>