<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REPORTE por Taller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('FONDO.png');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            background-color: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }
        @media (min-width: 640px) {
            body { padding: 1.5rem; }
        }
        @media (min-width: 768px) {
            body { padding: 2rem; }
        }
        .container {
            max-width: 900px;
            background-color: rgba(255, 255, 255, 0.4);
            width: 100%;
        }
        .container.transparent-bg {
            background-color: transparent;
            box-shadow: none;
            border: none;
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        body.align-top-content {
            align-items: flex-start;
        }
        body.align-top-content .container {
            margin-top: 2rem;
            margin-bottom: auto;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        customGreen: '#65A30D',
                        customBlue: '#1E3A8A',
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="loginView" class="flex flex-col items-center justify-center p-8 w-full">
        <div class="border border-black rounded-lg p-6 shadow-xl bg-white max-w-sm w-full mx-auto">
            <img id="loginTruckImage" src="CAMION.png" alt="Camión Argos" class="w-48 h-auto mx-auto mb-6 rounded-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Iniciar Sesión</h2>
            <div class="w-full">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
                    <input type="text" id="username" name="username" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                    <input type="password" id="password" name="password" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <button id="loginBtn"
                        class="w-full px-6 py-3 bg-customGreen text-customBlue font-semibold rounded-md shadow-md hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-customGreen focus:ring-offset-2 transition ease-in-out duration-150">
                    INGRESAR
                </button>
                <p id="loginError" class="text-red-600 text-center mt-4" style="display: none;"></p>
            </div>
        </div>
    </div>

    <div id="appContainer" class="container mx-auto bg-white p-6 rounded-lg shadow-lg" style="display: none;">
        <div class="relative flex items-center justify-center mb-8">
            <div id="leftHeaderElements" class="absolute left-0 flex items-center space-x-2" style="display: none;">
                <button id="backToMenuBtn" class="px-4 py-2 bg-customGreen text-customBlue font-semibold rounded-md shadow-md hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-customGreen focus:ring-offset-2 transition ease-in-out duration-150">
                    ATRAS
                </button>
            </div>
            <h1 id="mainPageTitle" class="text-3xl font-bold text-gray-800 text-center
                bg-white bg-opacity-70 rounded-md px-4 py-2"></h1>
            <div id="rightHeaderElements" class="absolute right-0 flex items-center space-x-2" style="display: none;">
                <button id="logoutBtn" class="px-4 py-2 bg-customGreen text-customBlue font-semibold rounded-md shadow-md hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-customGreen focus:ring-offset-2 transition ease-in-out duration-150">
                    Cerrar Sesión
                </button>
            </div>
        </div>
        <h2 id="reportSubtitle" class="text-xl font-semibold text-center text-gray-600 mb-8" style="display: none;">REPORTE</h2>

        <div id="workshopSelectionView" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-8" style="display: none;">
            </div>

        <div id="formView" style="display: none;">
            <form id="dataForm" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div>
                    <label for="equipo" class="block text-sm font-medium text-gray-700 mb-1">EQUIPO *</label>
                    <select id="equipo" name="equipo" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="">Seleccione un Equipo</option>
                    </select>
                </div>

                <div>
                    <label for="fecha" class="block text-sm font-medium text-gray-700 mb-1">FECHA *</label>
                    <input type="date" id="fecha" name="fecha" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>

                <div>
                    <label for="otOrigen" class="block text-sm font-medium text-gray-700 mb-1">OT ORIGEN *</label>
                    <input type="number" id="otOrigen" name="otOrigen" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                           value="0">
                </div>

                <div>
                    <label for="conjunto" class="block text-sm font-medium text-gray-700 mb-1">CONJUNTO *</label>
                    <select id="conjunto" name="conjunto" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                            disabled>
                        <option value="">Seleccione un Conjunto</option>
                    </select>
                </div>

                <div>
                    <label for="parte" class="block text-sm font-medium text-gray-700 mb-1">PARTE *</label>
                    <select id="parte" name="parte" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                            disabled>
                        <option value="">Seleccione una Parte</option>
                    </select>
                </div>

                <div>
                    <label for="prioridad" class="block text-sm font-medium text-gray-700 mb-1">PRIORIDAD *</label>
                    <select id="prioridad" name="prioridad" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="">Seleccione una Prioridad</option>
                        <option value="Alta">Alta</option>
                        <option value="Media">Media</option>
                        <option value="Baja">Baja</option>
                    </select>
                </div>

                <div class="md:col-span-2">
                    <label for="textoEstandar" class="block text-sm font-medium text-gray-700 mb-1">TEXTO ESTANDAR *</label>
                    <select id="textoEstandar" name="textoEstandar" required disabled
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="">Seleccione un Texto Estandar</option>
                    </select>
                </div>

                <div class="md:col-span-2">
                    <label for="descripcionDetallada" class="block text-sm font-medium text-gray-700 mb-1">DESCRIPCION DETALLADA *</label>
                    <textarea id="descripcionDetallada" name="descripcionDetallada" rows="3" required
                              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                </div>

                <div>
                    <label for="tecnico" class="block text-sm font-medium text-gray-700 mb-1">TECNICO *</label>
                    <input type="text" id="tecnico" name="tecnico" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>

                <div>
                    <label for="telefono" class="block text-sm font-medium text-gray-700 mb-1">TELEFONO *</label>
                    <input type="text" id="telefono" name="telefono" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>

                <div>
                    <label for="foto" class="block text-sm font-medium text-gray-700 mb-1">FOTO</label>
                    <input type="file" id="foto" name="foto" class="hidden" accept="image/*">
                    <label for="foto"
                           class="inline-flex items-center px-6 py-3 bg-customGreen text-customBlue font-semibold rounded-md shadow-md hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-customGreen focus:ring-offset-2 transition ease-in-out duration-150 cursor-pointer">
                        Añadir Foto
                    </label>
                    <p class="mt-1 text-xs text-gray-500">Nota: La carga de archivos grandes no es compatible con el almacenamiento local.</p>
                </div>

                <div class="md:col-span-2 flex justify-center space-x-4">
                    <button type="submit" id="saveRecordBtn"
                            class="px-6 py-3 bg-customGreen text-customBlue font-semibold rounded-md shadow-md hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-customGreen focus:ring-offset-2 transition ease-in-out duration-150">
                        Guardar Registro
                    </button>
                    <button type="button" id="cancelEditBtn" style="display:none;"
                            class="px-6 py-3 bg-gray-300 text-gray-800 font-semibold rounded-md shadow-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition ease-in-out duration-150">
                        Cancelar Edición
                    </button>
                </div>
            </form>

            <hr class="my-8 border-gray-300">

            <h3 class="text-2xl font-bold text-center text-gray-800 mb-6">Datos de REPORTE</h3>

            <div class="flex justify-center mb-6">
                <button id="downloadExcel"
                        class="px-6 py-3 bg-customGreen text-customBlue font-semibold rounded-md shadow-md hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-customGreen focus:ring-offset-2 transition ease-in-out duration-150">
                    Descargar Excel
                </button>
            </div>

            <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200 w-full">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Equipo</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">OT Origen</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conjunto</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parte</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Texto Estandar</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción Detallada</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prioridad</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Técnico</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teléfono</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Foto (Nombre)</th>
                            <th scope="col" class="relative px-6 py-3">
                                <span class="sr-only">Acciones</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="12" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">Cargando datos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import * as XLSX from "https://cdn.sheetjs.com/xlsx-0.20.2/package/xlsx.mjs";
        window.XLSX = XLSX;

        const SUPABASE_URL = 'https://txpezttlhtxjkwtfehme.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4cGV6dHRsaHR4amt3dGZlaG1lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwNzA1MDcsImV4cCI6MjA2OTY0NjUwN30.74iEuQQfSvlu36lbfd78e8aM6vFcZUkA7ab0oWT9yGI'; 
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let loggedInUser = null;
        let currentWorkshop = '';
        let editingRecord = null; 

        // --- DOM Elements ---
        const appContainer = document.getElementById('appContainer');
        const mainPageTitle = document.getElementById('mainPageTitle');
        const reportSubtitle = document.getElementById('reportSubtitle');
        const loginView = document.getElementById('loginView');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logoutBtn');
        const leftHeaderElements = document.getElementById('leftHeaderElements');
        const rightHeaderElements = document.getElementById('rightHeaderElements');
        const dataForm = document.getElementById('dataForm');
        const equipoSelect = document.getElementById('equipo');
        const conjuntoSelect = document.getElementById('conjunto');
        const parteSelect = document.getElementById('parte');
        const textoEstandarSelect = document.getElementById('textoEstandar');
        const dataTableBody = document.getElementById('dataTableBody');
        const downloadExcelBtn = document.getElementById('downloadExcel');
        const workshopSelectionView = document.getElementById('workshopSelectionView');
        const formView = document.getElementById('formView');
        const backToMenuBtn = document.getElementById('backToMenuBtn');
        const loginTruckImage = document.getElementById('loginTruckImage');
        const saveRecordBtn = document.getElementById('saveRecordBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');

        const allWorkshops = ["KAEL", "ABFREN", "SOMEC", "DRACSO", "JS OUT", "MG", "SIMIYP", "SERVII", "ARGOS"];
        const workshopDisplayNames = {
            "KAEL": "KAEL", "ABFREN": "ABFREN", "SOMEC": "SOMEC", "DRACSO": "DRACSO",
            "JS OUT": "JS OUT", "MG": "MG SOL", "SIMIYP": "SIMIYP", "SERVII": "SERVII", "ARGOS": "ARGOS"
        };
        const workshopImagePaths = {
            "KAEL": "LOGOKAEL.jpg", "ABFREN": "LOGOABFREN.png", "SOMEC": "LOGOSOMEC.png",
            "DRACSO": "LOGODRACSO.png", "JS OUT": "LOGOJS.png", "MG": "LOGOMG.png",
            "SIMIYP": "LOGOSIMIYP.png", "SERVII": "LOGOSERVICIO.png", "ARGOS": "LOGOARGOS.jpg"
        };

        const parteToTextoEstandarMap = {
            "Accesorios": ["CAMBIAR TAPETES CABINA", "REPARAR TOMA ELEC 12V CABINA", "CAMBIAR CINTA DE TIMON", "CAMBIAR INTERRUPTOR CRUCERO TIMON", "CAMBIAR INTERRUPTOR DER TIMON", "CAMBIAR TAPA CABRILLA O TIMON", "CAMBIAR ACCESORIOS CABINA", "CAMBIAR GUARDAMOTOR DERECHO", "INSTALAR CAMARA DE VIDEO REVERSA", "REPARAR CAMARA DE VIDEO REVERSA", "CAMBIAR GUARDAMOTOR IZQUIERDO", "CAMBIAR PITO CIUDAD", "CAMBIAR PITO CABINA", "CAMBIAR ALARMA REVERSA", "CAMBIAR PITO CARRETERA", "CAMBIAR VENTILADOR ENFRIADOR", "CAMBIAR ACCESORIOS MOTOR", "CAMBIAR PTO SWITCH", "CAMBIAR TUBO SUC DEF SIS POSTRATAMIENTO", "REPARAR SISTEMA POSTRATAMIENTO", "CAMBIAR BOMBA SISTEMA POSTRATAMIENTO"],
            "Aire_acondicionado": ["CAMBIAR FILTRO DE CABINA A/C", "CAMBIAR SENSOR DE TEMPERATURA A/C", "CAMBIAR VALVULA EXPANSION A/C", "MANTENIMIENTO A/C TIPO A", "REPARAR CONDENSADOR", "REPARAR A/C", "MANTENIMIENTO A/C TIPO B", "CAMBIAR CORREA COMPRESOR A/C", "CAMBIAR BLOWER A/C", "CAMBIAR COMPRESOR A/C", "CAMBIAR CONDENSADOR A/C", "REPARAR EVAPORADOR", "CAMBIAR EVAPORADOR A/C", "CAMBIAR BLOWER A-C", "CAMBIAR COMPRESOR A-C", "CAMBIAR CONDENSADOR A-C", "CAMBIAR CORREA COMPRESOR A-C", "CAMBIAR EVAPORADOR A-C", "CAMBIAR FILTRO DE CABINA A-C", "CAMBIAR SENSOR DE TEMPERATURA A-C", "CAMBIAR VALVULA EXPANSION A-C", "MANTENIMIENTO A-C TIPO A", "MANTENIMIENTO A-C TIPO B", "MANTENIMIENTO PREVENTIVO A-C", "REPARAR A-C"],
            "Cabina": ["CAMBIAR TAPETES", "CAMBIAR ESCOTILLA TRASERA CABINA", "REPARAR FILTRACION VIDRIO TRASERO", "REPARAR TAPIZADO TECHO", "CAMBIAR EMPAQUE PALANCA CAMBIOS", "REPARAR LUZ DE TECHO", "LODERA DELANTERA DERECHA", "LODERA DELANTERA IZQUIERDA", "CAMBIAR GUARDAPOLVO", "PANEL INFERIOR DERECHO", "PANEL INFERIOR IZQUIERDO CABINA MOTOR", "REPARAR FIBRA CABINA", "REPARAR LATONERIA CABINA", "INSONORIZAR CABINA", "CAMBIAR SISTEMA PEDAL ACELERACION", "PINTAR CABINA", "CAMBIAR GUARDAPOLVO DER", "CAMBIAR GUARDAPOLVO IZQ", "CAMBIAR LODERA DELANTERA DERECHA", "CAMBIAR LODERA DELANTERA IZQUIERDA", "CAMBIAR PANEL INF IZQ CABINA MOTOR", "CAMBIAR PANEL INFERIOR DERECHO", "REPARAR FIBRA CAPOT"],
            "Capot": ["REPARAR GUAYA DE CAPOT", "CAMBIAR BISAGRAS CAPOT", "CAMBIAR CABLE ACERO CAPOT", "CAMBIAR REJILLA AIRE CAPOT IZQ", "CAMBIAR TOPES CAPOT", "CAMBIAR AMORTIGUADOR CAPOT", "CAMBIAR SEGURO CAPOT", "INSTALAR GUARDAPOLVO LADO DERECHO", "INSTALAR GUARDAPOLVO LADO IZQUIERDO", "CAMBIAR BISEL LADO DERECHO", "CAMBIAR BISEL LADO IZQUIERDO", "REPARAR FIBRA CAPOT", "CAMBIAR SOPORTES CAPOT", "CAMBIAR BISEL CAPOT DERECHO", "CAMBIAR BISEL CAPOT IZQUIERDO"],
            "Chapa": ["CAMBIAR BISEL CHAPA PUERTA DER", "CAMBIAR BISEL CHAPA PUERTA IZQ", "CAMBIAR CILINDRO DE CERRADURA", "CAMBIAR CHAPA PUERTA", "REPARAR CILINDRO DE CERRADURA", "CAMBIAR CHAPA PUERTA DER", "CAMBIAR CHAPA PUERTA IZQ"],
            "Cinturón seguridad": ["REPARAR CINTURON DE SEGURIDAD", "CAMBIAR CINTURON SEGURIDAD", "CAMBIAR CINTURÓN SEGURIDAD DER", "CAMBIAR CINTURÓN SEGURIDAD IZQ"],
            "Espejo": ["CAMBIAR ESPEJO CAPOT IZQUIERDO POS5", "CAMBIAR ESPEJO CAPOT DERECHO POS6", "CAMBIAR SOPORTE DEL ESPEJO POS7", "CAMBIAR ESPEJO DERECHO PEQUEÑO POS4", "CAMBIAR ESPEJO IZQUIERDO GRANDE POS1", "CAMBIAR ESPEJO DERECHO GRANDE POS3", "ESPEJO SUPERIOR DE CABINA TECHO POS7", "CAMBIAR ESPEJO IZQUIERDO PEQUEÑO POS2", "CAMBIAR ESPEJO DER GRANDE POS3 CON MARCO", "CAMBIAR ESPEJO IZQ GRANDE POS1 CON MARCO", "CAMBIAR ESPEJO RETROVISOR", "CAMBIAR ESPEJO SUP CABINA TECHO POS7"],
            "Estribo": ["REPARAR ESTRIBO O PELDAÑO", "CAMBIAR ESTRIBO O PELDAÑO SUPERIOR", "CAMBIAR ESTRIBO O PELDAÑO INFERIOR", "CAMBIAR ESTRIBO CABINA DER", "CAMBIAR ESTRIBO CABINA IZQ", "CAMBIAR ESTRIBO O PELDAÑO SUPERIOR"],
            "Limpia_vidrios": ["CAMBIAR PLUMILLAS LIMPIA VIDRIOS", "CAMBIAR TAPA DEPOSITO LIMPIA VIDRIOS", "CAMBIAR MANGUERA LIMPIAVIDRIOS", "CAMBIAR BOMBA LIMPIA VIDRIOS", "CAMBIAR BRAZOS LIMPIA VIDRIOS", "REPARAR SISTEMA LIMPIA VIDRIOS", "CAMBIAR MOTOR LIMPIA VIDRIOS", "CAMBIAR DEPOSITO LIMPIA VIDRIOS", "CAMBIAR TRAPECIO LIMPIA VIDRIOS", "CAMBIAR MOTOR LIMPIA VIDRIO"],
            "Panorámico": ["AJUSTAR SELLO PANORAMICO", "CAMBIAR PANORAMICO DERECHO MACK", "CAMBIAR PANORAMICO IZQUIERDO MACK", "CAMBIAR VIDRIO PANORAMICO", "CAMBIAR VIDRIO PANORÁMICO"],
            "Persiana": ["AJUSTAR O REPARAR PERSIANA", "CAMBIAR MARCO BISEL FAROLA DELANTERA DER", "CAMBIAR MARCO BISEL FAROLA DELANTERA IZQ", "CAMBIAR BISEL FIBRA INFERIOR FAROLA DER", "CAMBIAR BISEL FIBRA INFERIOR FAROLA IZQ", "CAMBIAR PERSIANA CAPOT"],
            "Puerta": ["AJUSTAR PUERTA", "CAMBIAR MANIJA INTERNA PUERTA", "CAMBIAR SENSOR PUERTA ABIERTA", "CAMBIAR CAUCHO DE LA PUERTA", "CAMBIAR MANIJA EXTERNA IZQUIERDA", "REPARAR MAQUINA ELEVAVIDRIOS", "CAMBIAR CERRADURA", "CAMBIAR BISAGRAS PUERTA", "CAMBIAR MANIJA EXTERNA DERECHA", "CAMBIAR KIT CILINDRO PUERTA STARTED", "CAMBIAR ACTUADOR SEGURO PUERTA", "REPARAR LATONERIA PUERTA", "CAMBIAR CARTERA INTERNA PUERTA IZQ", "CAMBIAR TAPIZADO PUERTA INTERNA", "CAMBIAR INTERRUPTOR PUERTA DER", "CAMBIAR INTERRUPTOR PUERTA IZQ", "CAMBIAR MAQUINA ELEVAVIDRIOS", "CAMBIAR MODULO ELEVAVIDRIOS", "AJUSTAR PUERTA IZQ", "AJUSTAR PUERTA DER", "CAMBIAR ACTUADOR SEGURO PUERTA DER", "CAMBIAR ACTUADOR SEGURO PUERTA IZQ", "CAMBIAR BISAGRAS PUERTA DER", "CAMBIAR BISAGRAS PUERTA IZQ", "CAMBIAR CAUCHO PUERTA DER", "CAMBIAR CAUCHO PUERTA IZQ", "CAMBIAR CERRADURA DER", "CAMBIAR CERRADURA IZQ", "CAMBIAR MANIJA EXTERNA PUERTA DER", "CAMBIAR MANIJA EXTERNA PUERTA IZQ", "CAMBIAR MANIJA INTERNA PUERTA DER", "CAMBIAR MANIJA INTERNA PUERTA IZQ", "CAMBIAR MAQUINA ELEVA VIDRIOS DER", "CAMBIAR MAQUINA ELEVA VIDRIOS IZQ", "CAMBIAR MODULO ELEVAVIDRIOS DER", "CAMBIAR MODULO ELEVAVIDRIOS IZQ", "CAMBIAR TAPIZADO PUERTA INTERNA DER", "CAMBIAR TAPIZADO PUERTA INTERNA IZQ", "REPARAR LATONERIA PUERTA DER", "REPARAR LATONERIA PUERTA IZQ"],
            "Silla": ["CAMBIAR COJIN SILLA", "CAMBIAR VALVULA O INTERRUPTOR SILLA", "REPARAR BASE SILLA", "CAMBIAR AMORTIGUADOR SILLA", "CAMBIAR TORNILLERIA BASE SILLA", "CAMBIAR VEJIGA ESPALDAR SILLA", "CAMBIAR BOMBONA SILLA", "REPARAR RIEL ASIENTO SILLA", "REPARAR TAPICERIA SILLA", "REPARAR ESPALDAR SILLA", "REPARAR SILLA", "CAMBIAR SILLA", "CAMBIAR AMORTIGUADOR SILLA DER", "CAMBIAR AMORTIGUADOR SILLA IZQ", "CAMBIAR BOMBONA SILLA DER", "CAMBIAR BOMBONA SILLA IZQ", "CAMBIAR COJÍN SILLA DER", "CAMBIAR COJÍN SILLA IZQ", "CAMBIAR TORNILLERIA BASE SILLA DER", "CAMBIAR TORNILLERIA BASE SILLA IZQ", "REPARAR BASE SILLA DER", "REPARAR BASE SILLA IZQ", "REPARAR ESPALDAR SILLA DER", "REPARAR ESPALDAR SILLA IZQ", "REPARAR RIEL ASIENTO SILLA DER", "REPARAR RIEL ASIENTO SILLA IZQ", "REPARAR SILLA DER", "REPARAR SILLA IZQ", "REPARAR TAPICERIA SILLA DER", "REPARAR TAPICERIA SILLA IZQ"],
            "Soporte cabina": ["CAMBIAR VEJIGA CABINA", "CAMBIAR VALVULA LEVANTE CABINA", "REPARAR O CAMBIAR SOPORTE", "CAMBIAR BUJES SOPORTES DE CABINA", "CAMBIAR AMORTIGUADORES CABINA", "CAMBIAR VÁLVULA LEVANTE CABINA"],
            "Tablero instrumentos": ["CAMBIAR LED DE TABLERO INSTRUMENTOS", "REPARAR TABLERO DE INSTRUMENTOS", "CAMBIAR ACRILICO TABLERO INSTRUMENTOS", "CAMBIAR SENSOR ODOMETRO", "CAMBIAR TABLERO DE INSTRUMENTOS"],
            "Tapicería": ["CAMBIAR TAPIZADO CABINA", "CAMBIAR TAPIZADO SILLA", "CAMBIAR TAPIZADO SILLA DER", "CAMBIAR TAPIZADO SILLA IZQ"],
            "Vidrio": ["CAMBIAR VIDRIO TRASERO", "CAMBIAR VIDRIO PUERTA", "CAMBIAR VIDRIO PUERTA DER", "CAMBIAR VIDRIO PUERTA IZQ"],
            "Caja_velocidades": ["CALIBRAR ELECTRONICAMENTE EMBRAGUE", "CAMBIAR ENFRIADOR ACEITE CAJA", "CAMBIAR RETENEDOR DE LA CAJA VEL", "REPARAR CAJA VELOCIDADES", "REPARAR SISTEMA PDL", "REPARAR TAPA SELECTOR CAMBIOS MDRIVE", "CAMBIAR RACORES CAJA M DRIVE", "CAMBIAR EMPAQUE TAPA CAJA", "CAMBIAR MANGUERA ENFRIADOR CAJA", "DESVARE EN OBRA Y/O VIA", "CAMBIAR PERA BARRA DE CAMBIOS", "CAMBIAR BUJES BARRA DE CAMBIOS", "CAMBIAR VENTILADOR EMBRAGUE", "REPARAR PISTON SELECTOR", "REPARAR SISTEMA PDL", "CAMBIAR ENFRIADOR ACEITE", "REPARAR ENFRIADOR CAJA DE VEL", "CAMBIAR RETENEDOR DE LA CAJA VEL", "CAMBIAR VALVULA O PISTOLA AIRE", "CAMBIAR VALVULA EXCLAVA", "RECTIFICAR TORNILLOS CAJA VEL", "CAMBIAR SINCRONIZADOR", "REPARAR CAJA"],
            "Disco embrague/clutch": ["CALIBRAR EMBRAGUE", "DESVARE EN OBRA Y/O VIA", "SUAVIZAR EMBRAGUE", "CAMBIAR O REPARAR DISCO CLUTH", "REMANUFACTURAR EMBRAGUE", "REPARAR EMBRAGUE", "CAMBIAR EMBRAGUE"],
            "Prensa": ["DESVARE EN OBRA Y/O VIA", "CAMBIAR O REPARAR PRENSA CLUTH"],
            "PTO": ["CAMBIAR O RING PTO", "DESVARE EN OBRA Y/O VIA", "REPARAR PTO"],
            "Rodillo": ["DESVARE EN OBRA Y/O VIA", "CAMBIAR RODILLO"],
            "Separador": ["DESVARE EN OBRA Y/O VIA", "CAMBIAR SEPARADOR"],
            "Válvula control pto": ["CAMBIAR VALVULA CONTROL PTO"],
            "Volante": ["DESVARE EN OBRA Y/O VIA", "CAMBIAR VOLANTE"],
            "Caja baterías": ["CAMBIAR SEGUROS TAPA BATERIAS", "REPARAR CAJA BATERIAS", "CAMBIAR TAPA CAJA BATERIAS", "CAMBIAR CAJA BATERIAS", "CAMBIAR SEGUROS TAPA BATERÍAS"],
            "Caja herramienta": ["CAMBIAR BISAGRAS CAJA HERRAMIENTA", "CAMBIAR PORTA CONOS", "CAMBIAR TAPA CAJA HERRAMIENTA", "CAMBIAR CAJA HERRAMIENTA", "REPARAR CAJA HERRAMIENTA O PORTA GALON"],
            "Carrocería": ["INSTALAR ROTULACION INTERNA EQUIPO", "INSTALAR ROTULO COMO CONDUZCO", "INSTALAR ROTULACION GENERAL", "REPARAR CARROCERIA"],
            "Defensa": ["INSTALAR NUMERO INTERNO DEFENSA DEL", "CAMBIAR CINTAS REFLECTIVAS", "REPARAR DEFENSA DELANTERA", "REPARAR DEFENSA TRASERA", "PINTAR DEFENSA TRASERA", "REPARAR BICICLETEROS", "CAMBIAR DEFENSA TRASERA", "INSTALAR BICICLETEROS", "CAMBIAR DEFENSA DELANTERA"],
            "Guardabarros": ["CAMBIAR LODERAS TRASERAS", "CAMBIAR CINTAS REFLECTIVAS", "AJUSTAR GUARDABARROS TRASEROS", "REPARAR Y PINTAR GUARDABARROS", "PINTAR GUARDABARROS", "CAMBIAR GUARDABARROS", "CAMBIAR GUARDABARROS DER", "CAMBIAR GUARDABARROS IZQ", "REPARAR Y PINTAR GUARDABARROS DER", "REPARAR Y PINTAR GUARDABARROS IZQ"],
            "Perfil chasis": ["INSPECCIONAR TECNICAMENTE CHASIS", "DESCONCRETAR CHASIS", "REPARAR SOBRE CHASIS", "INSTALAR GUARDA CARDAN PTO", "CAMBIAR TORNILLERIA SOBRECHASIS", "PINTAR CHASIS", "SOLDAR FISURA EN PERFIL DE CHASIS", "SANDBLASTEAR Y PINTAR CHASIS", "CAMBIAR SOBRE CHASIS", "PINTAR CHASIS"],
            "Porta extintor": ["CAMBIAR PORTA EXTINTOR", "REPARAR PORTA EXTINTOR"],
            "Porta_repuesto": ["CAMBIAR PORTA REPUESTO", "CAMBIAR CABLE ACERO PORTA REPUESTO", "REPARAR MALACATE"],
            "Puente_chasis": ["CAMBIAR BASE O SOPORTE STOPS TRASEROS", "DESVARE EN OBRA Y/O VIA", "REPARAR PUENTE DE CHASIS", "CAMBIAR PUENTE U DE CHASIS", "CAMBIAR PUENTE H DE CHASIS"],
            "Soporte tanques aire": ["CAMBIAR CABLES TANQUE DE AIRE", "CAMBIAR BASES TANQUES AIRE", "CAMBIAR BASES TANQUE AIRE"],
            "Tanque combustible": ["CAMBIAR TAPA TANQUE COMBUSTIBLE", "REPARAR TANQUE COMBUSTIBLE", "CAMBIAR ABRAZADERA TANQUE COMBUSTIBLE", "CAMBIAR SOPORTES TANQUE COMBUSTIBLE"],
            "Mando cabina": ["CAMBIAR SWITCH DE CABINA", "CAMBIO DE SWITCH DE CABINA", "REPARAR MANDO CABINA"],
            "Control remoto": ["REPARAR CONTROL DE GIRO DE OLLA", "INSTALAR TAPA CONTROL TRASERO", "DESVARE EN OBRA Y/O VIA", "REPARAR CONTROL REMOTO ALAMBRICO", "REPARAR CONTROL REMOTO INALAMBRICO", "CAMBIAR BASE CARGADOR DE CONTROL REMOTO", "CAMBIAR BOTON PARO DE EMERGENCIA", "INSTALAR CONTROL REMOTO INALAMBRICO", "CAMBIAR SWICTHE AUTOREVERSIBLE"],
            "Manómetro": ["CAMBIAR MANOMETRO", "DESVARE EN OBRA Y/O VIA"],
            "Módulo electrónico": ["LIMITAR VELOCIDAD A 60 KM POR HORA", "ESCANEAR MODULO ECM MOTOR", "DESVARE EN OBRA Y/O VIA", "ESCANEAR MODULO CABINA", "REPARAR MODULO CAJA VEL", "CAMBIAR TARJETA INTERFAZ GIRO OLLA", "CAMBIAR MODULO GIRO DE OLLA", "REPARAR MODULO GIRO DE OLLA", "CAMBIAR MODULO SELECTOR MARCHA MDRIVE", "REPARAR MODULO CABINA", "REPARAR MODULO EP", "CAMBIAR MODULO CABINA", "CAMBIAR MODULO MOTOR"],
            "Conector": ["PROTEGER CONECTOR SISTEMA CONTROL", "CAMBIAR CONECTOR", "DESVARE EN OBRA Y/O VIA", "CAMBIAR CONECTOR SISTEMA CONTROL"],
            "Alarma": ["CAMBIAR ALARMA REVERSA", "DESVARE EN OBRA Y/O VIA"],
            "Electroválvula": ["CAMBIAR SOLENOIDE ELECTROVALVULA", "DESVARE EN OBRA Y/O VIA", "CAMBIAR RELE SISTEMA ENFRIAMIENTO", "CAMBIAR EMPAQUE BLOQUE ELECTROVALVULA", "CAMBIAR ELECTROVALVULA", "INSTALAR LINEA STAR STOP", "CAMBIAR VALVULA RETENCION DE CANAL", "CAMBIAR SOLENOIDE DINACHUTA", "CAMBIAR KIT REPARACION VALVULA EP", "CAMBIAR TAPA VALVULA EP BOBINAS", "CAMBIAR VALVULA EP"],
            "Instrumentos": ["DESVARE EN OBRA Y/O VIA", "REPARAR INSTRUMENTO DE CONTROL", "CAMBIAR CAMARA DE REVERSA"],
            "Sensor": ["CAMBIAR SENSOR TEMPERATURA AMBIENTE", "CAMBIAR SENSOR DE VELOCIDAD", "CAMBIAR SENSOR EJE DE LEVAS", "CAMBIAR PERA SENSOR TEMPERATURA", "CAMBIAR SENSOR ABS DELANTERO", "CAMBIAR SENSOR ABS TRASERO", "CAMBIAR SENSOR BLOQUEO DIF TRASERO", "CAMBIAR SENSOR NIVEL UREA", "CAMBIAR SENSOR COMBUSTIBLE", "CAMBIAR SENSOR NIVEL REFRIGERANTE", "CAMBIAR SENSOR PEDAL CLUTH", "CAMBIAR SENSOR CONTRAPRESION DE ESCAPE", "CAMBIAR SENSOR DE OXIGENO", "CAMBIAR SENSOR NIVEL ACEITE CARTER", "CAMBIAR SENSOR PRESION DE ACEITE", "CAMBIAR SENSOR CONTADOR REVOLUCIONES", "CAMBIAR SENSOR NOX"],
            "Cableado": ["REPARAR SISTEMA CRUCERO ACELERACION OLLA", "REPARAR ARNES DE GIRO DE OLLA", "REPARAR ARNES DE CABINA", "REPARAR CABLEADO DE CONTROL", "CAMBIAR ARNES DE GIRO DE OLLA", "CAMBIAR TERMINALES DE BATERIA", "CAMBIAR CABLES DE BATERIA", "DESVARE EN OBRA Y/O VIA", "REPARAR O CAMBIAR CABLEADO"],
            "Cardán": ["SERVICIO ENGRASE QUINCENAL INHOUSE", "INSTALAR GRASERA", "CAMBIAR KIT GUARDAPOLVO DEL CARDAN", "DESVARE EN OBRA Y/O VIA", "CAMBIAR RODAMIENTO CENTRAL CARDAN PPAL", "CAMBIAR CRUCETAS CARDAN PPAL", "CAMBIAR BOTELLA DEL CARDAN", "CAMBIAR ESPIGA DEL CARDAN", "CAMBIAR ESPIGA Y BOTELLA CARDAN", "CAMBIAR EJE CARDAN PRINCIPAL", "CAMBIAR EJE CARDAN INTERDIFERENCIALES", "CAMBIAR EJE CARDAN INTERTROQUES", "ENGRASAR GENERAL (350 HR)", "ENGRASAR QUINCENAL INHOUSE", "INSTALAR GRASERA CARDAN MIXER", "CAMBIAR CRUCETAS CARDAN BOMBA"],
            "Cruceta": ["ENGRASE DE CRUCETA", "INSTALAR GRASERA", "DESVARE EN OBRA Y/O VIA", "CAMBIAR CRUCETA CARDAN PPAL", "CAMBIAR CRUCETA INTERDIFERENCIAL", "CAMBIAR CRUCETA EJE CARDAN", "ENGRASAR CRUCETA"],
            "Diferencial delantero": ["CAMBIAR FILTRO DE DIFERENCIAL", "CAMBIAR ACEITE DIFERENCIAL TRASERO", "CBM ALERTA ANALISIS DE ACEITE", "CORREGIR FUGA DIFERENCIAL DELANTERO", "DESVARE EN OBRA Y/O VIA", "MONTAR HOUSING DIFERENCIAL TRASERO", "DESMONTAR HOUSING DIFERENCIAL TRASERO", "TOMAR MUESTRA DE ACEITE DIF DEL MIX"],
            "Diferencial trasero": ["CAMBIAR ACEITE DIFERENCIAL TRASERO", "CAMBIAR KIT TRABA ANTIPATINAJE", "CAMBIAR MANGUERA SISTEMA ANTIPATINAJE", "CBM ALERTA ANALISIS DE ACEITE", "DESCONCRETAR DIFERENCIAL TRASERO", "DESVARE EN OBRA Y/O VIA", "CAMBIAR RETENEDOR DIFERENCIAL TRASERO", "REPARAR TRABA DIFERENCIAL TRASERO", "AJUSTAR DIFERENCIAL TRASERO", "CAMBIAR HOUSING TROQUE TRASERO", "TOMAR MUESTRA DE ACEIT DIF TRAS MIXER"],
            "Divisor potencia": ["HABITAR ANTIPATINAJE", "DESVARE EN OBRA Y/O VIA", "REPARAR DIVISOR POTENCIA", "CAMBIAR RETENEDOR DIVISOR POTENCIA"],
            "Eje": ["DESVARE EN OBRA Y/O VIA", "CAMBIAR EJE LATERAL", "CAMBIAR EJE DIF DERECHO", "CAMBIAR EJE DIF IZQUIERDO"],
            "Soporte": ["DESVARE EN OBRA Y/O VIA", "CAMBIAR SOPORTE CENTRAL EJE CARDAN", "CAMBIAR BARRA TENSORA", "CAMBIAR BUJES DE BARRA TENSORA", "CAMBIAR TORNILLO BARRA TENSORA"],
            "Válvula": ["CAMBIAR ELECTROVALVULA ANTIPATINAJE", "CAMBIAR VALVULA SISTEMA DIRECCION", "CAMBIAR VALVULA AIR BAG EJE AUX", "CAMBIAR VALVULA ESCAPE RAPIDO", "CAMBIAR VALVULA RELAY R12", "CAMBIAR VALVULA SECADOR", "DESVARE EN OBRA Y/O VIA", "CAMBIAR VALVULA ANTIRETORNO SIST FRENO", "CAMBIAR VALVULA PP1"],
            "Manguera": ["REPARAR O CAMBIAR MANGUERA", "CAMBIAR MANGUERA", "CAMBIAR MANGUERA DE ALTA PRESION"],
            "Suspensión": ["INSTALAR CAUCHO CABINA", "CAMBIAR BARRA TENSORA", "CAMBIAR BUJE BARRA TENSORA", "CAMBIAR VEJIGA NEUMATICA", "REPARAR SISTEMA SUSPENSION"],
            "Amortiguador": ["CAMBIAR AMORTIGUADOR", "REPARAR AMORTIGUADOR"],
            "Balancín": ["CAMBIAR BUJES DE BALANCIN", "REPARAR BALANCIN", "CAMBIAR BALANCIN"],
            "Barra": ["CAMBIAR BARRA ESTABILIZADORA", "CAMBIAR BUJES BARRA ESTABILIZADORA"],
            "Bujes": ["CAMBIAR BUJES DE BARRA ESTABILIZADORA", "CAMBIAR BUJES DE BALANCIN"],
            "Terminal": ["CAMBIAR TERMINAL DE DIRECCION", "CAMBIAR TERMINAL DE DIRECCION IZQUIERDA", "CAMBIAR TERMINAL DE DIRECCION DERECHA"],
            "Timón": ["CAMBIAR TIMON", "REPARAR SISTEMA DE TIMON"],
            "Freno": ["MANTENIMIENTO GENERAL FRENOS", "CAMBIAR KIT DE FRENOS", "CAMBIAR VALVULA DE FRENOS"],
            "Rueda": ["CAMBIAR TUERCAS DE RUEDA", "CAMBIAR RINES", "CAMBIAR LLANTA", "INFLAR LLANTAS", "REPARAR LLANTA"],
            "Neumático": ["REPARAR NEUMATICO", "CAMBIAR NEUMATICO"],
            "Neumáticos": ["REPARAR NEUMATICOS", "CAMBIAR NEUMATICOS"],
            "Placa": ["INSTALAR PLACA DE IDENTIFICACION", "REPARAR PLACA"],
            "Bomba": ["CAMBIAR BOMBA DE AGUA", "CAMBIAR BOMBA DE ACEITE", "REPARAR BOMBA HIDRAULICA"],
            "Filtro": ["CAMBIAR FILTRO DE AIRE", "CAMBIAR FILTRO DE ACEITE", "CAMBIAR FILTRO DE COMBUSTIBLE"],
            "Radiador": ["REPARAR RADIADOR", "CAMBIAR RADIADOR"],
            "Tubo": ["CAMBIAR TUBO DE ESCAPE", "REPARAR TUBO DE COMBUSTIBLE"],
            "Bomba de agua": ["CAMBIAR BOMBA DE AGUA"],
            "Bomba de combustible": ["CAMBIAR BOMBA de COMBUSTIBLE"],
            "Alternador": ["CAMBIAR ALTERNADOR", "REPARAR ALTERNADOR"],
            "Batería": ["CAMBIAR BATERIA", "RECARGAR BATERIA"],
            "Motor de arranque": ["CAMBIAR MOTOR DE ARRANQUE", "REPARAR MOTOR DE ARRANQUE"],
            "Distribución": ["CAMBIAR CORREA DE DISTRIBUCION", "CAMBIAR CADENA DE DISTRIBUCION"],
            "Bomba de dirección": ["CAMBIAR BOMBA DE DIRECCION HIDRAULICA"],
            "Caja de dirección": ["REPARAR CAJA DE DIRECCION"],
            "Silenciador": ["REPARAR SILENCIADOR", "CAMBIAR SILENCIADOR"],
            "Bomba de inyección": ["REPARAR BOMBA DE INYECCION"],
            "Inyector": ["CAMBIAR INYECTOR", "REPARAR INYECTOR"],
            "Turbo": ["CAMBIAR TURBO", "REPARAR TURBO"],
            "Correa": ["CAMBIAR CORREA DE ACCESORIOS", "CAMBIAR CORREA DE MOTOR"],
            "Ventilador": ["CAMBIAR VENTILADOR", "REPARAR VENTILADOR"],
            "Compresor": ["CAMBIAR COMPRESOR DE AIRE"],
            "Valvula de escape": ["CAMBIAR VALVULA DE ESCAPE"],
            "Valvula de admisión": ["CAMBIAR VALVULA DE ADMISION"],
            "Pistón": ["CAMBIAR PISTON"],
            "Anillos": ["CAMBIAR ANILLOS DEL PISTON"],
            "Biela": ["CAMBIAR BIELA"],
            "Cigueñal": ["REPARAR CIGUEÑAL"],
            "Empaques": ["CAMBIAR EMPAQUES"],
            "Culata": ["REPARAR CULATA"],
            "Bloque": ["REPARAR BLOQUE DE MOTOR"],
            "Soporte de motor": ["CAMBIAR SOPORTE DE MOTOR"],
            "Rodamiento": ["CAMBIAR RODAMIENTO"],
            "Aceite": ["CAMBIAR ACEITE DE MOTOR", "CAMBIAR ACEITE DE CAJA", "CAMBIAR ACEITE DE DIFERENCIAL"],
            "Líquido": ["CAMBIAR LIQUIDO DE FRENOS", "CAMBIAR REFRIGERANTE"],
            "Otros": ["OTRAS FALLAS"]
        };

        const conjutoToParteMap = {
            "Cabina": ["Accesorios", "Aire_acondicionado", "Cabina", "Capot", "Chapa", "Cinturón seguridad", "Espejo", "Estribo", "Limpia_vidrios", "Panorámico", "Persiana", "Puerta", "Silla", "Soporte cabina", "Tablero instrumentos", "Tapicería", "Vidrio"],
            "Clutch": ["Caja_velocidades", "Disco embrague/clutch", "Prensa", "PTO", "Rodillo", "Separador", "Válvula control pto", "Volante"],
            "Chasis": ["Caja baterías", "Caja herramienta", "Carrocería", "Defensa", "Guardabarros", "Perfil chasis", "Porta extintor", "Porta_repuesto", "Puente_chasis", "Soporte tanques aire", "Tanque combustible"],
            "Electronica": ["Mando cabina", "Control remoto", "Manómetro", "Módulo electrónico", "Conector", "Alarma", "Electroválvula", "Instrumentos", "Sensor", "Cableado"],
            "Transmisión": ["Cardán", "Cruceta", "Diferencial delantero", "Diferencial trasero", "Divisor potencia", "Eje", "Soporte", "Válvula"],
            "Suspensión": ["Manguera", "Suspensión", "Amortiguador", "Balancín", "Barra", "Bujes", "Terminal"],
            "Neumáticos": ["Timón", "Freno", "Rueda", "Neumático", "Neumáticos"],
            "Motor": ["Placa", "Bomba", "Filtro", "Radiador", "Tubo", "Bomba de agua", "Bomba de combustible", "Alternador", "Batería", "Motor de arranque", "Distribución", "Bomba de dirección", "Caja de dirección", "Silenciador", "Bomba de inyección", "Inyector", "Turbo", "Correa", "Ventilador", "Compresor", "Valvula de escape", "Valvula de admisión", "Pistón", "Anillos", "Biela", "Cigueñal", "Empaques", "Culata", "Bloque", "Soporte de motor", "Rodamiento", "Aceite", "Líquido", "Otros"]
        };

        const equipos = ["G1", "G2", "G3", "G4", "G5", "G6", "G7", "G8", "G9", "G10", "G11", "G12", "G13", "G14", "G15", "G16", "G17", "G18", "G19", "G20"];
        
        function showLogin() {
            loginView.style.display = 'flex';
            appContainer.style.display = 'none';
        }

        async function showApp(user) {
            // Manejamos el caso en que el usuario es nulo, para evitar el error.
            if (!user) {
                console.log("showApp fue llamado con un usuario nulo. Mostrando la vista de inicio de sesión.");
                showLogin();
                return;
            }

            loggedInUser = user ? user.user_metadata.workshop : null;
            console.log("showApp called. Logged in user:", loggedInUser);

            if (loggedInUser) {
                loginView.style.display = 'none';
                appContainer.style.display = 'block';
                document.body.classList.add('align-top-content');
                appContainer.classList.remove('transparent-bg');
                rightHeaderElements.style.display = 'flex';
                
                if (loggedInUser === 'admin') {
                    mainPageTitle.textContent = "TODOS LOS REPORTES";
                    leftHeaderElements.style.display = 'none';
                    reportSubtitle.style.display = 'none';
                    workshopSelectionView.style.display = 'none';
                    formView.style.display = 'block';
                } else {
                    currentWorkshop = loggedInUser;
                    mainPageTitle.textContent = workshopDisplayNames[currentWorkshop];
                    leftHeaderElements.style.display = 'flex';
                    reportSubtitle.style.display = 'block';
                    workshopSelectionView.style.display = 'none';
                    formView.style.display = 'block';
                    resetForm();
                }
                loadReports();
            } else {
                console.log("No logged in user. Showing login view.");
                showLogin();
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!username || !password) {
                loginError.textContent = 'Por favor, ingrese un usuario y contraseña.';
                loginError.style.display = 'block';
                return;
            }

            loginBtn.textContent = 'Cargando...';
            loginBtn.disabled = true;
            loginError.style.display = 'none';
            
            let email = `${username}@taller.com`; 
            if (username.toLowerCase() === 'argos') {
                email = 'argos@argos.com';
            }
            console.log("Attempting to sign in with email:", email);

            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email: email, password: password });

                if (error) {
                    console.error("Supabase sign-in error:", error);
                    loginError.textContent = 'Error: Usuario o contraseña incorrectos.';
                    loginError.style.display = 'block';
                } else {
                    console.log("Supabase sign-in successful. Data:", data);
                    // The onAuthStateChange listener will handle the rest.
                }
            } catch (err) {
                console.error("Unexpected error during login:", err);
                loginError.textContent = 'Ocurrió un error inesperado. Por favor, verifique su conexión a internet.';
                loginError.style.display = 'block';
            } finally {
                // Restore button state after the login attempt
                loginBtn.textContent = 'INGRESAR';
                loginBtn.disabled = false;
            }
        }

        async function handleLogout() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error("Error al cerrar sesión:", error);
            }
        }

        async function loadReports() {
            dataTableBody.innerHTML = '<tr><td colspan="12" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">Cargando datos...</td></tr>';
            let query = supabase.from('reports').select('*');

            if (loggedInUser !== 'admin') {
                query = query.eq('taller', loggedInUser);
            }

            const { data: reports, error } = await query.order('created_at', { ascending: false });

            if (error) {
                console.error("Error al cargar los reportes:", error);
                dataTableBody.innerHTML = '<tr><td colspan="12" class="px-6 py-4 whitespace-nowrap text-center text-sm text-red-500">Error al cargar los datos.</td></tr>';
            } else {
                renderTable(reports);
            }
        }
        
        async function renderTable(records) {
            dataTableBody.innerHTML = '';
            if (records && records.length > 0) {
                records.forEach(record => {
                    const row = document.createElement('tr');
                    const imgHtml = record.fotoUrl ? `<a href="${record.fotoUrl}" target="_blank" class="text-blue-600 hover:text-blue-800">${record.fotoUrl.split('/').pop()}</a>` : 'No foto';
                    const actionsHtml = loggedInUser !== 'admin' ? 
                        ` <button onclick="editRecord('${record.id}')" class="text-indigo-600 hover:text-indigo-900 mx-1">Editar</button>
                          <button onclick="deleteRecord('${record.id}')" class="text-red-600 hover:text-red-900 mx-1">Eliminar</button>`
                          : ``; 

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.equipo}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.fecha}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.otOrigen}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.conjunto}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.parte}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.textoEstandar}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.descripcionDetallada}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.prioridad}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.tecnico}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.telefono}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${imgHtml}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">${actionsHtml}</td>
                    `;
                    dataTableBody.appendChild(row);
                });
            } else {
                dataTableBody.innerHTML = '<tr><td colspan="12" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">No hay datos de reportes.</td></tr>';
            }
        }
        
        async function saveFormData(e) {
            e.preventDefault();
            const formData = new FormData(dataForm);
            const record = {
                equipo: formData.get('equipo'),
                fecha: formData.get('fecha'),
                otOrigen: formData.get('otOrigen'),
                conjunto: formData.get('conjunto'),
                parte: formData.get('parte'),
                prioridad: formData.get('prioridad'),
                textoEstandar: formData.get('textoEstandar'),
                descripcionDetallada: formData.get('descripcionDetallada'),
                tecnico: formData.get('tecnico'),
                telefono: formData.get('telefono'),
                taller: currentWorkshop,
            };

            const fotoFile = formData.get('foto');
            if (fotoFile && fotoFile.name) {
                const fotoPath = `${currentWorkshop}/${Date.now()}-${fotoFile.name}`;
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('reportefotos')
                    .upload(fotoPath, fotoFile);

                if (uploadError) {
                    console.error("Error al subir la foto:", uploadError);
                    alert("Error al subir la foto. Intente de nuevo.");
                    return;
                }
                const { data: urlData } = supabase.storage.from('reportefotos').getPublicUrl(fotoPath);
                record.fotoUrl = urlData.publicUrl;
            }

            if (editingRecord) {
                const { data, error } = await supabase
                    .from('reports')
                    .update(record)
                    .eq('id', editingRecord.id);

                if (error) {
                    console.error("Error al actualizar el registro:", error);
                    alert("Error al actualizar el registro.");
                } else {
                    console.log("Registro actualizado:", data);
                    resetForm();
                    loadReports();
                }
            } else {
                const { data, error } = await supabase
                    .from('reports')
                    .insert([record]);

                if (error) {
                    console.error("Error al guardar el registro:", error);
                    alert("Error al guardar el registro.");
                } else {
                    console.log("Registro guardado:", data);
                    resetForm();
                    loadReports();
                }
            }
        }

        async function editRecord(id) {
            const { data: record, error } = await supabase
                .from('reports')
                .select('*')
                .eq('id', id)
                .single();

            if (error) {
                console.error("Error al obtener el registro para editar:", error);
                return;
            }

            editingRecord = record;
            dataForm.equipo.value = record.equipo;
            dataForm.fecha.value = record.fecha;
            dataForm.otOrigen.value = record.otOrigen;

            populateConjuntoSelect(record.equipo);
            dataForm.conjunto.value = record.conjunto;
            populateParteSelect(record.conjunto);
            dataForm.parte.value = record.parte;
            populateTextoEstandarSelect(record.parte);
            dataForm.textoEstandar.value = record.textoEstandar;

            dataForm.prioridad.value = record.prioridad;
            dataForm.descripcionDetallada.value = record.descripcionDetallada;
            dataForm.tecnico.value = record.tecnico;
            dataForm.telefono.value = record.telefono;

            saveRecordBtn.textContent = 'Actualizar Registro';
            cancelEditBtn.style.display = 'inline-block';
        }

        async function deleteRecord(id) {
            if (confirm('¿Está seguro de que desea eliminar este registro?')) {
                const { error } = await supabase
                    .from('reports')
                    .delete()
                    .eq('id', id);

                if (error) {
                    console.error("Error al eliminar el registro:", error);
                    alert("Error al eliminar el registro.");
                } else {
                    console.log("Registro eliminado.");
                    loadReports();
                }
            }
        }
        
        function resetForm() {
            dataForm.reset();
            editingRecord = null;
            saveRecordBtn.textContent = 'Guardar Registro';
            cancelEditBtn.style.display = 'none';
        }

        function populateConjuntoSelect(equipo) {
            conjuntoSelect.disabled = !equipo;
            conjuntoSelect.innerHTML = `<option value="">Seleccione un Conjunto</option>`;
            if (equipo) {
                const conjuntos = Object.keys(conjutoToParteMap);
                conjuntos.forEach(conjunto => {
                    const option = document.createElement('option');
                    option.value = conjunto;
                    option.textContent = conjunto.replace(/_/g, ' ');
                    conjuntoSelect.appendChild(option);
                });
            }
            parteSelect.disabled = true;
            parteSelect.innerHTML = `<option value="">Seleccione una Parte</option>`;
            textoEstandarSelect.disabled = true;
            textoEstandarSelect.innerHTML = `<option value="">Seleccione un Texto Estandar</option>`;
        }
        
        function populateParteSelect(conjunto) {
            parteSelect.disabled = !conjunto;
            parteSelect.innerHTML = `<option value="">Seleccione una Parte</option>`;
            if (conjunto) {
                conjutoToParteMap[conjunto].forEach(parte => {
                    const option = document.createElement('option');
                    option.value = parte;
                    option.textContent = parte.replace(/_/g, ' ');
                    parteSelect.appendChild(option);
                });
            }
            textoEstandarSelect.disabled = true;
            textoEstandarSelect.innerHTML = `<option value="">Seleccione un Texto Estandar</option>`;
        }
        
        function populateTextoEstandarSelect(parte) {
            textoEstandarSelect.disabled = !parte;
            textoEstandarSelect.innerHTML = `<option value="">Seleccione un Texto Estandar</option>`;
            if (parte) {
                parteToTextoEstandarMap[parte].forEach(texto => {
                    const option = document.createElement('option');
                    option.value = texto;
                    option.textContent = texto;
                    textoEstandarSelect.appendChild(option);
                });
            }
        }
        
        // Event Listeners
        loginBtn.addEventListener('click', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        dataForm.addEventListener('submit', saveFormData);
        cancelEditBtn.addEventListener('click', resetForm);
        equipoSelect.addEventListener('change', (e) => populateConjuntoSelect(e.target.value));
        conjuntoSelect.addEventListener('change', (e) => populateParteSelect(e.target.value));
        parteSelect.addEventListener('change', (e) => populateTextoEstandarSelect(e.target.value));

        downloadExcelBtn.addEventListener('click', async () => {
            let query = supabase.from('reports').select('*');

            if (loggedInUser !== 'admin') {
                query = query.eq('taller', loggedInUser);
            }

            const { data: reports, error } = await query.order('created_at', { ascending: false });

            if (error) {
                console.error("Error al descargar los datos:", error);
                alert("Error al descargar los datos.");
                return;
            }

            if (reports && reports.length > 0) {
                const worksheet = XLSX.utils.json_to_sheet(reports);
                const workbook = { Sheets: { 'data': worksheet }, SheetNames: ['data'] };
                const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([excelBuffer], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `reportes-${currentWorkshop || 'todos'}.xlsx`;
                a.click();
                URL.revokeObjectURL(url);
            } else {
                alert("No hay datos para descargar.");
            }
        });

        // Este es el principal bloque de lógica.
        // El oyente de estado de autenticación se encarga de mostrar la vista correcta.
        supabase.auth.onAuthStateChange((event, session) => {
            console.log("onAuthStateChange event:", event);
            console.log("onAuthStateChange session:", session);
            if (session) {
                showApp(session.user);
            } else {
                showLogin();
            }
        });

        // Inicializa los selectores de equipo.
        equipos.forEach(equipo => {
            const option = document.createElement('option');
            option.value = equipo;
            option.textContent = equipo;
            equipoSelect.appendChild(option);
        });
    </script>
</body>
</html>
