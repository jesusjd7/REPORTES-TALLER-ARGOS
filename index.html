<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REPORTE por Taller</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Supabase CDN: La biblioteca para conectar tu app con Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Updated background image path to relative path */
            background-image: url('FONDO.png');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            background-color: #f3f4f6; /* Fallback color */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }
        @media (min-width: 640px) {
            body { padding: 1.5rem; }
        }
        @media (min-width: 768px) {
            body { padding: 2rem; }
        }

        .container {
            background-color: rgba(255, 255, 255, 0.9); /* Ligeramente transparente */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            padding: 2rem; /* p-8 */
            width: 100%;
            max-width: 28rem; /* max-w-sm (448px) */
            text-align: center;
        }

        /* Responsive adjustments for workshop cards */
        .workshop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); /* Adjust card size */
            gap: 1rem;
        }

        .workshop-card {
            border: 1px solid #e5e7eb; /* border-gray-200 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            background-color: #fff;
        }

        .workshop-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: translateY(-2px);
            border-color: #3b82f6; /* blue-500 */
        }

        .workshop-card img {
            max-width: 80px; /* Adjust logo size */
            height: auto;
            margin-bottom: 0.5rem;
        }

        .workshop-card.selected {
            border-color: #1d4ed8; /* blue-700 */
            background-color: #e0f2fe; /* blue-50 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Ensure content scrolls if too long for small screens */
        .form-container, .table-container {
            max-height: calc(100vh - 4rem); /* Adjust as needed */
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- Login View -->
    <div id="loginView" class="container">
        <!-- Imagen de Argos. Usamos una URL pública de Wikimedia para que funcione sin un archivo local. -->
        <img src="https://upload.wikimedia.org/wikipedia/commons/e/ee/Argos_logo.svg" alt="Argos Logo" class="mx-auto h-20 w-auto mb-6">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Iniciar Sesión</h2>
        <input type="email" id="usernameInput" placeholder="Correo electrónico" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        <input type="password" id="passwordInput" placeholder="Contraseña" class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        <button id="loginBtn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-200">Entrar</button>
        <p id="loginMessage" class="mt-4 text-red-500 text-sm"></p>
    </div>

    <!-- Workshop Selection View -->
    <div id="workshopSelectionView" class="container hidden">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Seleccione el Taller</h2>
        <div class="workshop-grid">
            <div class="workshop-card" data-workshop="kael">
                <!-- Usamos URLs de imágenes públicas para los logos de los talleres -->
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/KAEL_Logo.png/640px-KAEL_Logo.png" alt="KAEL Logo">
                <span class="font-semibold text-gray-700">KAEL</span>
            </div>
            <div class="workshop-card" data-workshop="abfren">
                <img src="https://abfren.com/wp-content/uploads/2021/08/logo-abfren-nuevo-slogan.png" alt="ABFREN Logo">
                <span class="font-semibold text-gray-700">ABFREN</span>
            </div>
            <div class="workshop-card" data-workshop="somec">
                <img src="https://grupocrespo.com.co/wp-content/uploads/2019/08/LOGO-SOMEC-BLANCO.png" alt="SOMEC Logo">
                <span class="font-semibold text-gray-700">SOMEC</span>
            </div>
            <div class="workshop-card" data-workshop="dracso">
                <img src="https://media.licdn.com/dms/image/C4E0BAQHkR6m2y-u_4g/company-logo_200_200/0/1630653697926?e=2147483647&v=beta&t=Ue8f85f-Y9xYV3J_g2VqS3-l2oJ-b4b6Xw2y3C4J7QY" alt="DRACSO Logo">
                <span class="font-semibold text-gray-700">DRACSO</span>
            </div>
            <div class="workshop-card" data-workshop="mecanicos">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTOj04yQeS1w1hDk0Lh-wJ9L7F5w0R6sD6j1Q&s" alt="Mecánicos Logo">
                <span class="font-semibold text-gray-700">Mecánicos</span>
            </div>
            <div class="workshop-card" data-workshop="latoneria">
                <img src="https://www.latoneriaautomotriz.com/wp-content/uploads/2019/08/logo-latoneria-automotriz.png" alt="Latonería Logo">
                <span class="font-semibold text-gray-700">Latonería</span>
            </div>
        </div>
        <button id="logoutBtn" class="w-full bg-red-600 text-white p-3 rounded-lg font-semibold hover:bg-red-700 transition duration-200 mt-6">Cerrar Sesión</button>
    </div>

    <!-- Form View -->
    <div id="formView" class="container hidden">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Reporte para Taller <span id="currentWorkshopName" class="text-blue-600"></span></h2>
        <form id="reportForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label for="equipo" class="block text-left text-sm font-medium text-gray-700">Equipo</label>
                <input type="text" id="equipo" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="fecha" class="block text-left text-sm font-medium text-gray-700">Fecha</label>
                <input type="date" id="fecha" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="otOrigen" class="block text-left text-sm font-medium text-gray-700">OT Origen</label>
                <input type="text" id="otOrigen" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="conjunto" class="block text-left text-sm font-medium text-gray-700">Conjunto</label>
                <select id="conjunto" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Seleccione Conjunto</option>
                    <option value="SISTEMA HIDRAULICO">SISTEMA HIDRAULICO</option>
                    <option value="MOTOR">MOTOR</option>
                    <option value="SISTEMA FRENOS">SISTEMA FRENOS</option>
                    <option value="ESTRUCTURA CHASIS">ESTRUCTURA CHASIS</option>
                    <option value="TRANSMISION">TRANSMISION</option>
                    <option value="DIRECCION">DIRECCION</option>
                    <option value="SISTEMA ELECTRICO">SISTEMA ELECTRICO</option>
                    <option value="AIRE ACONDICIONADO">AIRE ACONDICIONADO</option>
                    <option value="COMPONENTE DE DESGASTE">COMPONENTE DE DESGASTE</option>
                    <option value="OTROS">OTROS</option>
                </select>
            </div>
            <div>
                <label for="parte" class="block text-left text-sm font-medium text-gray-700">Parte</label>
                <select id="parte" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" disabled>
                    <option value="">Seleccione Parte</option>
                </select>
            </div>
            <div>
                <label for="textoEstandar" class="block text-left text-sm font-medium text-gray-700">Texto Estandar</label>
                <select id="textoEstandar" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" disabled>
                    <option value="">Seleccione Texto Estandar</option>
                </select>
            </div>
            <div class="md:col-span-2">
                <label for="descripcionDetallada" class="block text-left text-sm font-medium text-gray-700">Descripción Detallada</label>
                <textarea id="descripcionDetallada" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
            <div>
                <label for="prioridad" class="block text-left text-sm font-medium text-gray-700">Prioridad</label>
                <select id="prioridad" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="Alta">Alta</option>
                    <option value="Media">Media</option>
                    <option value="Baja">Baja</option>
                </select>
            </div>
            <div>
                <label for="tecnico" class="block text-left text-sm font-medium text-gray-700">Técnico</label>
                <input type="text" id="tecnico" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="telefono" class="block text-left text-sm font-medium text-gray-700">Teléfono</label>
                <input type="tel" id="telefono" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="foto" class="block text-left text-sm font-medium text-gray-700">Añadir Foto</label>
                <input type="file" id="foto" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <p class="mt-1 text-xs text-gray-500">La foto se subirá a Supabase Storage.</p>
            </div>

            <div class="md:col-span-2 flex justify-between mt-6">
                <button type="submit" class="bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-200 w-full md:w-auto flex-grow mr-2">Guardar Reporte</button>
                <button type="button" id="viewReportsBtn" class="bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 w-full md:w-auto flex-grow ml-2">Ver Reportes</button>
            </div>
            <button type="button" id="backToWorkshopsBtnFromForm" class="w-full bg-gray-500 text-white p-3 rounded-lg font-semibold hover:bg-gray-600 transition duration-200 mt-4">Volver a Talleres</button>
        </form>
    </div>

    <!-- Reports Table View -->
    <div id="reportsView" class="container hidden">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Reportes de Taller <span id="reportsWorkshopName" class="text-blue-600"></span></h2>
        <div class="table-container overflow-x-auto mb-4 border border-gray-200 rounded-lg">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Equipo</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">OT Origen</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conjunto</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parte</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Texto Estandar</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prioridad</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Técnico</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teléfono</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Foto</th>
                    </tr>
                </thead>
                <tbody id="reportsTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Report rows will be inserted here -->
                </tbody>
            </table>
        </div>
        <div class="flex justify-between mt-4">
            <button id="downloadExcelBtn" class="bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-200 flex-grow mr-2">Descargar Excel</button>
            <button id="backToMenuBtn" class="bg-gray-500 text-white p-3 rounded-lg font-semibold hover:bg-gray-600 transition duration-200 flex-grow ml-2">Volver al Menú Principal</button>
        </div>
    </div>

    <!-- Script para XLSX (exportar a Excel) y la lógica principal de la aplicación -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script>
        // --- INICIALIZACIÓN DE SUPABASE (CON TUS CLAVES REALES) ---
        // URL de tu proyecto Supabase.
        const SUPABASE_URL = 'https://cyvxxmjmkiktwizgpzqj.supabase.co';
        // Clave 'anon' public de tu proyecto Supabase.
        // ¡IMPORTANTE! Si sigues recibiendo "Invalid API key", por favor,
        // ve a tu panel de Supabase (Project Settings > API) y genera una NUEVA clave 'anon' pública,
        // luego reemplázala aquí. Asegúrate de copiarla EXACTAMENTE.
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5dnh4bWpta2lrdHdpZ3BwcnFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0MDg4ODcsImV4cCI6MjA2ODk4NDg4N30.5k9rwN4-FVJEHFE6xWvn5J3j3iUvwcF9kZjAQXEjACg';

        // Crea una instancia del cliente Supabase para interactuar con tu proyecto.
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        // --- FIN DE LA INICIALIZACIÓN DE SUPABASE ---


        // --- Referencias a elementos del DOM (la interfaz de usuario) ---
        const loginView = document.getElementById('loginView');
        const usernameInput = document.getElementById('usernameInput'); // Ahora es para el email
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const loginMessage = document.getElementById('loginMessage');
        const logoutBtn = document.getElementById('logoutBtn');

        const workshopSelectionView = document.getElementById('workshopSelectionView');
        const workshopCards = document.querySelectorAll('.workshop-card');

        const formView = document.getElementById('formView');
        const currentWorkshopName = document.getElementById('currentWorkshopName');
        const reportForm = document.getElementById('reportForm');
        const equipoInput = document.getElementById('equipo');
        const fechaInput = document.getElementById('fecha');
        const otOrigenInput = document.getElementById('otOrigen');
        const conjuntoSelect = document.getElementById('conjunto');
        const parteSelect = document.getElementById('parte');
        const textoEstandarSelect = document.getElementById('textoEstandar');
        const descripcionDetalladaInput = document.getElementById('descripcionDetallada');
        const prioridadSelect = document.getElementById('prioridad');
        const tecnicoInput = document.getElementById('tecnico');
        const telefonoInput = document.getElementById('telefono');
        const fotoInput = document.getElementById('foto');
        const viewReportsBtn = document.getElementById('viewReportsBtn');
        const backToWorkshopsBtnFromForm = document.getElementById('backToWorkshopsBtnFromForm');

        const reportsView = document.getElementById('reportsView');
        const reportsWorkshopName = document.getElementById('reportsWorkshopName');
        const reportsTableBody = document.getElementById('reportsTableBody');
        const downloadExcelBtn = document.getElementById('downloadExcelBtn');
        const backToMenuBtn = document.getElementById('backToMenuBtn');

        // --- Variables Globales y Datos de la Aplicación ---
        let currentWorkshop = ''; // Guarda la clave del taller seleccionado (ej., 'kael')
        const workshopDisplayNames = { // Mapa para mostrar nombres completos de talleres
            'kael': 'KAEL',
            'abfren': 'ABFREN',
            'somec': 'SOMEC',
            'dracso': 'DRACSO',
            'mecanicos': 'Mecánicos',
            'latoneria': 'Latonería'
        };

        // Datos para los desplegables dinámicos (Conjunto -> Parte -> Texto Estandar)
        const conjuntoToParteMap = {
            "SISTEMA HIDRAULICO": ["BOMBA HIDRAULICA", "CILINDRO HIDRAULICO", "VALVULA HIDRAULICA", "MANGUERA HIDRAULICA", "FILTRO HIDRAULICO"],
            "MOTOR": ["CULATA", "BLOQUE", "CIGUEÑAL", "BIELA", "PISTON", "VALVULA DE ADMISION", "VALVULA DE ESCAPE", "ARBOL DE LEVAS", "CARTER", "BOMBA DE ACEITE", "INYECTOR", "TURBOCARGADOR", "RADIADOR"],
            "SISTEMA FRENOS": ["DISCO DE FRENO", "PASTILLA DE FRENO", "CALIPER", "TAMBOR DE FRENO", "BOMBA DE FRENO", "BOOSTER DE FRENO", "LIQUIDO DE FRENOS", "MANGUERA DE FRENO"],
            "ESTRUCTURA CHASIS": ["CHASIS", "CARROCERIA", "EJE", "SUSPENSION", "AMORTIGUADOR", "RESORTE", "BARRA ESTABILIZADORA"],
            "TRANSMISION": ["CAJA DE CAMBIOS", "EMBRAGUE", "CONVERTIDOR DE PAR", "ARBOL DE TRANSMISION", "DIFERENCIAL", "PALIER"],
            "DIRECCION": ["VOLANTE", "CAJA DE DIRECCION", "BARRA DE DIRECCION", "ROTULA", "BOMBA DE DIRECCION ASISTIDA"],
            "SISTEMA ELECTRICO": ["BATERIA", "ALTERNADOR", "MOTOR DE ARRANQUE", "CABLEADO", "FUSIBLE", "RELE", "SENSOR", "UNIDAD DE CONTROL ELECTRONICO (ECU)"],
            "AIRE ACONDICIONADO": ["COMPRESOR DE A/A", "CONDENSADOR DE A/A", "EVAPORADOR DE A/A", "FILTRO SECADOR", "VENTILADOR DE A/A"],
            "COMPONENTE DE DESGASTE": ["LLANTA", "RODAMIENTO", "RETEN", "CORREA", "FILTRO DE AIRE", "FILTRO DE COMBUSTIBLE", "BUJIA"],
            "OTROS": ["ESPEJO RETROVISOR", "CRISTAL", "ASIENTO", "CINTURON DE SEGURIDAD", "FARO", "PILOTO"]
        };

        const parteToTextoEstandarMap = {
            "BOMBA HIDRAULICA": ["REPARACION BOMBA HIDRAULICA", "SUSTITUCION BOMBA HIDRAULICA"],
            "CILINDRO HIDRAULICO": ["REPARACION CILINDRO HIDRAULICO", "SUSTITUCION CILINDRO HIDRAULICO", "FUGA CILINDRO HIDRAULICO"],
            "VALVULA HIDRAULICA": ["REVISION VALVULA HIDRAULICA", "SUSTITUCION VALVULA HIDRAULICA"],
            "MANGUERA HIDRAULICA": ["REEMPLAZO MANGUERA HIDRAULICA", "REPARACION FUGA MANGUERA HIDRAULICA"],
            "FILTRO HIDRAULICO": ["CAMBIO FILTRO HIDRAULICO"],
            "CULATA": ["REPARACION CULATA", "RECTIFICACION CULATA", "SUSTITUCION CULATA"],
            "BLOQUE": ["REPARACION BLOQUE", "SUSTITUCION BLOQUE"],
            "CIGUEÑAL": ["REVISION CIGUEÑAL", "REPARACION CIGUEÑAL", "SUSTITUCION CIGUEÑAL"],
            "BIELA": ["INSPECCION BIELA", "REPARACION BIELA", "SUSTITUCION BIELA"],
            "PISTON": ["CAMBIO PISTON", "REVISION PISTON"],
            "VALVULA DE ADMISION": ["REGLAJE VALVULA ADMISION", "SUSTITUCION VALVULA ADMISION"],
            "VALVULA DE ESCAPE": ["REGLAJE VALVULA ESCAPE", "SUSTITUCION VALVULA ESCAPE"],
            "ARBOL DE LEVAS": ["REEMPLAZO ARBOL DE LEVAS"],
            "CARTER": ["REPARACION FUGA CARTER", "SUSTITUCION CARTER"],
            "BOMBA DE ACEITE": ["CAMBIO BOMBA ACEITE", "REVISION BOMBA ACEITE"],
            "INYECTOR": ["LIMPIEZA INYECTOR", "SUSTITUCION INYECTOR", "AJUSTE INYECTOR"],
            "TURBOCARGADOR": ["REPARACION TURBOCARGADOR", "SUSTITUCION TURBOCARGADOR"],
            "RADIADOR": ["REPARACION FUGA RADIADOR", "SUSTITUCION RADIADOR", "LIMPIEZA RADIADOR"],
            "DISCO DE FRENO": ["CAMBIO DISCO FRENO", "RECTIFICACION DISCO FRENO"],
            "PASTILLA DE FRENO": ["CAMBIO PASTILLAS FRENO"],
            "CALIPER": ["REPARACION CALIPER", "SUSTITUCION CALIPER"],
            "TAMBOR DE FRENO": ["REVISION TAMBOR FRENO", "SUSTITUCION TAMBOR FRENO"],
            "BOMBA DE FRENO": ["CAMBIO BOMBA FRENO", "REPARACION BOMBA FRENO"],
            "BOOSTER DE FRENO": ["REVISION BOOSTER FRENO", "SUSTITUCION BOOSTER FRENO"],
            "LIQUIDO DE FRENOS": ["CAMBIO LIQUIDO FRENOS"],
            "MANGUERA DE FRENO": ["REEMPLAZO MANGUERA FRENO"],
            "CHASIS": ["INSPECCION CHASIS", "REPARACION CHASIS"],
            "CARROCERIA": ["REPARACION GOLPE CARROCERIA", "PINTURA CARROCERIA"],
            "EJE": ["ALINEACION EJE", "SUSTITUCION EJE"],
            "SUSPENSION": ["REPARACION SUSPENSION", "REVISION SUSPENSION"],
            "AMORTIGUADOR": ["CAMBIO AMORTIGUADOR"],
            "RESORTE": ["CAMBIO RESORTE"],
            "BARRA ESTABILIZADORA": ["REVISION BARRA ESTABILIZADORA", "SUSTITUCION BARRA ESTABILIZADORA"],
            "CAJA DE CAMBIOS": ["REPARACION CAJA CAMBIOS", "REVISION CAJA CAMBIOS", "CAMBIO ACEITE CAJA CAMBIOS"],
            "EMBRAGUE": ["CAMBIO EMBRAGUE", "AJUSTE EMBRAGUE"],
            "CONVERTIDOR DE PAR": ["REVISION CONVERTIDOR PAR", "SUSTITUCION CONVERTIDOR PAR"],
            "ARBOL DE TRANSMISION": ["REPARACION ARBOL TRANSMISION", "SUSTITUCION ARBOL TRANSMISION"],
            "DIFERENCIAL": ["REPARACION DIFERENCIAL", "CAMBIO ACEITE DIFERENCIAL"],
            "PALIER": ["CAMBIO PALIER", "REPARACION PALIER"],
            "VOLANTE": ["REVISION VOLANTE", "REPARACION VOLANTE"],
            "CAJA DE DIRECCION": ["REPARACION CAJA DIRECCION", "SUSTITUCION CAJA DIRECCION"],
            "BARRA DE DIRECCION": ["REEMPLAZO BARRA DIRECCION"],
            "ROTULA": ["CAMBIO ROTULA"],
            "BOMBA DE DIRECCION ASISTIDA": ["REPARACION BOMBA DIRECCION ASISTIDA", "SUSTITUCION BOMBA DIRECCION ASISTIDA"],
            "BATERIA": ["COMPROBACION BATERIA", "CAMBIO BATERIA"],
            "ALTERNADOR": ["REPARACION ALTERNADOR", "SUSTITUCION ALTERNADOR"],
            "MOTOR DE ARRANQUE": ["REPARACION MOTOR ARRANQUE", "SUSTITUCION MOTOR ARRANQUE"],
            "CABLEADO": ["REPARACION CABLEADO", "REEMPLAZO CABLEADO"],
            "FUSIBLE": ["CAMBIO FUSIBLE"],
            "RELE": ["CAMBIO RELE"],
            "SENSOR": ["COMPROBACION SENSOR", "CAMBIO SENSOR"],
            "UNIDAD DE CONTROL ELECTRONICO (ECU)": ["DIAGNOSTICO ECU", "REPROGRAMACION ECU", "SUSTITUCION ECU"],
            "COMPRESOR DE A/A": ["REPARACION COMPRESOR A/A", "SUSTITUCION COMPRESOR A/A"],
            "CONDENSADOR DE A/A": ["LIMPIEZA CONDENSADOR A/A", "SUSTITUCION CONDENSADOR A/A"],
            "EVAPORADOR DE A/A": ["LIMPIEZA EVAPORADOR A/A", "SUSTITUCION EVAPORADOR A/A"],
            "FILTRO SECADOR": ["CAMBIO FILTRO SECADOR A/A"],
            "VENTILADOR DE A/A": ["REPARACION VENTILADOR A/A", "SUSTITUCION VENTILADOR A/A"],
            "LLANTA": ["CAMBIO LLANTA", "REPARACION PINCHAZO LLANTA", "ROTACION LLANTAS"],
            "RODAMIENTO": ["CAMBIO RODAMIENTO"],
            "RETEN": ["CAMBIO RETEN"],
            "CORREA": ["CAMBIO CORREA", "AJUSTE CORREA"],
            "FILTRO DE AIRE": ["CAMBIO FILTRO AIRE"],
            "FILTRO DE COMBUSTIBLE": ["CAMBIO FILTRO COMBUSTIBLE"],
            "BUJIA": ["CAMBIO BUJIA"],
            "ESPEJO RETROVISOR": ["SUSTITUCION ESPEJO RETROVISOR"],
            "CRISTAL": ["REEMPLAZO CRISTAL"],
            "ASIENTO": ["REPARACION ASIENTO", "SUSTITUCION ASIENTO"],
            "CINTURON DE SEGURIDAD": ["REVISION CINTURON SEGURIDAD", "SUSTITUCION CINTURON SEGURIDAD"],
            "FARO": ["REEMPLAZO FARO", "AJUSTE FARO"],
            "PILOTO": ["REEMPLAZO PILOTO"]
        };


        // --- Funciones para mostrar/ocultar vistas ---
        // Estas funciones se definen primero para que estén disponibles cuando se las llame.
        function showView(viewId) {
            const views = [loginView, workshopSelectionView, formView, reportsView];
            views.forEach(view => {
                if (view.id === viewId) {
                    view.classList.remove('hidden');
                } else {
                    view.classList.add('hidden');
                }
            });
        }

        function showLoginView() {
            showView('loginView');
            loginMessage.textContent = ''; // Limpia mensajes anteriores
        }

        function showWorkshopSelectionView() {
            showView('workshopSelectionView');
        }

        function showFormView(workshopKey) {
            currentWorkshop = workshopKey;
            currentWorkshopName.textContent = workshopDisplayNames[currentWorkshop];
            showView('formView');
            reportForm.reset(); // Limpia el formulario
            // Resetea y deshabilita los desplegables dependientes
            parteSelect.innerHTML = '<option value="">Seleccione Parte</option>';
            parteSelect.disabled = true;
            textoEstandarSelect.innerHTML = '<option value="">Seleccione Texto Estandar</option>';
            textoEstandarSelect.disabled = true;

            // Establece la fecha actual como valor por defecto para el input de fecha
            fechaInput.valueAsDate = new Date();
        }

        async function showReportsView(workshopKey) {
            currentWorkshop = workshopKey;
            reportsWorkshopName.textContent = workshopDisplayNames[currentWorkshop];
            showView('reportsView');
            await displayReports(); // Llama a la función para mostrar los reportes
        }


        // --- Manejo del Login con Supabase Auth ---
        // Función para verificar si hay una sesión de usuario activa al cargar la página
        async function checkUserSession() {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                // Si hay un usuario logueado, ir a la selección de taller
                showWorkshopSelectionView();
            } else {
                // Si no hay usuario, mostrar el login
                showLoginView();
            }
        }

        // Evento para el botón de login
        loginBtn.addEventListener('click', async () => {
            const email = usernameInput.value; // Supabase Auth usa email para iniciar sesión
            const password = passwordInput.value;

            // Llama a la función de inicio de sesión de Supabase
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password,
            });

            if (error) {
                loginMessage.textContent = `Error al iniciar sesión: ${error.message}`;
                console.error('Error de login:', error.message);
            } else if (data.user) {
                loginMessage.textContent = 'Inicio de sesión exitoso.';
                console.log('Usuario logueado:', data.user);
                showWorkshopSelectionView();
            } else {
                // Esto podría ocurrir si las credenciales son incorrectas pero Supabase no devuelve un error específico.
                loginMessage.textContent = 'Usuario o contraseña incorrectos.';
            }
        });

        // --- Manejo del Logout con Supabase Auth ---
        logoutBtn.addEventListener('click', async () => {
            // Llama a la función de cierre de sesión de Supabase
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Error al cerrar sesión:', error.message);
            } else {
                showLoginView();
                alert('Sesión cerrada correctamente.');
            }
        });

        // --- Manejo de la selección de Taller ---
        workshopCards.forEach(card => {
            card.addEventListener('click', () => {
                // Quita la clase 'selected' de todas las tarjetas
                workshopCards.forEach(c => c.classList.remove('selected'));
                // Añade la clase 'selected' a la tarjeta clickeada
                card.classList.add('selected');

                const workshopKey = card.dataset.workshop;
                showFormView(workshopKey);
            });
        });

        // --- Lógica de los Dropdowns Dependientes ---
        conjuntoSelect.addEventListener('change', () => {
            const selectedConjunto = conjuntoSelect.value;
            // Limpia y deshabilita los desplegables dependientes
            parteSelect.innerHTML = '<option value="">Seleccione Parte</option>';
            textoEstandarSelect.innerHTML = '<option value="">Seleccione Texto Estandar</option>';
            textoEstandarSelect.disabled = true;

            if (selectedConjunto && conjuntoToParteMap[selectedConjunto]) {
                // Rellena el desplegable de Parte basado en el Conjunto seleccionado
                conjuntoToParteMap[selectedConjunto].forEach(parte => {
                    const option = document.createElement('option');
                    option.value = parte;
                    option.textContent = parte;
                    parteSelect.appendChild(option);
                });
                parteSelect.disabled = false;
            } else {
                parteSelect.disabled = true;
            }
        });

        parteSelect.addEventListener('change', () => {
            const selectedParte = parteSelect.value;
            // Limpia el desplegable de Texto Estandar
            textoEstandarSelect.innerHTML = '<option value="">Seleccione Texto Estandar</option>';

            if (selectedParte && parteToTextoEstandarMap[selectedParte]) {
                // Rellena el desplegable de Texto Estandar basado en la Parte seleccionada
                parteToTextoEstandarMap[selectedParte].forEach(texto => {
                    const option = document.createElement('option');
                    option.value = texto;
                    option.textContent = texto;
                    textoEstandarSelect.appendChild(option);
                });
                textoEstandarSelect.disabled = false;
            } else {
                textoEstandarSelect.disabled = true;
            }
        });


        // --- Manejo del Formulario (Guardar en Supabase Database y Storage) ---
        reportForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validación básica de campos obligatorios
            if (!equipoInput.value || !fechaInput.value || !otOrigenInput.value || !descripcionDetalladaInput.value) {
                alert('Por favor, complete al menos los campos obligatorios: Equipo, Fecha, OT Origen y Descripción Detallada.');
                return;
            }

            let fotoName = null;
            let fotoURL = null;

            // Si se seleccionó un archivo de foto
            if (fotoInput.files.length > 0) {
                const fotoFile = fotoInput.files[0];
                const fileExtension = fotoFile.name.split('.').pop();
                // Genera un nombre único para la foto usando la fecha y un número aleatorio
                fotoName = `${Date.now()}_${Math.random().toString(36).substring(2, 15)}.${fileExtension}`;
                // Define la ruta donde se guardará en Supabase Storage (ej. 'kael/nombre_foto.jpg')
                const filePath = `${currentWorkshop}/${fotoName}`;

                // Sube la foto al bucket 'fotos_reportes' en Supabase Storage
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('fotos_reportes') // Nombre del bucket que creaste
                    .upload(filePath, fotoFile, {
                        cacheControl: '3600', // Control de caché para la foto
                        upsert: false // No sobrescribir si ya existe
                    });

                if (uploadError) {
                    console.error('Error al subir la foto:', uploadError.message);
                    alert(`Error al subir la foto: ${uploadError.message}. El reporte se guardará sin foto.`);
                } else {
                    console.log('Foto subida con éxito:', uploadData.path);
                    // Obtiene la URL pública de la foto subida
                    const { data: publicURLData } = supabase.storage
                        .from('fotos_reportes')
                        .getPublicUrl(filePath);
                    fotoURL = publicURLData.publicUrl;
                }
            }

            // Prepara los datos del reporte para insertar en la base de datos
            // Usamos snake_case (ej. ot_origen) para los nombres de las columnas en la base de datos
            const newReport = {
                taller: currentWorkshop, // El taller al que pertenece el reporte
                equipo: equipoInput.value,
                fecha: fechaInput.value,
                ot_origen: otOrigenInput.value,
                conjunto: conjuntoSelect.value,
                parte: parteSelect.value,
                texto_estandar: textoEstandarSelect.value,
                descripcion_detallada: descripcionDetalladaInput.value,
                prioridad: prioridadSelect.value,
                tecnico: tecnicoInput.value,
                telefono: telefonoInput.value,
                foto_nombre: fotoName,
                foto_url: fotoURL
            };

            // Inserta el nuevo reporte en la tabla 'reportes' de Supabase
            const { error: dbError } = await supabase
                .from('reportes') // Nombre de la tabla que creaste
                .insert([newReport]);

            if (dbError) {
                console.error('Error al guardar el reporte en la base de datos:', dbError.message);
                alert(`Error al guardar el reporte: ${dbError.message}`);
            } else {
                alert('Reporte guardado con éxito en Supabase.');
                reportForm.reset(); // Limpia el formulario
                fechaInput.valueAsDate = new Date(); // Restablece la fecha al día actual
                // Deshabilita y limpia los selects dependientes
                parteSelect.innerHTML = '<option value="">Seleccione Parte</option>';
                parteSelect.disabled = true;
                textoEstandarSelect.innerHTML = '<option value="">Seleccione Texto Estandar</option>';
                textoEstandarSelect.disabled = true;
            }
        });

        // --- Ver Reportes (Cargar desde Supabase Database) ---
        viewReportsBtn.addEventListener('click', () => {
            showReportsView(currentWorkshop);
        });

        async function displayReports() {
            reportsTableBody.innerHTML = '<tr><td colspan="11" class="px-6 py-4 text-center text-gray-500">Cargando reportes...</td></tr>';

            // Consulta los reportes de Supabase para el taller actual
            const { data: reports, error } = await supabase
                .from('reportes')
                .select('*') // Selecciona todas las columnas
                .eq('taller', currentWorkshop) // Filtra por el taller actualmente seleccionado
                .order('created_at', { ascending: false }); // Ordena por la fecha de creación (más recientes primero)

            if (error) {
                console.error('Error al cargar reportes:', error.message);
                reportsTableBody.innerHTML = `<tr><td colspan="11" class="px-6 py-4 text-center text-red-500">Error al cargar reportes: ${error.message}</td></tr>`;
                return;
            }

            reportsTableBody.innerHTML = ''; // Limpia las filas existentes
            if (reports.length === 0) {
                reportsTableBody.innerHTML = '<tr><td colspan="11" class="px-6 py-4 text-center text-gray-500">No hay reportes para este taller.</td></tr>';
                return;
            }

            // Muestra cada reporte en la tabla
            reports.forEach(report => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-100');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${report.equipo || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${report.fecha || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${report.ot_origen || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${report.conjunto || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${report.parte || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${report.texto_estandar || ''}</td>
                    <td class="px-6 py-4 text-sm text-gray-500 max-w-xs overflow-hidden text-ellipsis">${report.descripcion_detallada || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${report.prioridad || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${report.tecnico || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${report.telefono || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">
                        ${report.foto_url ? `<a href="${report.foto_url}" target="_blank" class="hover:underline">Ver Foto</a>` : 'N/A'}
                    </td>
                `;
                reportsTableBody.appendChild(row);
            });
        }

        // --- Descargar Excel (Ahora lee de Supabase Database) ---
        downloadExcelBtn.addEventListener('click', async () => {
            // Obtiene todos los reportes del taller actual desde Supabase
            const { data: allData, error } = await supabase
                .from('reportes')
                .select('*')
                .eq('taller', currentWorkshop) // Filtra por el taller actual
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error al obtener datos para Excel:', error.message);
                alert(`Error al obtener datos para Excel: ${error.message}`);
                return;
            }

            if (allData.length === 0) {
                alert('No hay datos para exportar.');
                return;
            }

            const dataToExport = [];
            const headers = [
                "Taller", "Equipo", "Fecha", "OT Origen", "Conjunto", "Parte", "Texto Estandar",
                "Descripción Detallada", "Prioridad",
                "Técnico", "Teléfono", "Foto (URL)" // Cambiado a Foto (URL) para reflejar la URL de Supabase
            ];
            dataToExport.push(headers);

            // Prepara los datos para la exportación a Excel
            allData.forEach(item => {
                const rowData = [
                    workshopDisplayNames[item.taller] || '', // Usa el nombre legible del taller
                    item.equipo || '',
                    item.fecha || '',
                    item.ot_origen || '',
                    item.conjunto || '',
                    item.parte || '',
                    item.texto_estandar || '',
                    item.descripcion_detallada || '',
                    item.prioridad || '',
                    item.tecnico || '',
                    item.telefono || '',
                    item.foto_url || 'N/A' // Exporta la URL de la foto
                ];
                dataToExport.push(rowData);
            });

            // Crea y descarga el archivo Excel
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(dataToExport);

            XLSX.utils.book_append_sheet(wb, ws, `Records ${workshopDisplayNames[currentWorkshop]}`);

            XLSX.writeFile(wb, `Records_${workshopDisplayNames[currentWorkshop]}.xlsx`);
            console.log('Excel descargado con éxito.');
        });

        // --- Botón Volver al Menú desde la Tabla de Reportes ---
        backToMenuBtn.addEventListener('click', () => {
            showWorkshopSelectionView();
        });

        // --- Botón Volver a Talleres desde el Formulario ---
        backToWorkshopsBtnFromForm.addEventListener('click', () => {
            showWorkshopSelectionView();
        });

        // --- Configuración Inicial al cargar la página ---
        document.addEventListener('DOMContentLoaded', () => {
            checkUserSession(); // Verifica si hay una sesión activa al cargar la página
        });
    </script>
